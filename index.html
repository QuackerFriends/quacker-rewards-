<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quacker Shop</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Fredoka', sans-serif;
    text-align: center;
    background-color: #fff8f0;
    padding: 20px;
  }
  button {
    font-family: 'Fredoka', sans-serif;
    font-size: 16px;
    padding: 10px 20px;
    margin: 10px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background-color: #ffcf70;
  }
  button:hover {
    background-color: #ffb347;
  }
  #userProfileModal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0; top: 0;
    width: 100%; height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
  }
  #userProfileContent {
    background-color: #fff8f0;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 400px;
    border-radius: 12px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.2.umd.min.js"></script>
</head>
<body>

<h1>ðŸ¦† Quacker Shop</h1>
<button id="connectWalletBtn">Connect Wallet</button>
<button id="userProfileBtn" style="display:none;">User Profile</button>

<div id="userProfileModal">
  <div id="userProfileContent">
    <span id="closeProfile" style="float:right; cursor:pointer;">&times;</span>
    <h2>User Profile</h2>
    <p id="nftCountText"></p>
    <div id="keychainSection" style="display:none;">
      <p>Quacker Friends Keychain Claim</p>
      <div id="claimStatus"></div>
      <div id="claimForm" style="display:none;">
        <input type="text" id="shippingAddress" placeholder="Enter shipping address">
        <button id="submitClaimBtn">Submit Claim</button>
      </div>
    </div>
  </div>
</div>

<script>
const contractAddress = "0xA2c82Bda5585c1D729E2b4f85dCC9a11ded7DB4c";
const contractABI = [
  "function balanceOf(address owner) view returns (uint256)"
];
let provider, signer, userAddress;
let hasClaimedKeychain = false;
let nftCount = 0;

const connectWalletBtn = document.getElementById('connectWalletBtn');
const userProfileBtn = document.getElementById('userProfileBtn');
const userProfileModal = document.getElementById('userProfileModal');
const closeProfile = document.getElementById('closeProfile');
const nftCountText = document.getElementById('nftCountText');
const keychainSection = document.getElementById('keychainSection');
const claimStatus = document.getElementById('claimStatus');
const claimForm = document.getElementById('claimForm');
const submitClaimBtn = document.getElementById('submitClaimBtn');

connectWalletBtn.addEventListener('click', async () => {
  if (typeof window.ethereum !== 'undefined') {
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    await checkNFTBalance();
    userProfileBtn.style.display = "inline-block"; // Always show for everyone
  } else {
    alert("Please install MetaMask");
  }
});

userProfileBtn.addEventListener('click', () => {
  nftCountText.textContent = `NFTs Owned: ${nftCount}`;
  if (nftCount > 0) {
    keychainSection.style.display = "block";
    if (hasClaimedKeychain) {
      claimStatus.textContent = "âœ… Keychain Claimed";
      claimForm.style.display = "none";
    } else {
      claimStatus.textContent = "";
      claimForm.style.display = "block";
    }
  } else {
    keychainSection.style.display = "none";
  }
  userProfileModal.style.display = "block";
});

closeProfile.addEventListener('click', () => {
  userProfileModal.style.display = "none";
});

async function checkNFTBalance() {
  const contract = new ethers.Contract(contractAddress, contractABI, provider);
  nftCount = (await contract.balanceOf(userAddress)).toNumber();
  await checkClaimStatus();
}

async function checkClaimStatus() {
  try {
    const response = await fetch("YOUR_APPSCRIPT_URL?address=" + userAddress);
    const data = await response.json();
    hasClaimedKeychain = data.claimed || false;
  } catch (error) {
    console.error("Error checking claim status:", error);
  }
}

submitClaimBtn.addEventListener('click', async () => {
  if (nftCount < 1) {
    alert("You must own at least 1 Quacker Friend to claim.");
    return;
  }
  if (hasClaimedKeychain) {
    alert("You have already claimed your keychain.");
    return;
  }
  const shippingAddress = document.getElementById('shippingAddress').value.trim();
  if (!shippingAddress) {
    alert("Please enter a shipping address.");
    return;
  }
  try {
    await fetch("YOUR_APPSCRIPT_URL", {
      method: "POST",
      body: JSON.stringify({ address: userAddress, shipping: shippingAddress }),
      headers: { "Content-Type": "application/json" }
    });
    alert("Claim submitted!");
    hasClaimedKeychain = true;
    claimStatus.textContent = "âœ… Keychain Claimed";
    claimForm.style.display = "none";
  } catch (error) {
    console.error("Error submitting claim:", error);
  }
});
</script>

</body>
</html>
