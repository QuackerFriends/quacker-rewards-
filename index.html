<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quacker Friends Shop</title>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <style>
    :root{
      --brand-orange:#ff914d;
      --brand-orange-dark:#ff7b2c;
      --brand-teal:#66c7c4;
      --card:#ffffff;

      --shadow:0 8px 20px rgba(12,12,20,0.06);
      --radius:14px;
      --maxWidth:1100px;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Poppins',sans-serif;
      margin:0;padding:0;color:#222;min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;position:relative;
    }
    body::before{
      content:"";position:fixed;inset:0;background:url('https://quackerfriends.github.io/quackheads-assets/images/witches%20with%20pumpkins.png') no-repeat center center fixed;background-size:cover;z-index:-1;transition:filter .4s;pointer-events:none;
    }
    body.blur-bg::before{filter:blur(6px) brightness(.7);}

    header{display:flex;justify-content:space-between;align-items:center;padding:14px 24px;background:var(--brand-orange);color:white;box-shadow:0 6px 18px rgba(0,0,0,0.08);z-index:1500;position:relative}
    header h1{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
    .btn{padding:10px 16px;background:var(--brand-orange-dark);color:white;border:none;border-radius:999px;cursor:pointer;font-weight:600;transition:all .18s;display:inline-flex;gap:8px;align-items:center}
    .btn.secondary{background:transparent;color:white;border:1px solid rgba(255,255,255,.25);padding:8px 12px;border-radius:10px}
    main{flex:1;padding:30px 20px;max-width:var(--maxWidth);margin:0 auto 80px}
    .shop-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:22px}
    .item{background:var(--card);padding:16px;border-radius:14px;box-shadow:var(--shadow);text-align:center;position:relative}
    .item img{width:100%;height:220px;object-fit:contain;border-radius:8px;background:#f6f6f6}
    
   /* --- Cursor-follow zoom (magnifier style) --- */
.item {
  position: relative;
  overflow: hidden;
}

.item img {
  width: 100%;
  transition: transform 0.3s ease;
  cursor: crosshair;
  transform-origin: center center;
}

/* Optional: smooth reset when leaving */
.item:hover img {
  transform: scale(1.5); /* base zoom level */
}


    .item h3{margin:10px 0 6px;font-size:16px}
    .price{font-weight:700;color:var(--brand-orange-dark);margin-bottom:8px}
    select{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px}

    /* carousel */
    .carousel { position: relative; overflow: hidden; border-radius: 12px; background:#f6f6f6; }
    .carousel img { width:100%; height:220px; object-fit:contain; display:none; transition:opacity .25s ease; }
    .carousel img.active { display:block; }
    .carousel button { position:absolute; top:50%; transform:translateY(-50%); background:rgba(255,255,255,0.85); border:none; border-radius:999px; width:34px; height:34px; cursor:pointer; font-size:18px; color:#333; display:flex; align-items:center; justify-content:center; }
    .carousel .prev-btn{ left:8px } .carousel .next-btn{ right:8px }
    .carousel button:hover{ background:var(--brand-orange); color:#fff }

    /* --- GLOBAL Z-INDEX & CLICK FIX --- */

/* Overlay must never block anything unless active */
#modalOverlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1800;
  pointer-events: none !important;
}

#modalOverlay.active {
  display: block;
  pointer-events: auto !important;
}

/* Header & navigation always clickable */
header, .nav-container, .nav-actions, .nav-actions button {
  position: relative;
  z-index: 3000;
  pointer-events: auto !important;
}

/* Profile dropdown just below header */
#profileSection {
  position: fixed;
  top: 72px;               /* sits just below the header */
  right: 20px;
  z-index: 3100;
  background: #1c1c1c;
  color: #eee;
  padding: 1rem;
  border-radius: 1rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  min-width: 180px;
}

/* Buttons in profile dropdown visible */
#profileSection button {
  width: 100%;
  background: #2a2a2a;
  color: #eee;
  border: none;
  padding: 0.6rem 0.8rem;
  border-radius: 0.6rem;
  cursor: pointer;
  margin-top: 6px;
  transition: background 0.2s, color 0.2s;
}
#profileSection button:hover {
  background: #ff6600;
  color: #fff;
}

/* Shop dropdown, modals, and toasts also stay clickable */
#shopMenu,
.cart-modal,
.sizeguide-modal,
#toastContainer {
  pointer-events: auto !important;
}


    .sizeguide-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:3000;background:rgba(0,0,0,0.5)}
    .sizeguide-modal.open{display:flex}
    .sizeguide-modal .card{background:#fff;padding:12px;border-radius:12px;max-width:720px;width:92%;position:relative}
    .sizeguide-modal img{max-width:100%;height:auto;display:block;border-radius:8px}
    .sizeguide-modal .close-btn{position:absolute;right:12px;top:12px;background:transparent;border:none;font-size:20px;cursor:pointer}

    .cart-modal{position:fixed;right:0;top:0;height:100vh;width:420px;background:var(--card);box-shadow:-12px 0 40px rgba(0,0,0,0.12);transform:translateX(110%);transition:transform .28s ease;z-index:z-index: 3000 !important;padding:18px;display:flex;flex-direction:column}
    .cart-modal.open{transform:translateX(0); z-index: 3000 !important;}
    .cart-modal .close-x{position:absolute;right:12px;top:8px;background:transparent;border:none;font-size:20px;cursor:pointer}
    .cart-list{flex:1;overflow:auto;margin-bottom:12px}
    .cart-item{display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid #f1f1f1}
    .cart-item img{width:64px;height:64px;object-fit:contain;border-radius:6px;background:#f6f6f6}

   /* PROFILE DROPDOWN */
#profileSection {
  display: none;
  position: fixed;
  top: 100px; /* moved down a bit below header */
  right: 20px;
  background: #1c1c1c;
  color: #ddd; /* readable text */
  padding: 1rem;
  border-radius: 1rem;
  z-index: 2600;
  min-width: 180px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

#profileSection button {
  width: 100%;
  background: #2a2a2a;
  color: #eee; /* <-- fix text color */
  border: none;
  padding: 0.6rem 0.8rem;
  border-radius: 0.6rem;
  cursor: pointer;
  margin-top: 6px;
  transition: background 0.2s, color 0.2s;
}

#profileSection button:hover {
  background: #ff6600;
  color: #fff;
}

    #toast-container{position:fixed;top:110px;right:12px;z-index:4000;display:flex;flex-direction:column;gap:8px}
    .toast{padding:8px 12px;border-radius:8px;color:#fff;display:flex;gap:8px;align-items:center}
    .toast.info{background:#2563eb}.toast.success{background:#059669}.toast.error{background:#ef4444}

    /* dropdown */
    #shopMenu{display:none;position:absolute;top:100%;left:0;background:var(--card);border-radius:12px;box-shadow:var(--shadow);flex-direction:column;min-width:160px;z-index:2000}
    .dropdown-item{padding:10px 16px;border:none;background:transparent;text-align:left;cursor:pointer;font-weight:600;transition:background .15s;color:#222;border-radius:8px}
    .dropdown-item:hover{background:var(--brand-orange);color:#fff}

    footer{background:var(--brand-teal);padding:10px 0;text-align:center;color:#fff;margin-top:auto;position:relative;z-index:1000}
    footer a{margin:0 10px;color:#fff}

    @media(max-width:520px){#profileSection{right:12px;left:12px;width:auto}.cart-modal{width:100%}}
  </style>
</head>
<body>
  <!-- overlay sits directly under header/above content; pointer-events controlled by .active -->
  <div id="tees"></div>

  <div id="shippingNotice" style="background:#ffcc00;color:#222;text-align:center;padding:8px 0;font-weight:600;font-size:14px;">
    ‚ö†Ô∏è Note: Shipping is only available in the US and Canada.
  </div>

  <header>
    <h1>Quacker Friends Shop</h1>
    <div style="display:flex;gap:10px;align-items:center">
      <div class="shop-controls" style="position:relative">
        <button class="btn secondary" id="menuBtn">Shop ‚ñæ</button>
        <div id="shopMenu">
          <button class="dropdown-item" onclick="showCategory('tees')">Tees</button>
          <button class="dropdown-item" onclick="showCategory('miniplushies')">Mini Plushies</button>
          <button class="dropdown-item" onclick="showCategory('plushies')">Plushies</button>
          <button class="dropdown-item" onclick="showCategory('tapestry')">Tapestry</button>
          <button class="dropdown-item" onclick="showCategory('keychains')">Keychains</button>

        </div>
      </div>
      <div id="pointsDisplay" style="margin-top:10px;font-weight:600;color:#FFD700"> ü™ô Points: - </div>
      <button id="connectBtn" class="btn">Connect Wallet</button>
      <button id="profileBtn" class="btn secondary" style="display:none">Profile</button>
      <button id="openCartBtn" class="btn" style="position:relative">Cart <span id="cartCount" class="cart-count" style="display:none">0</span></button>
    </div>
  </header>

  <div id="toast-container"></div>

  <!-- Profile Panel -->
  <div id="profileSection" aria-hidden="true">
    <h3>User Profile</h3>
    <p id="walletAddr" style="font-size:13px;color:#333">Not connected</p>
    <p id="nftCount">NFTs Owned: ...</p>
    <p id="quacksCount">Daily Quacks: 0</p>
    <div style="margin-top:10px">
      <button id="claimQuacksBtn" class="btn">ü¶Ü Collect Daily Quacks</button>
    </div>
    <hr>
    <button class="btn secondary" onclick="switchWallet()">üîÑ Switch Wallet</button>
    <button class="btn secondary" onclick="disconnectWallet()">‚ùå Disconnect</button>
  </div>

  <main style="max-width:var(--maxWidth);margin:20px auto;padding:0 16px;width:100%">
    <section id="items" class="shop-container"></section>
  </main>

  <!-- Cart Modal -->
  <div id="cartModal" class="cart-modal" aria-hidden="true">
    <button class="close-x" title="Close cart" onclick="closeCart()">‚úï</button>
    <h3>Your Cart</h3>
    <div style="font-size:13px;color:#c0392b;margin-bottom:8px;">Shipping only available in the US and Canada</div>
    <div class="cart-list" id="cartList"></div>

    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Total</strong>
        <strong id="cartTotal">0 ETH</strong>
      </div>
      <div style="margin-top:8px">
        
        <div id="addressSection" style="margin-top:20px;">
  <label for="userAddressInput" style="font-weight:bold;">Shipping Address:</label><br>
  <textarea id="userAddressInput" placeholder="Enter your full shipping address"
    style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;min-height:70px;"></textarea>
</div>

        <div id="referralSection" style="margin-top:16px;">
  <label for="referrerInput" style="font-weight:bold;">Referral Address (optional):</label><br>
  <input
    type="text"
    id="referrerInput"
    placeholder="Enter a friend‚Äôs wallet address"
    style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"
  />
</div>


        <button id="checkoutBtn" class="btn" style="width:100%">Checkout (Pay in Base)</button>
      </div>
      <div style="margin-top:8px;font-size:12px;color:#666;text-align:center">Network: Base Mainnet</div>
    </div>
  </div>
  
 <!-- Size guide modal -->
  <div id="sizeGuideModal" class="sizeguide-modal" aria-hidden="true">
    <div class="card">
      <button class="close-btn" onclick="closeSizeGuide()">‚úï</button>
      <img id="sizeGuideImage" src="" alt="Size guide" />
    </div>
  </div>
  
  <footer>
    <p>Follow Quacker Friends:</p>
    <a href="https://x.com/QuackerFriends" target="_blank"><i class="fab fa-x fa-lg"></i></a>
    <a href="https://www.tiktok.com/@quackerfriends" target="_blank"><i class="fab fa-tiktok fa-lg"></i></a>
    <a href="https://www.instagram.com/QuackerFriends" target="_blank"><i class="fab fa-instagram fa-lg"></i></a>
  </footer>

<script>
/* ===== CONFIG ===== */
const PURCHASE_API = "https://script.google.com/macros/s/AKfycbwZMlGQ2REZxTP1lIoWBYzc8n7l-h7C79F9u9MjDY4XIR6jKNO7ky1VXtCm3oP5RM_9qA/exec";
const CLAIM_SHEET_API = "https://script.google.com/macros/s/AKfycbzu2RjvJf8-SyRIekMh53JODYZxoPXQpjJ2aGTqIHd93HgEZpnXcVC_zxoJbJt51zqSuQ/exec";
const CONTRACT_ADDRESS = "0xa2c82bda5585c1d729e2b4f85dcc9a11ded7db4c";
const CONTRACT_ABI = [{"constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}];
const SHOP_WALLET = "0x38aF7644b120B56e2FEce98b8A9A3DE14F8Fbf1D";
const BASE_CHAIN_ID_HEX = "0x2105"; // 8453

/* ===== PRODUCTS ===== */

async function loadProducts() {
  try {
    const res = await fetch(
      "https://script.google.com/macros/s/AKfycbwZMlGQ2REZxTP1lIoWBYzc8n7l-h7C79F9u9MjDY4XIR6jKNO7ky1VXtCm3oP5RM_9qA/exec?action=getItems"
    );
    const data = await res.json();

    if (data.success) {
      // Normalize keys for consistent use
      const normalized = data.items.map(item => ({
        id: item.ID,
        category: item.Category || "Other",
        title: item.Title,
        description: item.Description,
        priceUSD: Number(item.PriceUSD) || 0,
        pointsCost: Number(item.PointsCost) || null,
        variants: item.VariantOptions ? item.VariantOptions.split(",").map(v => v.trim()) : [],
        colors: item.ColorOptions ? item.ColorOptions.split(",").map(c => c.trim()) : [],
        sizes: item.SizeOptions ? item.SizeOptions.split(",").map(s => s.trim()) : [],
        sizeGuide: item.SizeGuide || "",
        images: item.ImageURL ? [item.ImageURL] : [],
        stockQty: Number(item.StockQty) || 0,
        active: item.Active === true || item.Active === "TRUE"
      }));

      // Group by category
      PRODUCTS = normalized.reduce((acc, item) => {
        if (!acc[item.category]) acc[item.category] = [];
        acc[item.category].push(item);
        return acc;
      }, {});

      console.log("‚úÖ Loaded products:", PRODUCTS);
      renderProducts(); // or showCategory(currentCategory)
    } else {
      console.error("‚ùå Failed to load items:", data);
    }
  } catch (err) {
    console.error("‚ö†Ô∏è Error fetching items:", err);
  }
}


/* ===== STATE ===== */
let userAddress = null;
let web3 = null;
let cart = [];
let cachedEthRate = null;
let lastRateFetch = 0;

/* ===== UI HELPERS ===== */
function showToast(message, type="info", duration=3000){
  const container = document.getElementById("toast-container");
  if(!container) return console.warn("toast container missing");
  const el = document.createElement("div");
  el.className = "toast " + (type==="success"?"success":type==="error"?"error":"info");
  el.innerHTML = `<span>${message}</span>`;
  container.appendChild(el);
  setTimeout(()=>el.remove(), duration);
}

/* ===== PRICE HELPERS ===== */
async function getEthRate(){
  // cache for 60s to avoid spamming
  const now = Date.now();
  if(cachedEthRate && (now - lastRateFetch) < 60000) return cachedEthRate;
  try {
    const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd");
    const data = await res.json();
    cachedEthRate = (data && data.ethereum && data.ethereum.usd) ? data.ethereum.usd : 3000;
  } catch (err) {
    console.warn("CoinGecko fetch failed:", err);
    cachedEthRate = 3000;
  }
  lastRateFetch = Date.now();
  return cachedEthRate;
}
async function convertUsdToEth(usd){
  const rate = await getEthRate();
  return usd / rate;
}

 
/* üßæ NEW FORMAT: show USD first, ETH in brackets */
function formatPrice(priceUSD, ethRate) {
  const usd = Number(priceUSD) || 0;
  if (!ethRate) return `$${usd} (‚âà... ETH)`;
  const eth = (usd / ethRate).toFixed(4);
  return `$${usd} (‚âà${eth} ETH)`;
}


/* Small helper for places that use ETH only */
function formatEthFromUsd(priceUSD, ethRate) {
  if (!priceUSD) return "0.0000 ETH";
  const eth = ethRate ? (priceUSD / ethRate).toFixed(4) : "...";
  return `${eth} ETH`;
}

  /* üíµ Always get USD price from product */
function getProductUsd(p) {
  if (p.priceUSD) return p.priceUSD;
  if (p.variants && p.variants[0]?.priceUSD) return p.variants[0].priceUSD;
  if (p.price) return Math.round(p.price * (cachedEthRate || 3000));
  return 0;
}

/* ===== RENDER (async so we can fetch ETH rate) ===== */
async function showCategory(cat) {
  currentCategory = cat;
  const container = document.getElementById('items');
  const items = PRODUCTS[cat] || [];
  container.innerHTML = '';

  if (items.length === 0) {
    container.innerHTML = `<div style="background:var(--card);padding:20px;border-radius:12px;box-shadow:var(--shadow);">No items yet in ${cat}.</div>`;
    return;
  }

  // fetch rate once for this render
  const ethRate = await getEthRate();

  document.body.classList.add('blur-bg');

  items.forEach(p => {
    const el = document.createElement('div');
    el.className = 'item';

    // CASE: product has variants (miniplushies or tee with variant array)
    if (p.variants && Array.isArray(p.variants)) {
  const defaultVar = p.variants[0];
  const imgId = `img_${p.id}`;
  const variantId = `variant_${p.id}`;

  const defaultImg = (p.images && typeof p.images === "object")
    ? Object.values(p.images)[0]
    : (defaultVar.images?.[0] || "");

  const defaultUsd = defaultVar.priceUSD ?? getProductUsd(p);
  const displayPrice = formatPrice(defaultUsd, ethRate);

  el.innerHTML = `
    <img id="${imgId}" src="${defaultImg}" alt="${p.title}" />
    <h3>${p.title}</h3>
    <div class="price" id="price_${p.id}">${displayPrice}</div>

    <label style="display:block;text-align:left;font-weight:600">Variant</label>
    <select id="${variantId}">
      ${p.variants.map(v => `
        <option value="${v.name}" data-price-usd="${v.priceUSD ?? ''}">
          ${v.name}
        </option>`).join('')}
    </select>

    ${p.sizes ? `
      <label style="display:block;text-align:left;font-weight:600;margin-top:8px;">Size</label>
      <select id="size_${p.id}">
        ${p.sizes.map(s=>`<option value="${s}">${s}</option>`).join('')}
      </select>` : ""}

    ${(p.images && typeof p.images === "object" && Object.keys(p.images).length>1) ? `
      <label style="display:block;text-align:left;font-weight:600;margin-top:8px;">Color</label>
      <select id="color_${p.id}">
        ${Object.keys(p.images).map(c => `<option value="${c}">${c}</option>`).join('')}
      </select>` : ""}

    <div style="margin-top:12px">
      <button class="btn" onclick="addToCart('${p.id}')">Add to cart</button>
    </div>
  `;
  container.appendChild(el);

  // --- LISTENERS ---
  const variantSelect = el.querySelector(`#${variantId}`);
  const priceEl = el.querySelector(`#price_${p.id}`);
  const imgEl = el.querySelector(`#${imgId}`);

  if (variantSelect) {
    variantSelect.addEventListener("change", async (e) => {
      const selectedName = e.target.value;
      const selectedVar = p.variants.find(v => v.name === selectedName);
      const usd = selectedVar?.priceUSD ?? getProductUsd(p);
      const rate = await getEthRate();
      priceEl.textContent = formatPrice(usd, rate);

      if (selectedVar?.images?.length) imgEl.src = selectedVar.images[0];
    });
  }

  const colorSelect = el.querySelector(`#color_${p.id}`);
  if (colorSelect) {
    colorSelect.addEventListener("change", e => {
      const val = e.target.value;
      if (p.images[val]) imgEl.src = p.images[val];
    });
  }

  return; // continue loop
}

    // If multiple images -> carousel (tapestry)
    if (Array.isArray(p.images) && p.images.length > 1) {
      const imgsHtml = p.images.map((src,i)=>`<img src="${src}" class="${i===0?'active':''}" data-index="${i}" alt="${p.title} ${i+1}" />`).join('');
      const displayPrice = (p.price ?? 0).toFixed(4);
      el.innerHTML = `
        <div class="carousel" id="carousel_${p.id}">
          ${imgsHtml}
          <button class="prev-btn" aria-label="Previous">‚Äπ</button>
          <button class="next-btn" aria-label="Next">‚Ä∫</button>
        </div>
        <h3>${p.title}</h3>
   <div class="price">${formatPrice(getProductUsd(p), ethRate)}</div>
        ${ (p.sizes && p.sizes.length) ? `<label style="display:block;text-align:left;font-weight:600">Size</label><select id="size_${p.id}">${p.sizes.map(s=>`<option value="${s}">${s}</option>`).join('')}</select>` : "" }
        <div style="margin-top:12px"><button class="btn" onclick="addToCart('${p.id}')">Add to cart</button></div>
      `;
      container.appendChild(el);

      // carousel logic (scoped)
      (()=>{
        const carousel = el.querySelector('.carousel');
        const imgs = Array.from(carousel.querySelectorAll('img'));
        let index = 0;
        const setIndex = (newIdx) => {
          imgs.forEach((img,i)=>{
            if(i===index){
              img.classList.remove('active'); img.style.opacity='0'; img.style.position='absolute'; img.style.pointerEvents='none';
            }
          });
          index = (newIdx + imgs.length) % imgs.length;
          imgs[index].classList.add('active'); imgs[index].style.opacity='1'; imgs[index].style.position='relative'; imgs[index].style.pointerEvents='auto';
        };
        const nextBtn = carousel.querySelector('.next-btn');
        const prevBtn = carousel.querySelector('.prev-btn');
        nextBtn.addEventListener('click', e=>{ e.stopPropagation(); setIndex(index+1); });
        prevBtn.addEventListener('click', e=>{ e.stopPropagation(); setIndex(index-1); });
        let startX = null;
        carousel.addEventListener('touchstart',(ev)=> startX = ev.touches[0].clientX);
        carousel.addEventListener('touchend',(ev)=>{
          if(!startX) return;
          const diff = ev.changedTouches[0].clientX - startX;
          if(diff > 30) setIndex(index - 1);
          else if(diff < -30) setIndex(index + 1);
          startX = null;
        });
        let autoSlide = setInterval(()=> setIndex(index+1), 4000);
        carousel.addEventListener('mouseenter', ()=> clearInterval(autoSlide));
        carousel.addEventListener('mouseleave', ()=> autoSlide = setInterval(()=> setIndex(index+1), 4000));
      })();

      return;
    }

    // Single-image items (tees without variant array, keychains, etc.)
    const imgId = `img_${p.id}`;
    const sizeId = `size_${p.id}`;
    let labelText = "Size";
    if (p.id === "quackheads_keychain") labelText = "Top Accessory";

    const sizeSelectHtml = (p.sizes && p.sizes.length) ? `<label style="display:block;text-align:left;font-weight:600">${labelText}</label><select id="${sizeId}">${p.sizes.map(s=>`<option value="${s}">${s}</option>`).join('')}</select>` : "";

    // variant select for tees (if product contains variant info via variants array it's handled above).
    let variantSelectHtml = "";
    if (p.title && p.title.includes("Tee") && !p.variants) {
      // If this tee type uses simple variant choices (not variants array), show dropdown
      variantSelectHtml = `
        <label style="display:block;text-align:left;font-weight:600;margin-top:8px;">Variant</label>
        <select id="variant_${p.id}">
          <option value="T-Shirt" data-price="${p.price ?? 0}" data-price-usd="${p.priceUSD ?? ''}">T-Shirt</option>
          <option value="Drop Shoulder" data-price="${p.price ?? 0}" data-price-usd="${p.priceUSD ?? ''}">Drop Shoulder</option>
        </select>
      `;
    }

    // image source selection
    const mainSrc = Array.isArray(p.images) ? (p.images[0] || "") : (p.images && p.images.Black ? p.images.Black : (p.images ? Object.values(p.images)[0] : ""));

    // compute price display
    const priceEth = (typeof p.price === 'number') ? p.price : (p.priceUSD ? (p.priceUSD / ethRate) : 0);
    const priceHtml = `<div class="price">${formatPrice(getProductUsd(p), ethRate)}</div>`;

    el.innerHTML = `
      <img id="${imgId}" src="${mainSrc}" alt="${p.title}" />
      <h3>${p.title}</h3>
      ${priceHtml}
      ${variantSelectHtml}
      ${sizeSelectHtml}
      ${p.sizeGuide ? `<button class="btn size-guide-btn" style="margin-left:8px;padding:6px 8px;font-size:12px" onclick="openSizeGuide('${p.sizeGuide}')">üìù Size Guide</button>` : ""}
      <div id="colorWrap_${p.id}" style="margin-top:8px"></div>
     <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px;justify-content:center">
  ${p.hasCustomField ? `
    <label style="display:block;text-align:left;font-weight:600;margin-top:8px;">Your Quacker Friend ID#</label>
    <input type="text" id="custom_${p.id}" placeholder="Enter your ID" 
      style="width:100%;padding:6px;border-radius:6px;border:1px solid #ccc;" />
  ` : ""}

  ${
  p.pointsCost
    ? `<button class="btn" onclick="redeemWithPoints('${p.id}', ${p.pointsCost})">
        Redeem for ${p.pointsCost} Points
      </button>`
    : `<button class="btn" onclick="addToCart('${p.id}')">Add to cart</button>`
}

</div>

    `;
    container.appendChild(el);

    // color selector (if object)
    if (p.images && typeof p.images === "object" && !Array.isArray(p.images)) {
      const colorKey = `color_${p.id}`;
      const colorWrap = el.querySelector(`#colorWrap_${p.id}`);
      const colorHtml = `<label style="display:block;text-align:left;font-weight:600">Color</label><select id="${colorKey}">${Object.keys(p.images).map(c=>`<option value="${c}">${c}</option>`).join('')}</select>`;
      colorWrap.innerHTML = colorHtml;
      const colorSelect = colorWrap.querySelector(`#${colorKey}`);
      colorSelect.addEventListener('change', e => {
        const imgEl = el.querySelector(`#${imgId}`);
        if (imgEl && p.images[e.target.value]) imgEl.src = p.images[e.target.value];
      });
    }

    // variant price update for simple tee variant select
    const variantSelect = el.querySelector(`#variant_${p.id}`);
    if (variantSelect) {
      variantSelect.addEventListener('change', e => {
        const selectedOption = e.target.options[e.target.selectedIndex];
        const newEth = parseFloat(selectedOption.getAttribute("data-price")) || 0;
        const newUsd = selectedOption.getAttribute("data-price-usd") || "";
        const priceEl = document.querySelector(`#price_${p.id}`);
        if (priceEl) priceEl.textContent = `${newEth.toFixed(4)} ETH${newUsd?` (~$${newUsd})`:""}`;
      });
    }
  });

  // restore zoom/hover effects
  attachZoomFollow();
}

/* ===== OPEN/CLOSE Helpers ===== */
function showOverlay(){ const ov = document.getElementById('tees'); if(ov){ ov.classList.add('active'); ov.style.display='block'; } }
function hideOverlay(){ const ov = document.getElementById('tees'); if(ov){ ov.classList.remove('active'); ov.style.display='none'; } }

/* ===== SIZE GUIDE ===== */
function openSizeGuide(url){
  const modal = document.getElementById("sizeGuideModal");
  if(modal) document.getElementById("sizeGuideImage").src = url;
  if(modal){ modal.classList.add("open"); modal.setAttribute("aria-hidden","false"); }
}
function closeSizeGuide(){ const modal = document.getElementById("sizeGuideModal"); if(modal){ modal.classList.remove("open"); modal.setAttribute("aria-hidden","true"); } }

/* ===== CART helpers (addTapestry kept for convenience) ===== */
function addTapestryToCart(prodId){
  const product = (PRODUCTS.tapestry||[]).find(p=>p.id===prodId);
  if(!product){ showToast("Product not found","error"); return; }
  const priceEth = product.price ?? (product.priceUSD ? product.priceUSD / (cachedEthRate||3000) : 0);
  cart.push({ id: product.id, title: product.title, price: priceEth, priceUSD: product.priceUSD||"", color: "N/A", size:"N/A", variant: "", q:1, thumb: product.images[0] });
  updateCartUI();
  showToast(`${product.title} added to cart`,"success");
}

/* ---- Add to Cart (async to handle USD‚ÜíETH conversions) ---- */
async function addToCart(prodId) {
  // find product
  let product = null;
  for (const cat of Object.keys(PRODUCTS)) {
    product = (PRODUCTS[cat] || []).find(p => p.id === prodId);
    if (product) break;
  }
  if(!product){ showToast("Product not found","error"); return; }

  // variant path (product.variants array) - mini plushies and some tees
  if (product.variants && product.variants.length) {
  const variantEl = document.getElementById(`variant_${prodId}`);
  const colorEl = document.getElementById(`color_${prodId}`);
  const sizeEl = document.getElementById(`size_${prodId}`);
  const customEl = document.getElementById(`custom_${prodId}`);

  const variantName = variantEl ? variantEl.value : product.variants[0].name;
  const selectedVar = product.variants.find(v => v.name === variantName);
  if(!selectedVar){ showToast("Variant not found","error"); return; }

  const color = colorEl ? colorEl.value : (product.images && typeof product.images === "object" ? Object.keys(product.images)[0] : "N/A");
  const size = sizeEl ? sizeEl.value : (product.sizes && product.sizes.length ? product.sizes[0] : "N/A");
  const customText = customEl ? customEl.value.trim() : "";

  if (product.hasCustomField && !customText) {
    showToast("Please enter your Quacker Friend ID before adding to cart.", "error");
    return;
  }

  // compute price in ETH
  let priceEth;
  if (typeof selectedVar.price === 'number') priceEth = selectedVar.price;
  else if (selectedVar.priceUSD) priceEth = await convertUsdToEth(Number(selectedVar.priceUSD));
  else priceEth = product.price ?? (product.priceUSD ? (await convertUsdToEth(product.priceUSD)) : 0);

  const thumb = selectedVar.images?.[0] || product.images?.[0] || "";

  const existing = cart.find(
    (item) => item.id === product.id &&
      item.variant === selectedVar.name &&
      item.color === color &&
      item.size === size &&
      (product.hasCustomField ? item.customText === customText : true)
  );

  if (existing) existing.q += 1;
  else {
    cart.push({
      id: product.id,
      title: product.title,
      variant: selectedVar.name,
      price: Number(priceEth),
      priceUSD: selectedVar.priceUSD ?? product.priceUSD ?? "",
      color,
      size,
      customText,
      q: 1,
      thumb
    });
  }

  updateCartUI();
  showToast(`${product.title} (${variantName}, ${color}, ${size}) added to cart`, "success");
  return;
}

  // non-variants (tees with simple variantSelect, keychains, etc.)
  const colorEl = document.getElementById(`color_${prodId}`);
  const sizeEl = document.getElementById(`size_${prodId}`);
  const customEl = document.getElementById(`custom_${prodId}`);
  const variantElSimple = document.getElementById(`variant_${prodId}`);

  const color = colorEl ? colorEl.value : (product.images && typeof product.images === "object" ? Object.keys(product.images)[0] : "N/A");
  const size = sizeEl ? sizeEl.value : (product.sizes && product.sizes.length ? product.sizes[0] : "N/A");
  const customText = customEl ? customEl.value.trim() : "";
  const variant = variantElSimple ? variantElSimple.value : "";

  if (product.hasCustomField && !customText) {
    showToast("Please enter your Quacker Friend ID before adding to cart.", "error");
    return;
  }

  // price in ETH (product may have price or priceUSD)
  let priceEth;
  if (typeof product.price === 'number') priceEth = product.price;
  else if (product.priceUSD) priceEth = await convertUsdToEth(Number(product.priceUSD));
  else priceEth = 0;

  const finalSize = customText ? `${size} (ID: ${customText})` : size;
  const thumb = (Array.isArray(product.images) ? product.images[0] : (product.images?.Black || (product.images ? Object.values(product.images)[0] : ""))) || "";

  // merge logic: include variant in identity (so tees + minis with same id but different variant don't merge)
  const existing = cart.find((item) => item.id === product.id && item.color === color && item.size === size && item.variant === variant && (product.hasCustomField ? item.customText === customText : true));
  if (existing) {
    existing.q = (existing.q || 1) + 1;
  } else {
    cart.push({
      id: product.id,
      title: product.title,
      price: Number(priceEth),
      priceUSD: product.priceUSD ?? "",
      color,
      size: finalSize,
      customText: customText || "",
      variant: variant || "",
      q: 1,
      thumb,
    });
  }

  updateCartUI();
  showToast(`${product.title} (${color}, ${size}${variant ? `, ${variant}` : ""}) added to cart`, "success");
}

/* ===== CART UI ===== */
function updateCartUI(){
  const countEl = document.getElementById("cartCount");
  const listEl = document.getElementById("cartList");
  const totalEl = document.getElementById("cartTotal");
  if(!countEl || !listEl || !totalEl) return console.warn("Cart UI elements missing");

  const cartCount = cart.reduce((s,i)=>s+i.q,0);
  if(cartCount>0){ countEl.style.display="inline-block"; countEl.innerText = cartCount; } else countEl.style.display="none";

  if(cart.length===0){ listEl.innerHTML = "<p style='color:#666'>Cart is empty</p>"; totalEl.innerText = "0 ETH"; return; }

  listEl.innerHTML = "";
  let total = 0;
  cart.forEach((ci, idx)=>{
    const row = document.createElement("div");
    row.className = "cart-item";
    const thumb = ci.thumb || "";
    row.innerHTML = `
      <img src="${thumb}" alt="${ci.title}" />
      <div style="flex:1">
        <div style="font-weight:700">${ci.title}${ci.variant?` ‚Äî ${ci.variant}`:""}</div>
        <div style="font-size:13px;color:#666">${ci.color || "N/A"} ‚Ä¢ ${ci.size || "N/A"}</div>
        <div style="margin-top:6px">${(ci.price || 0).toFixed(6)} ETH</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px">
        <input class="qty" type="number" min="1" value="${ci.q}" onchange="changeQty(${idx}, this.value)" style="width:56px;padding:6px;border-radius:6px;border:1px solid #ddd;text-align:center" />
        <button style="background:transparent;border:none;color:#e11;cursor:pointer" onclick="removeFromCart(${idx})">Remove</button>
      </div>
    `;
    listEl.appendChild(row);
    total += (ci.price || 0) * ci.q;
  });
  totalEl.innerText = total.toFixed(6) + " ETH";
}
function changeQty(index,val){ const v = Number(val)||1; cart[index].q = Math.max(1,v); updateCartUI(); }
function removeFromCart(index){ cart.splice(index,1); updateCartUI(); }

/* ===== CART MODAL UI ===== */
const cartModal = document.getElementById("cartModal");
const openCartBtn = document.getElementById("openCartBtn");
if(openCartBtn) openCartBtn.addEventListener("click", ()=> {
  if(cart.length === 0){ showToast("Cart is empty", "info"); return; }
  if(cartModal){ cartModal.classList.add("open"); cartModal.setAttribute("aria-hidden","false"); }
  showOverlay();
  updateCartUI();
});
function closeCart(){ if(cartModal){ cartModal.classList.remove("open"); cartModal.setAttribute("aria-hidden","true"); } hideOverlay(); }

/* ===== WALLET & PROFILE ===== */
async function connectWallet(){
  if(!window.ethereum){ showToast("MetaMask not found","error"); return; }
  try{
    web3 = new Web3(window.ethereum);
    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
    userAddress = accounts[0];
    const connectBtn = document.getElementById("connectBtn");
    if(connectBtn) connectBtn.innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
    const profileBtn = document.getElementById("profileBtn");
    if(profileBtn) profileBtn.style.display = "inline-block";
    const walletAddr = document.getElementById("walletAddr");
    if(walletAddr) walletAddr.innerText = userAddress;
    showToast("Wallet connected","success");
    await updatePointsDisplay();

  }catch(err){
    console.error(err);
    showToast("Connect failed","error");
  }
}
const connectBtn = document.getElementById("connectBtn");
if(connectBtn) connectBtn.addEventListener("click", connectWallet);

const profileBtn = document.getElementById("profileBtn");
if(profileBtn) profileBtn.addEventListener("click", async ()=>{
  const panel = document.getElementById("profileSection");
  if(panel) panel.style.display = panel.style.display === "block" ? "none" : "block";
  if(!userAddress) return;
  try{
    const contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
    const balance = await contract.methods.balanceOf(userAddress).call();
    const nftCountEl = document.getElementById("nftCount");
    if(nftCountEl) nftCountEl.innerText = "NFTs Owned: " + balance;
    const res = await fetch(`${CLAIM_SHEET_API}?wallet=${encodeURIComponent(userAddress)}`);
    const data = await res.json();
    const userRow = Array.isArray(data) ? data.find(r => (r.address||"").toLowerCase() === userAddress.toLowerCase()) : null;
    const quacksCount = document.getElementById("quacksCount");
    if(quacksCount) quacksCount.innerText = "Daily Quacks: " + (userRow ? userRow.quacks_collected : 0);
  }catch(err){ console.error(err); showToast("Error loading profile","warn"); }
});

async function switchWallet(){ try{ await ethereum.request({ method:"wallet_requestPermissions", params:[{eth_accounts:{}}] }); const accounts = await ethereum.request({ method:"eth_requestAccounts" }); userAddress = accounts[0]; const walletAddr = document.getElementById("walletAddr"); if(walletAddr) walletAddr.innerText = userAddress; showToast("Wallet switched","success"); }catch(err){ console.error(err); } }
function disconnectWallet(){ userAddress = null; web3 = null; const cbo = document.getElementById("connectBtn"); if(cbo) cbo.innerText = "Connect Wallet"; const profileBtn = document.getElementById("profileBtn"); if(profileBtn) profileBtn.style.display = "none"; const profileSection = document.getElementById("profileSection"); if(profileSection) profileSection.style.display = "none"; showToast("Wallet disconnected","info"); }

  /* ===== Redeem Points Display ===== */
  async function updatePointsDisplay() {
  const wallet = (userAddress || "").toLowerCase();
  const el = document.getElementById("pointsDisplay");
  if (!el) return;

  if (!wallet) {
    el.innerText = "ü™ô Points: Connect wallet";
    return;
  }

  try {
    const res = await fetch(`${PURCHASE_API}?wallet=${wallet}&checkPoints=true`);
    const data = await res.json();

    if (data.success) {
      el.innerText = `ü™ô Points: ${data.points}`;
    } else {
      el.innerText = "ü™ô Points: Error";
    }
  } catch (err) {
    el.innerText = "ü™ô Points: Error";
  }
}

/* ===== CLAIM QUACKS ===== */
const claimQuacksBtn = document.getElementById("claimQuacksBtn");
if(claimQuacksBtn) claimQuacksBtn.addEventListener("click", async ()=>{
  if(!userAddress){ showToast("Connect wallet first","warn"); return; }
  try{
    const contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
    const balance = await contract.methods.balanceOf(userAddress).call();
    const quacksToAdd = Number(balance) > 0 ? 10 : 2;
    const res = await fetch(`${CLAIM_SHEET_API}?wallet=${encodeURIComponent(userAddress)}&claim=true&quacks=${quacksToAdd}`);
    const data = await res.json();
    if(data.error){ showToast(data.error, "warn"); } else {
      showToast(`ü¶Ü Claimed ${quacksToAdd} Quacks!`, "success");
      const userRow = Array.isArray(data) ? data.find(r => (r.address||"").toLowerCase() === userAddress.toLowerCase()) : null;
      const quacksCount = document.getElementById("quacksCount");
      if(quacksCount) quacksCount.innerText = "Daily Quacks: " + (data.new_quacks_total || (userRow ? userRow.quacks_collected : 0));
    }
  }catch(err){ console.error(err); showToast("Error claiming quacks","error"); }
});

/* ===== CHECKOUT / PURCHASE LOGGING ===== */
const checkoutBtn = document.getElementById("checkoutBtn");
if(checkoutBtn) checkoutBtn.addEventListener("click", checkout);

async function checkout(){
  // üßæ Check that user entered shipping address
const shippingAddress = document.getElementById("userAddressInput")?.value || "";
 const referrer = document.getElementById("referrerInput").value.trim();

if (!shippingAddress.trim()) {
  showToast("Please enter your shipping address before completing your purchase!", "error");
  return; // stop the function here if empty
}
  
  try{
    if(!window.ethereum){ showToast("MetaMask not found","error"); return; }
    if(!userAddress){ showToast("Connect wallet first","error"); return; }
    if(cart.length === 0){ showToast("Cart is empty","info"); return; }

    try{
      const chain = await ethereum.request({ method: 'eth_chainId' });
      if(chain !== BASE_CHAIN_ID_HEX){
        await ethereum.request({ method: 'wallet_switchEthereumChain', params:[{chainId: BASE_CHAIN_ID_HEX}] });
        showToast("Switched to Base mainnet","success");
      }
    }catch(switchErr){ console.warn("Chain switch issue:", switchErr); }

    // compute total ETH using stored ci.price (ETH). If some items have priceUSD only, convert (but addToCart already sets price in ETH when possible)
    let totalEth = cart.reduce((s,i)=> s + ((Number(i.price) || 0) * (i.q || 1)), 0);

    // fallback: if totalEth is 0 but there are priceUSD entries, sum and convert
    if(totalEth === 0) {
      let totalUsd = 0;
      cart.forEach(ci => { totalUsd += Number(ci.priceUSD || 0) * (ci.q || 1); });
      const rate = await getEthRate();
      totalEth = totalUsd / rate;
    }

     let txHash = "";
    const isRedeemOnly = cart.every(ci => ci.redeem);

    if (!isRedeemOnly) {
      const valueHex = totalEth > 0 ? "0x" + BigInt(Math.floor(totalEth * 1e18)).toString(16) : "0x0";
      const txParams = { from: userAddress, to: SHOP_WALLET, value: valueHex };
      showToast("Please confirm the transaction in your wallet...", "info", 8000);

      try {
        txHash = await ethereum.request({ method: "eth_sendTransaction", params: [txParams] });
      } catch (txErr) {
        console.warn("tx aborted", txErr);
        showToast("Transaction cancelled or failed ‚Äî purchase not logged", "error");
        return;
      }

      showToast("Transaction sent ‚Äî logging purchase...", "success", 4000);
      await new Promise(r => setTimeout(r, 1200));
    } else {
      showToast("Redeeming item with points...", "info", 4000);
    }


    // log each cart item (includes variant field)
    for (const ci of cart) {
        const payload = {
        wallet: userAddress,
        variant: ci.variant || "",
        color: ci.color || "",
        size: ci.size || "",
        quantity: ci.q || 1,
        address: shippingAddress,
        txHash,
        referrer
      };

      // Distinguish between redeemed and purchased
      if (ci.redeem) {
        payload.redeem = ci.title;
        payload.cost = ci.cost;
      } else {
        payload.itemName = ci.title;
        payload.price = Number(ci.price || 0);
      }

      const params = new URLSearchParams(payload).toString();
      try {
        const res = await fetch(`${PURCHASE_API}?${params}`);
        const data = await res.json();
        console.log("Server response:", data);
      } catch (logErr) {
        console.warn("Logging failed for item", payload, logErr);
      }

}


    cart = [];
updateCartUI();
closeCart();

if (isRedeemOnly) {
  showToast("‚úÖ Redemption logged successfully!", "success", 4000);
  updatePointsDisplay(); // refresh points right away
} else {
  showToast("‚úÖ Purchase logged successfully!", "success", 4000);
}
 const baseScanUrl = `https://basescan.org/tx/${txHash}`;
    const linkToast = document.createElement("div");
    linkToast.className = "toast success";
    linkToast.innerHTML = `‚úÖ Purchase sent ‚Äî <a href="${baseScanUrl}" target="_blank" style="color:#fff;text-decoration:underline">View on BaseScan</a>`;
    document.getElementById("toast-container").appendChild(linkToast);
    setTimeout(()=>linkToast.remove(), 8000);
    
  }catch(err){ console.error("checkout error", err); showToast("Checkout failed", "error"); }
}

 
/* ===== POINTS REDEMPTION ===== */
async function redeemWithPoints(productId, cost) {
  const wallet = (userAddress || "").toLowerCase();
  if (!wallet) {
    showToast("Please connect your wallet first.", "error");
    return;
  }

  const allProducts = Object.values(PRODUCTS).flat();
  const product = allProducts.find(p => p.id === productId);
  if (!product) {
    showToast("Product not found", "error");
    return;
  }

  // ‚úÖ Check user points before allowing redemption
  try {
    const checkRes = await fetch(`${PURCHASE_API}?wallet=${wallet}&checkPoints=true`);
    const checkData = await checkRes.json();

    if (!checkData.success) {
      showToast(checkData.error || "Could not verify points", "error");
      return;
    }

    const currentPoints = checkData.points || 0;
    if (currentPoints < cost) {
      showToast(`‚ùå You only have ${currentPoints} points ‚Äî need ${cost} to redeem this item.`, "error");
      return;
    }
  } catch (err) {
    showToast("Error checking points: " + err.message, "error");
    return;
  }

  // ‚úÖ Add to cart as redeemable
  const alreadyInCart = cart.find(i => i.id === productId && i.redeem);
  if (alreadyInCart) {
    showToast("Item already added for redemption.", "info");
    return;
  }

  cart.push({
    id: productId,
    title: product.title,
    price: 0,
    priceUSD: 0,
    q: 1,
    redeem: true,
    cost: cost,
    variant: "",
    color: "",
    size: ""
  });

  updateCartUI();
  showToast(`ü™ô "${product.title}" added to cart for ${cost} points`, "success");
}





/* ===== MENU & overlay safety ===== */
const menuBtn = document.getElementById('menuBtn');
const shopMenu = document.getElementById('shopMenu');
if(menuBtn && shopMenu) {
  menuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); shopMenu.style.display = shopMenu.style.display === "flex" ? "none" : "flex"; });
  document.addEventListener('click', (e)=>{ if(!menuBtn.contains(e.target) && !shopMenu.contains(e.target)){ shopMenu.style.display = "none"; } });
}

// ensure overlay never blocks clicks if not active
hideOverlay();

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', async () => {
  await loadProducts(); // ‚úÖ Wait for products to load

  // ‚úÖ Dynamically build Shop dropdown from sheet categories
  const dropdown = document.getElementById("shopDropdown"); // adjust if your dropdown ID differs
  if (dropdown && Object.keys(PRODUCTS).length) {
    dropdown.innerHTML = ""; // clear old entries
    Object.keys(PRODUCTS).forEach(cat => {
      const item = document.createElement("div");
      item.className = "dropdown-item";
      item.textContent = cat;
      item.addEventListener("click", () => {
        showCategory(cat);
        dropdown.classList.remove("show");
      });
      dropdown.appendChild(item);
    });
  }

  // ‚úÖ Show default category (if exists)
  const firstCat = Object.keys(PRODUCTS)[0] || "Tees";
  await showCategory(firstCat);
});

/* --- zoom follow helpers --- */
function attachZoomFollow(){
  document.querySelectorAll('.item img').forEach(img => {
    img.style.willChange = 'transform';
    img.onmousemove = function(e){
      const rect = img.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;
      img.style.transformOrigin = `${x}% ${y}%`;
      img.style.transform = 'scale(1.5)';
    };
    img.onmouseleave = function(){
      img.style.transformOrigin = 'center center';
      img.style.transform = 'scale(1)';
    };
  });

  // ensure non-active carousel images don't block clicks
  document.querySelectorAll('.carousel').forEach(car => {
    car.querySelectorAll('img').forEach(im => {
      if (!im.classList.contains('active')) {
        im.style.pointerEvents = 'none';
        im.style.opacity = '0';
        im.style.position = 'absolute';
      } else {
        im.style.pointerEvents = 'auto';
        im.style.opacity = '1';
        im.style.position = 'relative';
      }
    });
  });
}
</script>

</body>
</html>
