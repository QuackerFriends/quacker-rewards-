<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quacker Friends Crochet Shop</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    #connect-button, #switch-button, #disconnect-button, #profile-button {
      padding: 8px 12px;
      margin: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    #profile-button {
      background-color: #ffe066;
      border-radius: 6px;
      display: none;
    }
    #wallet-address {
      margin-top: 10px;
    }
    #profile-modal {
      display: none;
      position: fixed;
      top: 50px;
      right: 50px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      width: 300px;
      z-index: 1000;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0,0,0,0.2);
    }
    textarea {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      border-radius: 5px;
    }
    #keychain-section, #claimed-section {
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h1>üß∂ Quacker Friends Crochet Shop</h1>

  <button id="connect-button">Connect Wallet</button>
  <button id="profile-button" onclick="toggleProfile()">User Profile</button>
  <p id="wallet-address"></p>

  <div id="profile-modal">
    <h3>Your Profile</h3>
    <p id="profile-wallet"></p>

    <div id="keychain-section" style="display:none;">
      <p>You're eligible for a free Quacker Keychain!</p>
      <textarea id="shipping-address" placeholder="Enter shipping address..."></textarea>
      <button onclick="submitClaim()">Claim Free Keychain</button>
    </div>

    <div id="claimed-section" style="display:none;">
      <p>‚úÖ You've already claimed your free keychain.</p>
    </div>

    <button onclick="toggleProfile()">Close</button>
  </div>

  <div id="shop" style="margin-top:30px; display:none;">
    <h2>üõçÔ∏è Available Items</h2>
    <div>
      <h3>üßµ Quacker Tapestry</h3>
      <p>$35.00</p>
      <button onclick="buyTapestry()">Buy Now</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="wallet.js"></script>

  <script>
    const CONTRACT_ADDRESS = "0x31d59C9639e3ec3fEA15787F089a6e75C841E107";
    const ABI = window.CONTRACT_ABI;
    let userAddress = "";
    let nftBalance = 0;
    let hasClaimed = false;

    async function checkWalletStatus() {
      if (!window.ethereum) return;

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

      try {
        userAddress = await signer.getAddress();
        nftBalance = await contract.balanceOf(userAddress);
        hasClaimed = await contract.hasClaimed(userAddress);

        document.getElementById("wallet-address").innerText = `Connected: ${userAddress}`;
        document.getElementById("profile-button").style.display = "inline-block";
        document.getElementById("shop").style.display = "block";
      } catch (err) {
        console.error("Wallet check error:", err);
      }
    }

    async function toggleProfile() {
      const modal = document.getElementById("profile-modal");
      const walletDisplay = document.getElementById("profile-wallet");
      const keychainSection = document.getElementById("keychain-section");
      const claimedSection = document.getElementById("claimed-section");

      modal.style.display = modal.style.display === "block" ? "none" : "block";
      walletDisplay.innerText = `Wallet: ${userAddress}\nQuacker NFTs: ${nftBalance.toString()}`;

      keychainSection.style.display = "none";
      claimedSection.style.display = "none";

      if (parseInt(nftBalance) > 0) {
        if (hasClaimed) {
          claimedSection.style.display = "block";
        } else {
          keychainSection.style.display = "block";
        }
      }
    }

    async function submitClaim() {
      const addressInput = document.getElementById("shipping-address").value.trim();
      if (!addressInput) return alert("Please enter a shipping address.");

      if (parseInt(nftBalance) === 0) {
        alert("You must own at least 1 Quacker Friend NFT to claim.");
        return;
      }

      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbx-99nc43kVUpc1p8rMiDmiyvy5087SGQImJqIePR4mTja8G3QQ_e7r0A07rf4DWfEzxw/exec", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            item: "Free Keychain",
            wallet: userAddress,
            price: "$0",
            address: addressInput
          })
        });

        if ((await response.text()).includes("Success")) {
          alert("üéâ Claimed successfully!");
          hasClaimed = true;
          toggleProfile();
        } else {
          alert("Something went wrong!");
        }
      } catch (err) {
        alert("Failed to submit claim.");
        console.error(err);
      }
    }

    function buyTapestry() {
      alert("ü™° Tapestry purchase logic goes here.");
    }

    document.getElementById("connect-button").addEventListener("click", async () => {
      if (window.ethereum) {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        await checkWalletStatus();
      }
    });

    window.addEventListener("load", async () => {
      if (window.ethereum && window.ethereum.selectedAddress) {
        await checkWalletStatus();
      }
    });
  </script>
</body>
</html>
