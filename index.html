<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quacker Friends Shop</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fdfdfd; }
    header { background:#ff9800; padding:10px; color:white; text-align:center; }
    .container { padding:20px; }
    .product-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:20px; }
    .product { border:1px solid #ccc; border-radius:8px; padding:10px; text-align:center; background:#fff; }
    .product img { width:100%; height:auto; border-radius:8px; }
    .btn { padding:8px 12px; margin-top:10px; background:#ff9800; color:white; border:none; border-radius:4px; cursor:pointer; }
    .btn:disabled { background:#ccc; cursor:not-allowed; }
    #cart { margin-top:30px; padding:10px; border:1px solid #ddd; border-radius:8px; background:#fff; }
    #toast-container { position:fixed; top:10px; right:10px; z-index:1000; }
    .toast { background:#333; color:#fff; padding:10px; margin-bottom:5px; border-radius:4px; opacity:0.9; display:flex; justify-content:space-between; align-items:center; }
    .toast.success { background:green; }
    .toast.error { background:red; }
    .toast.warn { background:orange; }
    .toast .close-btn { margin-left:10px; cursor:pointer; }
    #profileSection { display:none; border:1px solid #ccc; padding:10px; border-radius:8px; margin-top:20px; background:#fff; }
    #spinSection { margin-top:15px; }
  </style>
</head>
<body>
<header>
  <h1>Quacker Friends Shop</h1>
  <button id="connectWallet" class="btn">Connect Wallet</button>
  <button id="disconnectWallet" class="btn" style="display:none;">Disconnect</button>
  <button id="profileButton" class="btn">Profile</button>
</header>
<div class="container">
  <div class="product-grid" id="productGrid"></div>
  <div id="cart">
    <h3>Cart</h3>
    <ul id="cartItems"></ul>
    <p id="cartTotal">Total: 0 ETH</p>
    <button id="checkoutButton" class="btn">Checkout</button>
  </div>
  <div id="profileSection">
    <h3>Your Profile</h3>
    <p id="walletAddress">Wallet: </p>
    <p id="ethBalance">Balance: </p>
    <p id="nftCount">NFTs Owned: </p>
    <p id="quacksCount">Quacks Collected: </p>
    <p id="keychainStatus"></p>
    <div id="claimSection"></div>
    <div id="spinSection">
      <button id="spinButton" class="btn">üé° Spin the Wheel</button>
    </div>
  </div>
</div>
<div id="toast-container"></div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script>
const CONTRACT_ADDRESS = "0xa2c82bda5585c1d729e2b4f85dcc9a11ded7db4c";
const CONTRACT_ABI = [{"constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}];
const CLAIM_SHEET_API = "https://script.google.com/macros/s/AKfycbzu2RjvJf8-SyRIekMh53JODYZxoPXQpjJ2aGTqIHd93HgEZpnXcVC_zxoJbJt51zqSuQ/exec";
const SPIN_SHEET_API = "https://script.google.com/macros/s/AKfycbwOsIuZi-r_IFGi4F0O7qN9oaLbB6OPbqHfISzpFSi1OXgrW4hhHnpBnk0fCgforU0jTg/exec";
const SHOP_WALLET = "0x38aF7644b120B56e2FEce98b8A9A3DE14F8Fbf1D";

const PRODUCTS = [
  { id: "pumpkin-keychain", title: "Pumpkin Crochet Keychain", price: "0.001", img: "https://via.placeholder.com/400x300?text=Pumpkin+Keychain" },
  { id: "cat-beanie", title: "Cat Beanie", price: "0.0025", img: "https://via.placeholder.com/400x300?text=Cat+Beanie" },
  { id: "pumpkin-duck", title: "Pumpkin Duck Plushie", price: "0.005", img: "https://via.placeholder.com/400x300?text=Pumpkin+Duck+Plushie" }
];

let userAddress = null;
let web3 = null;
let cart = [];
let lastSpinDate = ""; // ‚úÖ persist spin state

function showToast(message, type="info", duration=3000) {
  const container=document.getElementById("toast-container");
  const toast=document.createElement("div");
  toast.className=`toast ${type}`;
  toast.innerHTML=`<span>${message}</span><span class="close-btn" onclick="this.parentElement.remove()">‚úï</span>`;
  container.appendChild(toast);
  setTimeout(()=>toast.remove(),duration);
}

function renderProducts() {
  const grid=document.getElementById("productGrid");
  PRODUCTS.forEach(prod=>{
    const div=document.createElement("div");
    div.className="product";
    div.innerHTML=`<img src="${prod.img}" alt="${prod.title}"><h4>${prod.title}</h4><p>${prod.price} ETH</p><button class="btn" onclick="addToCart('${prod.id}')">Add to Cart</button>`;
    grid.appendChild(div);
  });
}
renderProducts();

function addToCart(id){
  const prod=PRODUCTS.find(p=>p.id===id);
  if(!prod)return;
  cart.push(prod);
  renderCart();
}
function renderCart(){
  const ul=document.getElementById("cartItems"); ul.innerHTML="";
  let total=0;
  cart.forEach((p,i)=>{
    const li=document.createElement("li");
    li.innerHTML=`${p.title} - ${p.price} ETH <button onclick="removeFromCart(${i})">Remove</button>`;
    ul.appendChild(li);
    total+=parseFloat(p.price);
  });
  document.getElementById("cartTotal").innerText="Total: "+total+" ETH";
}
function removeFromCart(i){cart.splice(i,1);renderCart();}

async function connectWallet(){
  if(window.ethereum){
    web3=new Web3(window.ethereum);
    try{
      const accounts=await ethereum.request({method:"eth_requestAccounts"});
      userAddress=accounts[0];
      document.getElementById("connectWallet").style.display="none";
      document.getElementById("disconnectWallet").style.display="inline-block";
      showToast("Wallet connected: "+userAddress,"success");
    }catch(e){showToast("Connection rejected","error");}
  }else{showToast("No wallet found","error");}
}
function disconnectWallet(){
  userAddress=null; web3=null;
  document.getElementById("connectWallet").style.display="inline-block";
  document.getElementById("disconnectWallet").style.display="none";
  showToast("Wallet disconnected","info");
}
document.getElementById("connectWallet").addEventListener("click",connectWallet);
document.getElementById("disconnectWallet").addEventListener("click",disconnectWallet);

async function checkout(){
  if(!userAddress||!web3){showToast("Connect wallet first","warn");return;}
  if(cart.length===0){showToast("Cart empty","warn");return;}
  const total=cart.reduce((s,p)=>s+parseFloat(p.price),0);
  try{
    await web3.eth.sendTransaction({from:userAddress,to:SHOP_WALLET,value:web3.utils.toWei(total.toString(),"ether")});
    showToast("Payment successful!","success");
    cart=[]; renderCart();
  }catch(e){showToast("Payment failed","error");}
}
document.getElementById("checkoutButton").addEventListener("click",checkout);

async function fetchProfile(){
  if(!userAddress){showToast("Connect wallet first","warn");return;}
  const panel=document.getElementById("profileSection");
  panel.style.display=(panel.style.display==="block")?"none":"block";

  const contract=new web3.eth.Contract(CONTRACT_ABI,CONTRACT_ADDRESS);
  const balance=await contract.methods.balanceOf(userAddress).call();
  document.getElementById("nftCount").innerText="NFTs Owned: "+balance;

  const wei=await web3.eth.getBalance(userAddress);
  const eth=web3.utils.fromWei(wei,"ether");
  document.getElementById("ethBalance").innerText=`Balance: ${parseFloat(eth).toFixed(4)} ETH`;

  try{
    const res=await fetch(`${SPIN_SHEET_API}?wallet=${encodeURIComponent(userAddress.toLowerCase())}&getQuacks=true`,{cache:"no-store"});
    const data=await res.json();
    document.getElementById("quacksCount").innerText=`Quacks Collected: ${data.quacks||0}`;
    lastSpinDate=data.lastSpin||"";
    const today=new Date().toISOString().split("T")[0];
    const spinBtn=document.getElementById("spinButton");
    if(lastSpinDate===today){spinBtn.disabled=true;spinBtn.innerText="üé° Already spun today";}
    else{spinBtn.disabled=false;spinBtn.innerText="üé° Spin the Wheel";}

    const res2=await fetch(`${CLAIM_SHEET_API}?wallet=${userAddress}&checkClaim=true`);
    const data2=await res2.json();
    if(data2.claimed){
      document.getElementById("keychainStatus").innerText="‚úÖ Keychain already claimed!";
      document.getElementById("claimSection").innerHTML="";
    }else if(Number(balance)>0){
      document.getElementById("keychainStatus").innerText="üéÅ Eligible for free keychain!";
      document.getElementById("claimSection").innerHTML=`<button id="claimBtn" class="btn">Claim Keychain</button>`;
      document.getElementById("claimBtn").addEventListener('click',claimKeychain);
    }else{
      document.getElementById("keychainStatus").innerText="Not eligible for keychain.";
      document.getElementById("claimSection").innerHTML="";
    }
  }catch(err){console.error(err);showToast("Error loading profile / quacks","warn");}
  document.getElementById("walletAddress").innerText=userAddress;
}
document.getElementById("profileButton").addEventListener("click",fetchProfile);

async function claimKeychain(){
  if(!userAddress)return;
  try{
    const res=await fetch(`${CLAIM_SHEET_API}?wallet=${userAddress}&claimKeychain=true`);
    const data=await res.json();
    if(data.success){showToast("Keychain claimed!","success");document.getElementById("keychainStatus").innerText="‚úÖ Keychain already claimed!";document.getElementById("claimSection").innerHTML="";}
    else{showToast("Claim failed","error");}
  }catch(err){showToast("Error claiming keychain","error");}
}

document.getElementById("spinButton").addEventListener("click",async()=>{
  if(!userAddress){showToast("Connect wallet first!","warn");return;}
  const today=new Date().toISOString().split("T")[0];
  if(lastSpinDate===today){showToast("Already spun today! Come back tomorrow.","info");return;}
  try{
    const res=await fetch(`${SPIN_SHEET_API}?wallet=${userAddress}&getQuacks=true`,{cache:"no-store"});
    const data=await res.json();
    if(data.lastSpin===today){lastSpinDate=today;showToast("Already spun today! Come back tomorrow.","info");return;}
    let spinAmount=5;
    const nftBalance=parseInt(document.getElementById("nftCount").innerText.replace(/\D/g,""))||0;
    if(nftBalance>0)spinAmount=10;
    const newTotal=(data.quacks||0)+spinAmount;
    const updateRes=await fetch(`${SPIN_SHEET_API}?wallet=${userAddress}&updateQuacks=true&quacks=${newTotal}&lastSpin=${today}`);
    const updateData=await updateRes.json();
    if(updateData.success){
      lastSpinDate=today;
      document.getElementById("quacksCount").innerText=`Quacks Collected: ${newTotal}`;
      const spinBtn=document.getElementById("spinButton");
      spinBtn.disabled=true;spinBtn.innerText="üé° Already spun today";
      showToast(`üéâ You earned ${spinAmount} Quack${spinAmount>1?"s":""}!`,"success");
    }else{showToast("Failed to log Quacks, try again later","warn");}
  }catch(err){console.error("Spin error:",err);showToast("‚ö†Ô∏è Error spinning wheel","error");}
});
</script>
</body>
</html>
