<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quacker Friends Shop</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

    :root {
      --brand-orange: #ff9f29;
      --brand-pink: #ff6b81;
      --muted: #f5f0ea;
      --accent: #e25d73;
      --bg: #fff9f5;
      --text: #333;
      --card-bg: #fff;
      --card-border: #ffe3c0;
    }

    /* Dark theme */
    body.dark {
      --bg: #1e1e1e;
      --text: #f0f0f0;
      --card-bg: #2c2c2c;
      --card-border: #444;
    }

    /* Pastel theme */
    body.pastel {
      --bg: #fdf6ff;
      --text: #444;
      --card-bg: #fff0f6;
      --card-border: #ffcce5;
    }

    body {
      font-family: 'Fredoka', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 22px;
      text-align: center;
      margin: 0;
      transition: background 0.3s, color 0.3s;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      max-width: 1100px;
      margin: 0 auto 16px;
      padding: 0 10px;
    }

    h1 {
      color: var(--brand-orange);
      margin: 0;
      font-size: 20px;
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .controls button, #theme-toggle {
      background: var(--brand-orange);
      color: white;
      border: none;
      border-radius: 18px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s, transform 0.2s;
    }

    .controls button:hover, #theme-toggle:hover {
      background: #e28923;
      transform: scale(1.05);
    }

    #wallet-address {
      font-weight: 600;
      font-size: 13px;
      margin-left: 8px;
      color: var(--text);
    }

    #profile-button {
      position: fixed;
      top: 14px;
      right: 14px;
      background: var(--brand-pink);
      color: white;
      border: none;
      border-radius: 14px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      display: none;
      z-index: 1100;
    }

    #profile-button.loading {
      background: #bbb;
      cursor: wait;
    }

    main {
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 12px;
    }

    #shop {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      border: 1px dashed var(--card-border);
    }

    .product-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      justify-content: center;
    }

    .product-card {
      width: 250px;
      border-radius: 12px;
      background: var(--card-bg);
      border: 1px dashed var(--card-border);
      padding: 12px;
      text-align: center;
      transition: transform 0.2s;
    }

    .product-card:hover {
      transform: translateY(-4px);
    }

    .product-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 10px;
    }

    .product-name {
      font-weight: 700;
      margin-top: 10px;
      color: var(--text);
    }

    .product-price {
      color: var(--brand-pink);
      margin: 6px 0 10px;
      font-weight: 600;
    }

    /* Profile modal */
    #profile-modal {
      display: none;
      position: fixed;
      top: 64px;
      right: 18px;
      width: 300px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.12);
      z-index: 1200;
      text-align: left;
      font-size: 14px;
    }

    .cute-label {
      font-weight: 700;
      color: var(--text);
      margin-top: 8px;
      display: block;
    }

    .small {
      font-size: 13px;
      color: var(--text);
      margin: 6px 0;
    }

    .claim-btn {
      background: var(--brand-orange);
      border-radius: 10px;
      padding: 8px 10px;
      width: 100%;
      color: white;
      border: none;
      transition: background 0.2s;
    }

    .claim-btn:hover {
      background: #e28923;
    }

    .claim-btn[disabled] {
      opacity: .6;
      cursor: not-allowed;
    }

    textarea {
      width: 100%;
      min-height: 70px;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #ddd;
      font-family: inherit;
    }

    @media (max-width:600px) {
      #profile-modal {
        right: 10px;
        left: 10px;
        width: auto;
        top: 70px;
      }
      .product-card {
        width: 45%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>üõçÔ∏è Quacker Friends Shop</h1>
    <div class="controls">
      <button id="connect-button">Connect Wallet</button>
      <button id="disconnect-button" style="display:none">Disconnect</button>
      <button id="switch-button" style="display:none">Switch Wallet</button>
      <button id="theme-toggle">üé®</button>
      <span id="wallet-address"></span>
    </div>
  </header>

  <button id="profile-button" onclick="toggleProfile()">üë§ Profile</button>
  <div id="profile-modal" aria-hidden="true"></div>

  <main>
    <section id="shop" style="display:none">
      <h2 style="color:var(--brand-pink)">‚ú® Our Cute Items</h2>
      <div class="product-grid">
        <div class="product-card">
          <img src="https://source.unsplash.com/250x200/?pumpkin" alt="Pumpkin Keychain">
          <div class="product-name">üéÉ Pumpkin Crochet Keychain</div>
          <div class="product-price">0.001 ETH</div>
          <button class="claim-btn" onclick="buyItem('Pumpkin Crochet Keychain','0.001')">Buy</button>
        </div>
        <div class="product-card">
          <img src="https://source.unsplash.com/250x200/?cat,beanie" alt="Cat Beanie">
          <div class="product-name">üê± Cat Beanie</div>
          <div class="product-price">0.0025 ETH</div>
          <button class="claim-btn" onclick="buyItem('Cat Beanie','0.0025')">Buy</button>
        </div>
        <div class="product-card">
          <img src="https://source.unsplash.com/250x200/?duck,plushie" alt="Pumpkin Duck Plushie">
          <div class="product-name">ü¶Ü Pumpkin Duck Plushie</div>
          <div class="product-price">0.005 ETH</div>
          <button class="claim-btn" onclick="buyItem('Pumpkin Duck Plushie','0.005')">Buy</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* === THEME TOGGLE === */
    const themes = ["light", "dark", "pastel"];
    let currentTheme = 0;
    document.getElementById("theme-toggle").addEventListener("click", () => {
      currentTheme = (currentTheme + 1) % themes.length;
      document.body.className = themes[currentTheme] === "light" ? "" : themes[currentTheme];
    });

    /* === WEB3 CONFIG === */
    const contractAddress = "0xA2c82Bda5585c1D729E2b4f85dCC9a11ded7DB4c";
    const contractABI = ["function balanceOf(address owner) view returns (uint256)"];
    const CLAIM_SHEET_API = "https://script.google.com/macros/s/AKfycbxbPGky4ai49yYSjmGiBgKzOuj0Y04ssGWyppzgheZV7vIVtY9BnHH5IW6l9ZpgFbZ0/exec";
    const RECEIVER_ADDRESS = "0x38aF7644b120B56e2FEce98b8A9A3DE14F8Fbf1D";

    let provider, signer, userAddress = null;
    let contract;
    let userNftCount = 0;

    /* ====== UTIL ====== */
    function normalizeSheetData(raw) {
      if (!raw) return [];
      if (Array.isArray(raw)) {
        if (raw.length > 0 && Array.isArray(raw[0])) {
          return raw.map(row => ({
            item: (row[0] || "").toString(),
            wallet: (row[1] || "").toString(),
            price: (row[2] || "").toString(),
            address: (row[3] || "").toString()
          }));
        }
        if (typeof raw[0] === "object") {
          return raw.map(o => ({
            item: (o.item || o.Item || o[0] || "").toString(),
            wallet: (o.wallet || o.Wallet || o[1] || "").toString(),
            price: (o.price || o.Price || o[2] || "").toString(),
            address: (o.address || o.Address || o[3] || "").toString()
          }));
        }
      }
      return [];
    }

    async function fetchSheetRows() {
      try {
        const r1 = await fetch(CLAIM_SHEET_API, { cache: "no-store" });
        const txt = await r1.text();
        try {
          const parsed = JSON.parse(txt);
          return normalizeSheetData(parsed);
        } catch {}
      } catch {}
      try {
        const r2 = await fetch(CLAIM_SHEET_API + "?action=getAll", { cache: "no-store" });
        if (r2.ok) {
          try {
            const parsed = await r2.json();
            return normalizeSheetData(parsed);
          } catch {
            const txt = await r2.text();
            return normalizeSheetData(JSON.parse(txt));
          }
        }
      } catch {}
      return [];
    }

    async function hasClaimedKeychainForWallet(wallet) {
      if (!wallet) return false;
      try {
        const rows = await fetchSheetRows();
        if (!rows || rows.length === 0) return false;
        const wl = wallet.toLowerCase();
        return rows.some(r => (r.wallet || "").toLowerCase() === wl &&
          ((r.item || "").toLowerCase().includes("keychain") || (r.item || "").toLowerCase().includes("key-chain")));
      } catch {
        return false;
      }
    }

    async function connectWallet() {
      if (!window.ethereum) {
        alert("Please install MetaMask!");
        return;
      }
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, contractABI, provider);
        document.getElementById("wallet-address").innerText = `Connected: ${userAddress}`;
        document.getElementById("connect-button").style.display = "none";
        document.getElementById("disconnect-button").style.display = "inline-block";
        document.getElementById("switch-button").style.display = "inline-block";
        document.getElementById("shop").style.display = "block";
        setupProfileButton();
        await refreshEligibility();
      } catch (err) {
        console.error("connectWallet error:", err);
        alert("Failed to connect wallet.");
      }
    }

    function disconnectWallet() {
      userAddress = null;
      signer = null;
      provider = null;
      contract = null;
      userNftCount = 0;
      teardownProfileButton();
      document.getElementById("wallet-address").innerText = "";
      document.getElementById("connect-button").style.display = "inline-block";
      document.getElementById("disconnect-button").style.display = "none";
      document.getElementById("switch-button").style.display = "none";
      document.getElementById("shop").style.display = "none";
      document.getElementById("profile-modal").style.display = "none";
    }

    async function switchWallet() {
      try {
        await ethereum.request({ method: 'wallet_requestPermissions', params: [{ eth_accounts: {} }] });
        await connectWallet();
      } catch (err) {
        console.error("switchWallet failed", err);
      }
    }

    async function refreshEligibility() {
      if (!contract || !userAddress) return;
      try {
        const bal = await contract.balanceOf(userAddress);
        userNftCount = parseInt(bal.toString());
      } catch {
        userNftCount = 0;
      }
    }

    async function buyItem(itemName, priceEth) {
      if (!signer || !userAddress) {
        alert("Connect wallet first");
        return;
      }
      const shipping = prompt(`Enter shipping address for ${itemName}:`);
      if (!shipping) return;
      try {
        const tx = await signer.sendTransaction({
          to: RECEIVER_ADDRESS,
          value: ethers.utils.parseEther(priceEth)
        });
        await tx.wait();
        const params = new URLSearchParams({
          item: itemName,
          wallet: userAddress,
          price: priceEth + " ETH",
          address: shipping
        });
        await fetch(`${CLAIM_SHEET_API}?${params.toString()}`);
        alert(`${itemName} purchased and logged!`);
        await refreshEligibility();
      } catch (err) {
        console.error("buyItem error:", err);
        alert("Transaction failed or cancelled.");
      }
    }

    async function toggleProfile() {
      const btn = document.getElementById("profile-button");
      const modal = document.getElementById("profile-modal");
      btn.innerText = "‚è≥ Loading...";
      btn.classList.add("loading");

      if (modal.style.display === "block") {
        modal.style.display = "none";
        btn.innerText = "üë§ Profile";
        btn.classList.remove("loading");
        return;
      }

      await refreshEligibility();
      let claimed = await hasClaimedKeychainForWallet(userAddress);

      let html = `<h3>üßë‚Äçüíª Your Profile</h3>
        <span class="cute-label">Wallet</span><div class="small">${userAddress || "‚Äî"}</div>
        <span class="cute-label">Quacker NFTs Owned</span><div class="small">${userNftCount}</div>`;

      if (userNftCount > 0) {
        if (claimed) {
          html += `<div style="margin-top:10px;color:green;font-weight:600">‚úÖ You already claimed your free keychain.</div>`;
        } else {
          html += `<div style="margin-top:10px"><button id="profile-claim-btn" class="claim-btn" onclick="startKeychainClaim()">üéÅ Claim Free Keychain</button></div>`;
        }
      } else {
        html += `<div style="margin-top:10px;color:#b23">‚ùå No Quacker NFTs detected ‚Äî keychain not available.</div>`;
      }

      modal.innerHTML = html;
      modal.style.display = "block";
      btn.innerText = "üë§ Profile";
      btn.classList.remove("loading");
    }

    function startKeychainClaim() {
      const modal = document.getElementById("profile-modal");
      if (userNftCount < 1) {
        alert("You must own at least 1 Quacker Friend NFT to claim.");
        return;
      }
      modal.querySelector('#profile-claim-btn').outerHTML = `
        <div style="margin-top:10px;">
          <textarea id="profile-keychain-address" placeholder="Enter shipping address..."></textarea>
          <div style="margin-top:8px"><button class="claim-btn" onclick="submitKeychainClaim()">Submit Claim</button></div>
        </div>`;
    }

    async function submitKeychainClaim() {
      const addrEl = document.getElementById("profile-keychain-address");
      if (!addrEl) return;
      const shipping = addrEl.value.trim();
      if (!shipping) {
        alert("Enter a shipping address.");
        return;
      }
      await refreshEligibility();
      if (userNftCount < 1) {
        alert("You must own at least 1 Quacker Friend NFT to claim.");
        return;
      }
      const already = await hasClaimedKeychainForWallet(userAddress);
      if (already) {
        alert("You already claimed the keychain.");
        await toggleProfile();
        return;
      }
      try {
        const params = new URLSearchParams({
          item: "Free Keychain",
          wallet: userAddress,
          price: "0",
          address: shipping
        });
        await fetch(`${CLAIM_SHEET_API}?${params.toString()}`);
        alert("‚úÖ Claim submitted!");
        await toggleProfile();
      } catch (err) {
        console.error("submitKeychainClaim error:", err);
        alert("Failed to log claim.");
      }
    }

    function setupProfileButton() {
      document.getElementById("profile-button").style.display = "block";
    }
    function teardownProfileButton() {
      document.getElementById("profile-button").style.display = "none";
    }

    document.getElementById("connect-button").addEventListener("click", connectWallet);
    document.getElementById("disconnect-button").addEventListener("click", disconnectWallet);
    document.getElementById("switch-button").addEventListener("click", switchWallet);
  </script>
</body>
</html>
