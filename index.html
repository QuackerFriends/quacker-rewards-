<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quacker Friends Shop</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

    :root{
      --brand-orange:#ff9f29;
      --brand-pink:#ff6b81;
      --muted:#f5f0ea;
      --accent:#e25d73;
    }

    body {
      font-family: 'Fredoka', sans-serif;
      background: #fff9f5;
      color: #333;
      padding: 22px;
      text-align: center;
      margin:0;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      max-width:1100px;
      margin:0 auto 16px;
      padding:0 10px;
    }

    h1{
      color:var(--brand-orange);
      margin:0;
      font-size:20px;
    }

    .controls {
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* üåü Smooth Cute Buttons */
    .controls button,
    .product-card button,
    .claim-btn {
      background: linear-gradient(135deg, var(--brand-orange), #ffb347);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.25s ease;
      box-shadow: 0 3px 6px rgba(0,0,0,0.12);
    }

    .controls button:hover,
    .product-card button:hover,
    .claim-btn:hover {
      background: linear-gradient(135deg, #ffae42, var(--brand-orange));
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.18);
    }

    .controls button:active,
    .product-card button:active,
    .claim-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    #wallet-address{
      font-weight:600;
      font-size:13px;
      margin-left:8px;
      color:#444;
    }

    #profile-button{
      position:fixed;
      top:14px;
      right:14px;
      background: var(--brand-pink);
      color:white;
      border:none;
      border-radius:20px;
      padding:10px 14px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      display:none;
      z-index:1100;
      transition:all 0.25s ease;
      box-shadow: 0 3px 6px rgba(0,0,0,0.12);
    }

    #profile-button:hover {
      background: #ff8095;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.18);
    }

    #profile-button.loading{
      background:#bbb;
      cursor:wait;
    }

    main{
      max-width:1000px;
      margin:20px auto;
      padding:0 12px;
    }

    #shop{
      background:#fff;
      border-radius:16px;
      padding:18px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }

    .product-grid{
      display:flex;
      flex-wrap:wrap;
      gap:18px;
      justify-content:center;
    }

    .product-card{
      width:250px;
      border-radius:12px;
      background:#fffdfb;
      border:1px dashed #ffe3c0;
      padding:12px;
      text-align:center;
    }

    .product-card img{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:10px;
    }

    .product-name{
      font-weight:700;
      margin-top:10px;
      color:#444;
    }

    .product-price{
      color:var(--brand-pink);
      margin:6px 0 10px;
      font-weight:600;
    }

    /* Profile modal (floating card) */
    #profile-modal {
      display:none;
      position:fixed;
      top:64px;
      right:18px;
      width:300px;
      background:#fffaf0;
      border:1px solid #ffe3c0;
      border-radius:12px;
      padding:12px;
      box-shadow:0 8px 22px rgba(0,0,0,0.12);
      z-index:1200;
      text-align:left;
      font-size:14px;
    }

    .cute-label{
      font-weight:700;
      color:#444;
      margin-top:8px;
      display:block;
    }

    .small{
      font-size:13px;
      color:#555;
      margin:6px 0;
    }

    textarea{
      width:100%;
      min-height:70px;
      border-radius:8px;
      padding:8px;
      border:1px solid #ddd;
      font-family:inherit;
    }

    @media (max-width:600px){
      #profile-modal{
        right:10px;
        left:10px;
        width:auto;
        top:70px;
      }
      .product-card{
        width:45%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>üõçÔ∏è Quacker Friends Shop</h1>
    <div class="controls">
      <div>
        <button id="connect-button">Connect Wallet</button>
        <button id="disconnect-button" style="display:none">Disconnect</button>
        <button id="switch-button" style="display:none">Switch Wallet</button>
        <span id="wallet-address"></span>
      </div>
    </div>
  </header>

  <button id="profile-button" onclick="toggleProfile()">üë§ Profile</button>
  <div id="profile-modal" aria-hidden="true"></div>

  <main>
    <section id="shop" style="display:none">
      <h2 style="color:var(--brand-pink)">‚ú® Our Cute Items</h2>
      <div class="product-grid">
        <div class="product-card">
          <img src="https://source.unsplash.com/250x200/?pumpkin" alt="Pumpkin Keychain">
          <div class="product-name">üéÉ Pumpkin Crochet Keychain</div>
          <div class="product-price">0.001 ETH</div>
          <button onclick="buyItem('Pumpkin Crochet Keychain','0.001')">Buy</button>
        </div>
        <div class="product-card">
          <img src="https://source.unsplash.com/250x200/?cat,beanie" alt="Cat Beanie">
          <div class="product-name">üê± Cat Beanie</div>
          <div class="product-price">0.0025 ETH</div>
          <button onclick="buyItem('Cat Beanie','0.0025')">Buy</button>
        </div>
        <div class="product-card">
          <img src="https://source.unsplash.com/250x200/?duck,plushie" alt="Pumpkin Duck Plushie">
          <div class="product-name">ü¶Ü Pumpkin Duck Plushie</div>
          <div class="product-price">0.005 ETH</div>
          <button onclick="buyItem('Pumpkin Duck Plushie','0.005')">Buy</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* ================== CONFIG ================ */
    const contractAddress = "0xA2c82Bda5585c1D729E2b4f85dCC9a11ded7DB4c";
    const contractABI = ["function balanceOf(address owner) view returns (uint256)"];
    const CLAIM_SHEET_API = "https://script.google.com/macros/s/AKfycbxbPGky4ai49yYSjmGiBgKzOuj0Y04ssGWyppzgheZV7vIVtY9BnHH5IW6l9ZpgFbZ0/exec";
    const RECEIVER_ADDRESS = "0x38aF7644b120B56e2FEce98b8A9A3DE14F8Fbf1D";

    /* ================== STATE ================ */
    let provider, signer, userAddress = null;
    let contract;
    let userNftCount = 0;

    /* normalize sheet rows */
    function normalizeSheetData(raw) {
      if (!raw) return [];
      if (Array.isArray(raw)) {
        if (raw.length > 0 && Array.isArray(raw[0])) {
          return raw.map(row => ({
            item: (row[0] || "").toString(),
            wallet: (row[1] || "").toString(),
            price: (row[2] || "").toString(),
            address: (row[3] || "").toString()
          }));
        }
        if (typeof raw[0] === "object") {
          return raw.map(o => ({
            item: (o.item || o.Item || o[0] || "").toString(),
            wallet: (o.wallet || o.Wallet || o[1] || "").toString(),
            price: (o.price || o.Price || o[2] || "").toString(),
            address: (o.address || o.Address || o[3] || "").toString()
          }));
        }
      }
      return [];
    }

    async function fetchSheetRows() {
      try {
        const r1 = await fetch(CLAIM_SHEET_API, { cache: "no-store" });
        const txt = await r1.text();
        try {
          return normalizeSheetData(JSON.parse(txt));
        } catch {}
      } catch {}
      try {
        const r2 = await fetch(CLAIM_SHEET_API + "?action=getAll", { cache: "no-store" });
        if (r2.ok) {
          try { return normalizeSheetData(await r2.json()); }
          catch { return []; }
        }
      } catch {}
      return [];
    }

    async function hasClaimedKeychainForWallet(wallet) {
      if (!wallet) return false;
      try {
        const rows = await fetchSheetRows();
        if (!rows || rows.length === 0) return false;
        const wl = wallet.toLowerCase();
        return rows.some(r =>
          (r.wallet || "").toLowerCase() === wl &&
          ((r.item || "").toLowerCase().includes("keychain") || (r.item || "").toLowerCase().includes("key-chain"))
        );
      } catch {
        return false;
      }
    }

    async function connectWallet() {
      if (!window.ethereum) { alert("Please install MetaMask!"); return; }
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, contractABI, provider);
        document.getElementById("wallet-address").innerText = `Connected: ${userAddress}`;
        document.getElementById("connect-button").style.display = "none";
        document.getElementById("disconnect-button").style.display = "inline-block";
        document.getElementById("switch-button").style.display = "inline-block";
        document.getElementById("shop").style.display = "block";
        setupProfileButton();
        await refreshEligibility();
      } catch (err) {
        console.error(err);
        alert("Failed to connect wallet.");
      }
    }

    function disconnectWallet() {
      userAddress = null; signer = null; provider = null; contract = null; userNftCount = 0;
      teardownProfileButton();
      document.getElementById("wallet-address").innerText = "";
      document.getElementById("connect-button").style.display = "inline-block";
      document.getElementById("disconnect-button").style.display = "none";
      document.getElementById("switch-button").style.display = "none";
      document.getElementById("shop").style.display = "none";
      document.getElementById("profile-modal").style.display = "none";
    }

    async function switchWallet() {
      try {
        await ethereum.request({ method: 'wallet_requestPermissions', params: [{ eth_accounts: {} }] });
        await connectWallet();
      } catch (err) { console.error("switchWallet failed", err); }
    }

    async function refreshEligibility() {
      if (!contract || !userAddress) return;
      try {
        const bal = await contract.balanceOf(userAddress);
        userNftCount = parseInt(bal.toString());
      } catch { userNftCount = 0; }
    }

    async function buyItem(itemName, priceEth) {
      if (!signer || !userAddress) { alert("Connect wallet first"); return; }
      const shipping = prompt(`Enter shipping address for ${itemName}:`);
      if (!shipping) return;
      try {
        const tx = await signer.sendTransaction({ to: RECEIVER_ADDRESS, value: ethers.utils.parseEther(priceEth) });
        await tx.wait();
        const params = new URLSearchParams({ item: itemName, wallet: userAddress, price: priceEth + " ETH", address: shipping });
        await fetch(`${CLAIM_SHEET_API}?${params.toString()}`);
        alert(`${itemName} purchased and logged!`);
        await refreshEligibility();
      } catch (err) {
        console.error(err);
        alert("Transaction failed or cancelled.");
      }
    }

    async function toggleProfile() {
      const btn = document.getElementById("profile-button");
      const modal = document.getElementById("profile-modal");
      btn.innerText = "‚è≥ Loading..."; btn.classList.add("loading");

      if (modal.style.display === "block") {
        modal.style.display = "none";
        btn.innerText = "üë§ Profile"; btn.classList.remove("loading");
        return;
      }

      await refreshEligibility();
      let claimed = false;
      try { claimed = await hasClaimedKeychainForWallet(userAddress); } catch {}

      let html = `<h3>üßë‚Äçüíª Your Profile</h3>
        <span class="cute-label">Wallet</span><div class="small">${userAddress || "‚Äî"}</div>
        <span class="cute-label">Quacker NFTs Owned</span><div class="small">${userNftCount}</div>`;

      if (userNftCount > 0) {
        if (claimed) {
          html += `<div style="margin-top:10px;color:green;font-weight:600">‚úÖ You already claimed your free keychain.</div>`;
        } else {
          html += `<div style="margin-top:10px"><button id="profile-claim-btn" class="claim-btn" onclick="startKeychainClaim()">üéÅ Claim Free Keychain</button></div>`;
        }
      } else {
        html += `<div style="margin-top:10px;color:#b23">‚ùå No Quacker NFTs detected ‚Äî keychain not available.</div>`;
      }

      modal.innerHTML = html;
      modal.style.display = "block";
      btn.innerText = "üë§ Profile"; btn.classList.remove("loading");
    }

    function startKeychainClaim() {
      if (userNftCount < 1) { alert("You must own at least 1 NFT to claim."); return; }
      document.querySelector('#profile-claim-btn').outerHTML = `
        <div style="margin-top:10px;">
          <textarea id="profile-keychain-address" placeholder="Enter shipping address..."></textarea>
          <div style="margin-top:8px"><button class="claim-btn" onclick="submitKeychainClaim()">Submit Claim</button></div>
        </div>`;
    }

    async function submitKeychainClaim(){
      const addrEl = document.getElementById("profile-keychain-address");
      if (!addrEl) return;
      const shipping = addrEl.value.trim();
      if (!shipping) { alert("Enter a shipping address."); return; }
      await refreshEligibility();
      if (userNftCount < 1) { alert("You must own at least 1 NFT to claim."); return; }
      const already = await hasClaimedKeychainForWallet(userAddress);
      if (already) { alert("You already claimed."); await toggleProfile(); return; }

      try {
        const params = new URLSearchParams({ item: "Keychain", wallet: userAddress, price: "0 (Free)", address: shipping });
        const response = await fetch(`${CLAIM_SHEET_API}?${params.toString()}`);
        const txt = await response.text();
        if (!response.ok || (txt && txt.toLowerCase().includes("error"))) throw new Error("Sheet write failed");
        alert("üéâ Keychain claimed successfully!");
        await refreshEligibility();
        await toggleProfile();
      } catch (err) {
        console.error(err);
        alert("Claim failed ‚Äî please try again.");
      }
    }

    function setupProfileButton(){ document.getElementById("profile-button").style.display = "inline-block"; }
    function teardownProfileButton(){ document.getElementById("profile-button").style.display = "none"; document.getElementById("profile-modal").style.display = "none"; }

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("connect-button").addEventListener("click", connectWallet);
      document.getElementById("disconnect-button").addEventListener("click", disconnectWallet);
      document.getElementById("switch-button").addEventListener("click", switchWallet);
    });
  </script>
</body>
</html>
