<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DuckShop</title>
  <style>
    body { font-family: sans-serif; background: #f9fafb; margin: 0; }
    header { background: #111; color: #fff; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    nav ul { list-style: none; display: flex; gap: 1rem; margin: 0; padding: 0; }
    nav ul li { position: relative; }
    nav ul li ul { display: none; position: absolute; top: 100%; left: 0; background: #222; padding: 0.5rem; border-radius: 0.5rem; }
    nav ul li:hover ul { display: block; }
    nav ul li ul li { padding: 0.5rem; }
    .shop-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; padding: 2rem; }
    .item { background: #fff; border-radius: 1rem; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    .item img { width: 100%; border-radius: 0.75rem; }
    button { background: #111; color: #fff; border: none; border-radius: 2rem; padding: 0.5rem 1rem; cursor: pointer; }
    #cartModal { position: fixed; top: 0; right: 0; width: 320px; height: 100%; background: #fff; box-shadow: -4px 0 10px rgba(0,0,0,0.1); transform: translateX(100%); transition: all 0.3s; display: flex; flex-direction: column; }
    #cartModal.open { transform: translateX(0); }
    #cartItems { flex: 1; overflow-y: auto; padding: 1rem; }
    #closeCartBtn { position: absolute; top: 1rem; right: 1rem; cursor: pointer; }
    #sizeGuideModal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; }
    #sizeGuideModal.open { display: flex; }
    #sizeGuideModal img { width: 400px; border-radius: 1rem; }
  </style>
</head>
<body>
  <header>
    <h2>DuckShop</h2>
    <nav>
      <ul>
        <li>Shop
          <ul>
            <li><a href="#" onclick="showCategory('tees')">Tees</a></li>
            <li><a href="#">Crochet Plushies</a></li>
            <li><a href="#">Tapestry</a></li>
          </ul>
        </li>
        <li><button onclick="openCart()">Cart</button></li>
        <li><button id="connectBtn" onclick="connectWallet()">Connect Wallet</button></li>
        <li><button onclick="toggleProfile()">Profile</button></li>
      </ul>
    </nav>
  </header>

  <main id="shop" class="shop-container"></main>

  <div id="cartModal">
    <span id="closeCartBtn" onclick="closeCart()">‚úñ</span>
    <h3 style="text-align:center;">Your Cart</h3>
    <div id="cartItems"></div>
    <button onclick="checkout()">Checkout</button>
  </div>

  <div id="sizeGuideModal" onclick="closeSizeGuide()">
    <img src="https://files.catbox.moe/41dvss.png" alt="Size Guide">
  </div>

  <script>
    const PURCHASE_API = "https://script.google.com/macros/s/AKfycbwZMlGQ2REZxTP1lIoWBYzc8n7l-h7C79F9u9MjDY4XIR6jKNO7ky1VXtCm3oP5RM_9qA/exec";
    const SHOP_WALLET = "0x0000000000000000000000000000000000000000"; // üëà Replace with your real wallet
    let cart = [], userAddress = null;

    // Simple toast helper (alert fallback)
    function toast(msg, type = "info", duration = 3000) {
      console.log(`[${type.toUpperCase()}] ${msg}`);
      alert(msg);
    }

    const tees = [
      {title: "Battle Duck Black", img: "https://files.catbox.moe/dw04zw.png", price: 0.001},
      {title: "Battle Duck White", img: "https://files.catbox.moe/d6zm2s.png", price: 0.001},
      {title: "Higher Black", img: "https://files.catbox.moe/qi081o.png", price: 0.001},
      {title: "Higher White", img: "https://files.catbox.moe/0gn3r2.png", price: 0.001},
      {title: "Sus Duck Black", img: "https://files.catbox.moe/zqtvvw.png", price: 0.001},
      {title: "Sus Duck White", img: "https://files.catbox.moe/mgu7nu.png", price: 0.001},
      {title: "This is Fine Black", img: "https://files.catbox.moe/nbl7st.png", price: 0.001},
      {title: "This is Fine White", img: "https://files.catbox.moe/5n618u.png", price: 0.001},
    ];

    function showCategory(cat) {
      if (cat === "tees") {
        document.getElementById("shop").innerHTML = tees.map(t => `
          <div class="item">
            <img src="${t.img}">
            <h4>${t.title}</h4>
            <p>Price: ${t.price} ETH</p>
            <label>Color:
              <select><option>Black</option><option>White</option></select>
            </label>
            <label>Size:
              <select><option>S</option><option>M</option><option>L</option><option>XL</option></select>
            </label>
            <button onclick="openSizeGuide()">Size Guide</button>
            <button onclick="addToCart('${t.title}', '${t.img}', ${t.price})">Add to Cart</button>
          </div>
        `).join('');
      }
    }

    function openSizeGuide() {
      document.getElementById("sizeGuideModal").classList.add("open");
    }
    function closeSizeGuide() {
      document.getElementById("sizeGuideModal").classList.remove("open");
    }

    function addToCart(title, img, price) {
      cart.push({title, img, price, q: 1, color: "Black", size: "M"});
      toast("Added to cart!", "success");
    }

    function openCart() { document.getElementById("cartModal").classList.add("open"); updateCartUI(); }
    function closeCart() { document.getElementById("cartModal").classList.remove("open"); }

    function updateCartUI() {
      const div = document.getElementById("cartItems");
      div.innerHTML = cart.map((c, i) => `<p>${c.title} - ${c.price} ETH</p>`).join('');
    }

    async function connectWallet() {
      if (window.ethereum) {
        try {
          const accounts = await ethereum.request({ method: "eth_requestAccounts" });
          userAddress = accounts[0];
          console.log("üëõ Connected wallet:", userAddress);
          document.getElementById("connectBtn").innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
          toast("Wallet connected ‚úÖ", "success");
        } catch (err) {
          console.error("‚ùå Wallet connection failed", err);
          toast("Wallet connection failed", "error");
        }
      } else {
        toast("MetaMask not found!", "error");
      }
    }

    async function checkout() {
      console.log("üöÄ Checkout started");

      try {
        if (!window.ethereum) {
          toast("MetaMask not found!", "error");
          return;
        }
        console.log("‚úÖ Ethereum provider detected:", window.ethereum);

        if (!userAddress) {
          toast("Connect wallet first!", "error");
          return;
        }

        if (cart.length === 0) {
          toast("Your cart is empty!", "info");
          return;
        }

        console.log("üì¶ Cart contents:", cart);

        // Ensure Base network
        const BASE_CHAIN_ID_HEX = "0x2105";
        const currentChain = await ethereum.request({ method: "eth_chainId" });
        console.log("üîó Current chain ID:", currentChain);

        if (currentChain !== BASE_CHAIN_ID_HEX) {
          try {
            await ethereum.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: BASE_CHAIN_ID_HEX }],
            });
            toast("Switched to Base Mainnet ‚úÖ", "success");
          } catch (err) {
            toast("Please switch to Base Mainnet manually", "error");
            return;
          }
        }

        const totalEth = cart.reduce((s, i) => s + (i.price * i.q), 0);
        console.log("üí∞ Total ETH:", totalEth);

        let txHash = "TEST_MODE";
        if (totalEth > 0) {
          console.log("üì§ Sending transaction...");
          const valueHex = "0x" + BigInt(Math.floor(totalEth * 1e18)).toString(16);
          const txParams = { from: userAddress, to: SHOP_WALLET, value: valueHex };

          toast("Confirm transaction in MetaMask...", "info");
          txHash = await ethereum.request({
            method: "eth_sendTransaction",
            params: [txParams],
          });
          console.log("‚úÖ Transaction hash:", txHash);
          toast(`Transaction sent ‚úÖ Hash: ${txHash}`, "success");
        } else {
          console.log("üß™ Test mode (0 ETH)");
          toast("Test mode: 0 ETH ‚Äî logging only", "info");
        }

        for (const ci of cart) {
          const data = {
            wallet: userAddress,
            itemName: ci.title,
            color: ci.color,
            size: ci.size,
            quantity: ci.q,
            price: ci.price * ci.q,
            txHash,
          };
          console.log("üìù Logging to Apps Script:", data);

          try {
            const resp = await fetch(PURCHASE_API, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const js = await resp.json();
            console.log("üìÑ Sheet response:", js);
          } catch (err) {
            console.error("‚ö†Ô∏è Sheet logging failed:", err);
          }
        }

        cart = [];
        updateCartUI();
        closeCart();
        toast("Purchase complete and logged ü¶Ü", "success");
      } catch (err) {
        console.error("üí• Checkout crashed:", err);
        toast(err.message || "Checkout failed", "error");
      }
    }
  </script>
</body>
</html>
