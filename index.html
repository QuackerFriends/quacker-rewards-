<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quacker Friends Shop</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #fefefe; }
    .shop-container { display: flex; gap: 20px; }
    .products { flex: 2; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .product-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .product-card img { width: 100%; height: auto; }
    .product-card .info { padding: 10px; }
    .cart { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff; }
    .toast-container { position: fixed; top: 10px; right: 10px; z-index: 9999; }
    .toast { padding: 10px 15px; margin-bottom: 10px; border-radius: 5px; color: #fff; }
    .toast.info { background: #3498db; }
    .toast.success { background: #2ecc71; }
    .toast.warn { background: #f39c12; }
    .toast.error { background: #e74c3c; }
    .close-btn { margin-left: 10px; cursor: pointer; }
    .actions { margin: 15px 0; }
    button { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
    #spinButton { background: #9b59b6; color: #fff; }
    #connectWallet { background: #2980b9; color: #fff; }
    #claimKeychain { background: #27ae60; color: #fff; }
  </style>
</head>
<body>

<h1>ü¶Ü Quacker Friends Shop</h1>
<div class="actions">
  <button id="connectWallet">üîó Connect Wallet</button>
  <button id="spinButton">üé° Spin the Wheel</button>
  <button id="claimKeychain">üéÅ Claim Pumpkin Keychain</button>
</div>

<div id="profile">
  <p id="walletAddress">Wallet: Not connected</p>
  <p id="nftCount">NFTs: 0</p>
  <p id="quacksCount">Quacks Collected: 0</p>
</div>

<div class="shop-container">
  <div class="products" id="products"></div>
  <div class="cart">
    <h3>üõí Cart</h3>
    <ul id="cartItems"></ul>
    <p id="cartTotal">Total: 0 ETH</p>
    <button id="checkoutBtn">Checkout</button>
  </div>
</div>

<div id="toast-container" class="toast-container"></div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
<script>
const CONTRACT_ADDRESS = "0xa2c82bda5585c1d729e2b4f85dcc9a11ded7db4c";
const CONTRACT_ABI = [{"constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}];
const CLAIM_SHEET_API = "https://script.google.com/macros/s/AKfycbzu2RjvJf8-SyRIekMh53JODYZxoPXQpjJ2aGTqIHd93HgEZpnXcVC_zxoJbJt51zqSuQ/exec";
const SPIN_SHEET_API = "https://script.google.com/macros/s/AKfycbwOsIuZi-r_IFGi4F0O7qN9oaLbB6OPbqHfISzpFSi1OXgrW4hhHnpBnk0fCgforU0jTg/exec";
const SHOP_WALLET = "0x38aF7644b120B56e2FEce98b8A9A3DE14F8Fbf1D";

const PRODUCTS = [
  { id: "pumpkin-keychain", title: "Pumpkin Crochet Keychain", price: "0.001", img: "https://via.placeholder.com/400x300?text=Pumpkin+Keychain" },
  { id: "cat-beanie", title: "Cat Beanie", price: "0.0025", img: "https://via.placeholder.com/400x300?text=Cat+Beanie" },
  { id: "pumpkin-duck", title: "Pumpkin Duck Plushie", price: "0.005", img: "https://via.placeholder.com/400x300?text=Pumpkin+Duck+Plushie" }
];

let userAddress = null;
let web3 = null;
let cart = [];
let lastSpin = "";   // local block memory

function showToast(message, type="info", duration=3000) {
  const container = document.getElementById("toast-container");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span>${message}</span><span class="close-btn" onclick="this.parentElement.remove()">‚úï</span>`;
  container.appendChild(toast);
  setTimeout(()=>toast.remove(), duration);
}

function renderItems(){
  const container = document.getElementById("products");
  PRODUCTS.forEach(p=>{
    const div = document.createElement("div");
    div.className = "product-card";
    div.innerHTML = `
      <img src="${p.img}" alt="${p.title}">
      <div class="info">
        <h4>${p.title}</h4>
        <p>${p.price} ETH</p>
        <button onclick="addToCart('${p.id}')">Add to Cart</button>
      </div>`;
    container.appendChild(div);
  });
}

function addToCart(id){
  const product = PRODUCTS.find(p=>p.id===id);
  cart.push(product);
  updateCartUI();
}
function updateCartUI(){
  const ul = document.getElementById("cartItems");
  ul.innerHTML="";
  let total = 0;
  cart.forEach(item=>{
    const li = document.createElement("li");
    li.textContent = `${item.title} - ${item.price} ETH`;
    ul.appendChild(li);
    total += parseFloat(item.price);
  });
  document.getElementById("cartTotal").innerText = `Total: ${total.toFixed(3)} ETH`;
}

async function connectWallet(){
  if(window.ethereum){
    web3 = new Web3(window.ethereum);
    const accounts = await window.ethereum.request({method:"eth_requestAccounts"});
    userAddress = accounts[0].toLowerCase();
    document.getElementById("walletAddress").innerText = `Wallet: ${userAddress}`;
    showToast("Wallet connected","success");
    fetchProfile();
  } else {
    showToast("No wallet found","error");
  }
}
document.getElementById("connectWallet").addEventListener("click", connectWallet);

async function fetchProfile(){
  if(!userAddress) return;
  const contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
  const balance = await contract.methods.balanceOf(userAddress).call();
  document.getElementById("nftCount").innerText = `NFTs: ${balance}`;

  const res = await fetch(`${SPIN_SHEET_API}?wallet=${userAddress}&getQuacks=true`,{cache:"no-store"});
  const data = await res.json();
  document.getElementById("quacksCount").innerText = `Quacks Collected: ${data.quacks||0}`;
  lastSpin = data.lastSpin || "";
}

// Keychain claim untouched
document.getElementById("claimKeychain").addEventListener("click", async()=>{
  if(!userAddress){ showToast("Connect wallet first","warn"); return; }
  try{
    const res = await fetch(`${CLAIM_SHEET_API}?wallet=${userAddress}&claimKeychain=true`);
    const data = await res.json();
    if(data.success){ showToast("Keychain claimed!","success"); }
    else if(data.reason==="already-claimed"){ showToast("Already claimed","info"); }
    else{ showToast("Failed claim","warn"); }
  }catch(err){
    console.error(err); showToast("Error claiming","error");
  }
});

// Spin logic
document.getElementById("spinButton").addEventListener("click", async () => {
  if(!userAddress){ 
    showToast("Connect wallet first!","warn"); 
    return; 
  }

  const today = new Date().toISOString().split("T")[0];

  try {
    if (lastSpin === today) {
      showToast("Already spun today! Come back tomorrow.","info");
      return;
    }

    const res = await fetch(`${SPIN_SHEET_API}?wallet=${userAddress}&getQuacks=true`, { cache: "no-store" });
    const data = await res.json();

    if (data.lastSpin === today) {
      lastSpin = today;
      showToast("Already spun today! Come back tomorrow.","info");
      return;
    }

    let spinAmount = 5;
    const nftBalance = parseInt(document.getElementById("nftCount").innerText.replace(/\D/g,"")) || 0;
    if(nftBalance > 0) spinAmount = 10;

    const newTotal = (data.quacks || 0) + spinAmount;

    const updateRes = await fetch(`${SPIN_SHEET_API}?wallet=${userAddress}&updateQuacks=true&quacks=${newTotal}&lastSpin=${today}`);
    const updateData = await updateRes.json();

    if(updateData.success){
      document.getElementById("quacksCount").innerText = `Quacks Collected: ${newTotal}`;
      showToast(`üéâ You earned ${spinAmount} Quacks!`,"success");
      lastSpin = today;
    } else {
      showToast("Failed to log Quacks","warn");
    }

  } catch(err){
    console.error("Spin error:", err);
    showToast("‚ö†Ô∏è Error spinning wheel","error");
  }
});

renderItems();
</script>
</body>
</html>
