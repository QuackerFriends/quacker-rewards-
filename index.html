<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quacker Friends Shop</title>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <style>
    :root{
      --brand-orange:#ff914d;
      --brand-orange-dark:#ff7b2c;
      --brand-teal:#66c7c4;
      --card:#ffffff;

      --shadow:0 8px 20px rgba(12,12,20,0.06);
      --radius:14px;
      --maxWidth:1100px;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Poppins',sans-serif;
      margin:0;padding:0;color:#222;min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;position:relative;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:url('https://quackerfriends.github.io/quackheads-assets/images/brandimages/Inside.png') no-repeat center center fixed;background-size:cover;
      z-index:-1;
      transition:filter .4s;
      pointer-events:none;
    }
    


    header{display:flex;justify-content:space-between;align-items:center;padding:14px 24px;background:var(--brand-teal);color:white;box-shadow:0 6px 18px rgba(0,0,0,0.08);z-index:1500;position:relative}
    header h1{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
    header h1 .logo {
  height: 38px;
  width: auto;
  border-radius: 8px;
  margin-right: 6px;
}

/* ===== REFERRAL INFO TOOLTIP (Z-FIXED) ===== */
.info-container {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  color: #fff;
  background: rgba(30, 30, 30, 0.5);
  padding: 6px 12px;
  border-radius: 12px;
  backdrop-filter: blur(8px);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.25);
  /* üö´ No z-index here, keeps it out of stacking traps */
}

.info-icon {
  cursor: pointer;
  font-size: 15px;
  color: #ffb84d;
  opacity: 0.95;
  transition: color 0.25s ease, opacity 0.25s ease;
}

.info-icon:hover {
  color: #ffd580;
  opacity: 1;
}

.tooltip-text {
  visibility: hidden;
  opacity: 0;
  position: fixed;
  background: rgba(0,0,0,0.9);
  color: #fff;
  text-align: center;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 12px;
  width: 220px;
  transition: opacity 0.25s ease;
  pointer-events: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.25);
  z-index: 9999999;
  white-space: normal;
}


.info-container:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
  transform: translateY(-4px);
}

/* --- Align tooltip under the info icon --- */
.info-container:hover .tooltip-text {
  top: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
}


    .btn{padding:10px 16px;background:var(--brand-orange-dark);color:white;border:none;border-radius:999px;cursor:pointer;font-weight:600;transition:all .18s;display:inline-flex;gap:8px;align-items:center}
    .btn.secondary{background:transparent;color:white;border:1px solid rgba(255,255,255,.25);padding:8px 12px;border-radius:10px}
    main{flex:1;padding:30px 20px;max-width:var(--maxWidth);margin:0 auto 80px}
    .shop-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:22px}
    .item{background:var(--card);padding:16px;border-radius:14px;box-shadow:var(--shadow);text-align:center;position:relative}
    .item img{width:100%;height:220px;object-fit:contain;border-radius:8px;background:#f6f6f6}
    



    .item h3{margin:10px 0 6px;font-size:16px}
    .price{font-weight:700;color:var(--brand-orange-dark);margin-bottom:8px}
    select{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px}

    /* carousel */
    .carousel { position: relative; overflow: hidden; border-radius: 12px; background:#f6f6f6; }
    .carousel img { width:100%; height:220px; object-fit:contain; display:none; transition:opacity .25s ease; }
    .carousel img.active { display:block; }
    .carousel button { position:absolute; top:50%; transform:translateY(-50%); background:rgba(255,255,255,0.85); border:none; border-radius:999px; width:34px; height:34px; cursor:pointer; font-size:18px; color:#333; display:flex; align-items:center; justify-content:center; }
    .carousel .prev-btn{ left:8px } .carousel .next-btn{ right:8px }
    .carousel button:hover{ background:var(--brand-orange); color:#fff }

    /* --- GLOBAL Z-INDEX & CLICK FIX --- */

/* Overlay must never block anything unless active */
#modalOverlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1800;
  pointer-events: none !important;
}

#modalOverlay.active {
  display: block;
  pointer-events: auto !important;
}

/* Header & navigation always clickable */
header, .nav-container, .nav-actions, .nav-actions button {
  position: relative;
  z-index: 3000;
  pointer-events: auto !important;
}
    
.profile-container {
  position: relative; /* keep dropdown positioned relative to the Profile button */
}
    
/* === USER PROFILE DROPDOWN (Modern Glassy Style) === */
#profileSection {
  display: none;
  position: fixed;
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  color: #fff;
  padding: 1rem 1.2rem;
  border-radius: 1rem;
  box-shadow: 0 4px 25px rgba(0,0,0,0.3);
  min-width: 240px;
  border: 1px solid rgba(255,255,255,0.2);
  z-index: 3100;
  animation: fadeSlideDown 0.25s ease;
}

@keyframes fadeSlideDown {
  from {
    opacity: 0;
    transform: translateY(-5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#profileSection h3 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: #fff;
}

#profileSection button {
  width: 100%;
  background: rgba(255, 255, 255, 0.2);
  color: #fff;
  border: none;
  padding: 0.6rem 0.8rem;
  border-radius: 0.6rem;
  cursor: pointer;
  margin-top: 6px;
  transition: background 0.25s ease, color 0.25s ease;
}

#profileSection button:hover {
  background: #ff7a00;
  color: #fff;
}

/* üîª Disconnect button special color */
#profileSection button.disconnect {
  background: linear-gradient(135deg, #ff7043, #ff5252);
}

#profileSection button.disconnect:hover {
  background: linear-gradient(135deg, #ff8a65, #ff5252);
  transform: translateY(-2px);
}

    

/* Shop dropdown, modals, and toasts also stay clickable */
#shopMenu,
.cart-modal,
.sizeguide-modal,
#toastContainer {
  pointer-events: auto !important;
}
  

/* === BACKGROUND BLUR (only background, not content) === */
#blurOverlay {
  position: fixed;
  inset: 0;
  backdrop-filter: blur(10px) brightness(0.6);
  background: rgba(0, 0, 0, 0.25);
  z-index: 50; /* LOW ‚Üí sits behind everything else */
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

/* When blur active */
body.blur-bg #blurOverlay {
  opacity: 1;
  pointer-events: auto;
}

/* Make sure all key UI layers stay above blur */
header,
#shippingNotice,
main,
footer,
#profileSection,
.cart-modal,
.sizeguide-modal,
#shopMenu,
#toastContainer {
  position: relative;
  z-index: 200;
}





    .sizeguide-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:3000;background:rgba(0,0,0,0.5)}
    .sizeguide-modal.open{display:flex}
    .sizeguide-modal .card{background:#fff;padding:12px;border-radius:12px;max-width:720px;width:92%;position:relative}
    .sizeguide-modal img{max-width:100%;height:auto;display:block;border-radius:8px}
    #itemModalContent img {
  max-width: 90vw;
  max-height: 80vh;
  width: auto;
  height: auto;
  display: block;
  margin: 0 auto;
  border-radius: 12px;
  object-fit: contain;
}

    .sizeguide-modal .close-btn{position:absolute;right:12px;top:12px;background:transparent;border:none;font-size:20px;cursor:pointer}

    .item-modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 3000;
  background: rgba(0,0,0,0.5);
}

.item-modal.open {
  display: flex;
}

.item-modal .card {
  background: #fff;
  padding: 16px;
  border-radius: 12px;
  max-width: 700px;
  width: 92%;
  position: relative;
  box-shadow: 0 6px 24px rgba(0,0,0,0.2);
  animation: fadeIn 0.25s ease;
}

.item-modal .close-btn {
  position: absolute;
  right: 12px;
  top: 12px;
  background: transparent;
  border: none;
  font-size: 20px;
  cursor: pointer;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.96); }
  to { opacity: 1; transform: scale(1); }
}


    .cart-modal {   position: fixed;   right: 0;   top: 0;   height: 100vh;   width: 420px;   background: var(--card);   box-shadow: -12px 0 40px rgba(0,0,0,0.12);   transform: translateX(110%);   transition: transform 0.28s ease;   z-index: 3000 !important;   padding: 18px;   display: flex;   flex-direction: column; }
    .cart-modal.open{transform:translateX(0); z-index: 3000 !important;}
    .cart-modal .close-x{position:absolute;right:12px;top:8px;background:transparent;border:none;font-size:20px;cursor:pointer}
    .cart-list{flex:1;overflow:auto;margin-bottom:12px}
    .cart-item{display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid #f1f1f1}
    .cart-item img{width:64px;height:64px;object-fit:contain;border-radius:6px;background:#f6f6f6}


    .image-slider {
  position: relative;
  width: 100%;
  overflow: hidden;
  border-radius: 12px;
}
.image-slider img {
  width: 100%;
  display: none;
  transition: opacity 0.3s ease;
  border-radius: 12px;
}
.image-slider img.active {
  display: block;
}
.image-slider .prev,
.image-slider .next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.4);
  color: white;
  border: none;
  font-size: 20px;
  padding: 4px 10px;
  cursor: pointer;
  border-radius: 50%;
}
.image-slider .prev { left: 6px; }
.image-slider .next { right: 6px; }




    #toast-container{position:fixed;top:110px;right:12px;z-index:4000;display:flex;flex-direction:column;gap:8px}
    .toast{padding:8px 12px;border-radius:8px;color:#fff;display:flex;gap:8px;align-items:center}
    .toast.info{background:#2563eb}.toast.success{background:#059669}.toast.error{background:#ef4444}



#shopMenu {
  display: none;
  position: fixed; /* fixed so it‚Äôs independent of blur or stacking issues */
  background: var(--card);
  border-radius: 12px;
  box-shadow: var(--shadow);
  flex-direction: column;
  min-width: 180px;
  padding: 6px 0;
  z-index: 99999; /* topmost layer */
}



    .dropdown-item{padding:10px 16px;border:none;background:transparent;text-align:left;cursor:pointer;font-weight:600;transition:background .15s;color:#222;border-radius:8px}
    .dropdown-item:hover{background:var(--brand-orange);color:#fff}

    footer{background:var(--brand-orange-dark);padding:5px 0;text-align:center;color:#fff;margin-top:auto;position:relative;z-index:1000}
    footer a{margin:0 10px;color:#fff}

    /* ---------- Intro Screen ---------- */
#introScreen {
  position: fixed;
  inset: 0;
  background: url('https://quackerfriends.github.io/quackheads-assets/images/brandimages/Enter.png')
              no-repeat center center;
  background-size: cover;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 5000;
  transition: opacity 0.8s ease, visibility 0.8s ease;
}

/* Enter button style */
.enter-btn {
  font-size: 20px;
  padding: 14px 32px;
  border-radius: 999px;
  background: var(--brand-orange-dark);
  color: #fff;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: all 0.3s ease;
}
.enter-btn:hover {
  background: var(--brand-orange);
  transform: scale(1.05);
}

/* While intro is active, hide main content visually */
body.loading header,
body.loading main,
body.loading footer,
body.loading #shippingNotice,
body.loading #cartModal,
body.loading #profileSection {
  opacity: 0;
  transition: opacity 0.4s ease;
}

/* When intro removed, everything fades back */
body:not(.loading) header,
body:not(.loading) main,
body:not(.loading) footer {
  opacity: 1;
}

/* Mobile friendly adjustments */
@media(max-width:520px){
  #introScreen {
    background-position: center;
    background-size: cover;
  }
  .enter-btn {
    font-size: 18px;
    padding: 12px 26px;
  }
}


    @media(max-width:520px){#profileSection{right:12px;left:12px;width:auto}.cart-modal{width:100%}}

/* ======= RESPONSIVE LAYOUT FIXES ======= */

/* --- Tablet: 769px‚Äì1024px --- */
@media (max-width: 1024px) {
  header {
    padding: 12px 18px;
    gap: 10px;
  }

  header h1 {
    font-size: 19px;
  }

  .shop-container {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
  }

  .item img {
    height: 210px;
  }

  #profileSection {
    right: 16px;
    left: auto;
    top: 80px;
  }

  footer {
    position: relative;
    margin-top: auto;
  }
}

/* --- Mobile: up to 768px --- */
@media (max-width: 768px) {
  html, body {
    width: 100%;
    overflow-x: hidden;
    height: auto;
    display: flex;
    flex-direction: column;
  }

  header {
    flex-wrap: wrap;
    padding: 12px 16px;
    text-align: center;
    justify-content: center;
    gap: 10px;
  }

  header h1 {
    font-size: 18px;
    text-align: center;
  }

  .info-container {
    margin-top: 6px;
    font-size: 14px;
  }

  #pointsDisplay {
    order: 2;
  }

  #menuBtn, #connectBtn, #profileBtn, #openCartBtn {
    font-size: 14px;
    padding: 8px 12px;
  }

  main {
    flex: 1;
    padding: 16px 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 100%;
  }

  .shop-container {
    grid-template-columns: 1fr;
    gap: 18px;
    width: 100%;
  }

  .item {
    width: 100%;
    padding: 14px;
  }

  .item img {
    height: 200px;
  }

  #profileSection {
    position: fixed;
    right: 12px;
    left: 12px;
    top: 80px;
    width: auto;
  }

  .cart-modal {
    width: 100%;
    right: 0;
    top: 0;
    height: 100vh;
    border-radius: 0;
  }

  footer {
    position: relative;
    width: 100%;
    margin-top: auto;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 10px 0;
    text-align: center;
    font-size: 14px;
  }

  /* --- Intro Screen Fix --- */
  #introScreen {
    position: fixed;
    inset: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background-position: center;
    background-size: cover;
    z-index: 9999;
  }

  .enter-btn {
    font-size: 18px;
    padding: 12px 28px;
    border-radius: 999px;
    text-align: center;
  }

  /* Tooltip width fix */
  .tooltip-text {
    width: 180px;
    font-size: 11px;
  }

  /* Modals fit screen */
  .item-modal .card,
  .sizeguide-modal .card {
    max-width: 95%;
    padding: 12px;
  }
}

  </style>
</head>
<body>

  <div id="blurOverlay"></div>

  <!-- Intro Screen -->
<div id="introScreen">
  <button id="enterBtn" class="btn enter-btn">Enter</button>
</div>

  <!-- overlay sits directly under header/above content; pointer-events controlled by .active  <div id="tees"></div> -->
 

  <div id="shippingNotice" style="background:#fff ; color:--brand-orange;text-align:center;padding:8px 0;font-weight:600;font-size:14px;">
    ‚ö†Ô∏è Note: Shipping is only available in the US and Canada.
  </div>

  <header>
  <h1>
    <img 
    
      src="https://quackerfriends.github.io/quackheads-assets/images/brandimages/logo%20transparent%20zoomed.png" 
      alt="Quacker Friends Logo" 
      class="logo"
    />
    Quacker Friends Shop
  </h1>
    <div style="display:flex;gap:10px;align-items:center">
      <div class="shop-controls" style="position:relative">
        <button class="btn secondary" id="menuBtn">Shop ‚ñæ</button>
        <div id="shopMenu">      
          <button class="dropdown-item" onclick="showCategory('tees')">Tees</button>        
          <button class="dropdown-item" onclick="showCategory('miniplushies')">Mini Plushies</button>     
          <button class="dropdown-item" onclick="showCategory('plushies')">Plushies</button>           
          <button class="dropdown-item" onclick="showCategory('tapestry')">Tapestry</button>       
          <button class="dropdown-item" onclick="showCategory('keychains')">Keychains</button>      
        </div>
      </div>
      
   <div id="pointsDisplay" class="info-container">
  <i class="fa-solid fa-circle-info info-icon"></i>
  <span class="tooltip-text">
    Earn points for items your friends buy using your address as referral. Redeem points for items in our shop!  </span>
 <span class="points-label">Referral Points: <span id="pointsValue"></span></span>
</div>


      <button id="connectBtn" class="btn">Connect Wallet</button>
<div class="profile-container" style="position:relative; display:inline-block;">
  <button id="profileBtn" class="btn secondary" style="display:none">Profile</button>
</div>
      <button id="openCartBtn" class="btn" style="position:relative">Cart <span id="cartCount" class="cart-count" style="display:none">0</span></button>
    </div>
  </header>

  <div id="toast-container"></div>

  <!-- Profile Panel -->
  <div id="profileSection" aria-hidden="true">
    <h3>User Profile</h3>
    <p id="walletAddr" style="font-size:13px;color:#333">Not connected</p>
    <p id="nftCount">NFTs Owned: ...</p>
    <p id="quacksCount">Daily Quacks: 0</p>
    <div style="margin-top:10px">
      <button id="claimQuacksBtn" class="btn">ü¶Ü Collect Daily Quacks</button>
    </div>
    <hr>
    <!-- My Orders Section -->
<div id="myOrdersSection" style="margin-top:15px;">
  <h4>üì¶ My Orders</h4>
  <button id="loadOrdersBtn" class="btn secondary" onclick="loadOrderHistory()">View My Orders</button>
  <div id="orderList" style="margin-top:10px;font-size:13px;"></div>
</div>
    <button class="btn secondary" onclick="switchWallet()">üîÑ Switch Wallet</button>
    <button class="btn secondary" onclick="disconnectWallet()">‚ùå Disconnect</button>
  </div>

  <main id="mainContent" style="max-width:var(--maxWidth);margin:20px auto;padding:0 16px;width:100%">
    <section id="items" class="shop-container"></section>
  </main>

 <!-- Cart Modal -->
<div id="cartModal" class="cart-modal" aria-hidden="true">
  <button class="close-x" title="Close cart" onclick="closeCart()">‚úï</button>
  <h3>Your Cart</h3>
  <div style="font-size:13px;color:#c0392b;margin-bottom:8px;">Shipping only available in the US and Canada</div>

  <div class="cart-list" id="cartList"></div>

   <div style="margin-top:10px;">
      <label for="shippingCountry" style="font-weight:bold;">Shipping Country:</label><br>
      <select id="shippingCountry" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;margin-top:6px;">
        <option value="USA">United States</option>
        <option value="Canada">Canada</option>
      </select>
    </div>

  <div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Subtotal</strong>
      <strong id="subtotalDisplay">$0.00</strong>
    </div>
    
    


    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Shipping</strong>
      <strong id="shippingDisplay">$0.00</strong>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Total</strong>
      <strong id="totalDisplay">$0.00</strong>
    </div>

    <div id="addressSection" style="margin-top:12px;">
      <label for="userAddressInput" style="font-weight:bold;">Shipping Address:</label><br>
      <textarea id="userAddressInput" placeholder="Enter your full shipping address"
        style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;min-height:70px;"></textarea>
    </div>

   
 <!--  <div style="margin-top:10px;">
      <label for="paymentSelector" style="font-weight:bold;">Pay with:</label><br>
      <select id="paymentSelector" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;margin-top:6px;">
        <option value="eth">ETH (wallet)</option>
        <option value="points">Points / Redeem</option>
        <option value="quacks">Quacks</option>
      </select>
    </div>  -->

    <div id="referralSection" style="margin-top:12px;">
      <label for="referrerInput" style="font-weight:bold;">Referral Address (optional):</label><br>
      <input
        type="text"
        id="referrerInput"
        placeholder="Enter a friend‚Äôs wallet address"
        style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"
      />
    </div>

    <button id="checkoutBtn" class="btn" style="width:100%;margin-top:12px">Checkout (Pay / Redeem)</button>

    <div style="margin-top:8px;font-size:12px;color:#666;text-align:center">Network: Base Mainnet</div>
  </div>
</div>

  
 <!-- Size guide modal -->
  <div id="sizeGuideModal" class="sizeguide-modal" aria-hidden="true">
    <div class="card">
      <button class="close-btn" onclick="closeSizeGuide()">‚úï</button>
      <img id="sizeGuideImage" src="" alt="Size guide" />
    </div>
  </div>
  
  <footer>
    <p>Follow Quacker Friends:</p>
    <a href="https://x.com/QuackerFriends" target="_blank"><i class="fab fa-x fa-lg"></i></a>
    <a href="https://www.tiktok.com/@quackerfriends" target="_blank"><i class="fab fa-tiktok fa-lg"></i></a>
    <a href="https://www.instagram.com/QuackerFriends" target="_blank"><i class="fab fa-instagram fa-lg"></i></a>
  </footer>


<!-- üõçÔ∏è Item Modal -->
<div id="itemModal" class="sizeguide-modal" aria-hidden="true" onclick="closeItemModal(event)">
  <div class="card" onclick="event.stopPropagation();">
    <button class="close-btn" onclick="closeItemModal()">‚úï</button>
    <div id="itemModalContent"></div>
  </div>
</div>



<script>
/* ===== CONFIG ===== */
const PURCHASE_API = "https://script.google.com/macros/s/AKfycbwZMlGQ2REZxTP1lIoWBYzc8n7l-h7C79F9u9MjDY4XIR6jKNO7ky1VXtCm3oP5RM_9qA/exec";
const CLAIM_SHEET_API = "https://script.google.com/macros/s/AKfycbzu2RjvJf8-SyRIekMh53JODYZxoPXQpjJ2aGTqIHd93HgEZpnXcVC_zxoJbJt51zqSuQ/exec";
const CONTRACT_ADDRESS = "0xa2c82bda5585c1d729e2b4f85dcc9a11ded7db4c";
const CONTRACT_ABI = [{"constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}];
const SHOP_WALLET = "0x38aF7644b120B56e2FEce98b8A9A3DE14F8Fbf1D";
const BASE_CHAIN_ID_HEX = "0x2105"; // 8453

/* ===== FORCE NETWORK TO BASE ===== */
async function ensureBaseNetwork() {
  if (!window.ethereum) {
    alert("MetaMask not detected. Please install it to continue.");
    throw new Error("No wallet detected");
  }

  const provider = new ethers.providers.Web3Provider(window.ethereum);
  const network = await provider.getNetwork();

  if (network.chainId !== 8453) { // 8453 = Base Mainnet
    try {
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: BASE_CHAIN_ID_HEX }],
      });
      console.log("‚úÖ Switched to Base network");
    } catch (switchError) {
      // Error 4902 = chain not added
      if (switchError.code === 4902) {
        try {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [{
              chainId: BASE_CHAIN_ID_HEX,
              chainName: "Base Mainnet",
              nativeCurrency: {
                name: "Ethereum",
                symbol: "ETH",
                decimals: 18
              },
              rpcUrls: ["https://mainnet.base.org"],
              blockExplorerUrls: ["https://basescan.org"]
            }]
          });
          console.log("‚úÖ Base network added and switched");
        } catch (addError) {
          console.error("Failed to add Base network:", addError);
          alert("Please switch to Base network manually in MetaMask.");
          throw addError;
        }
      } else {
        console.error("Failed to switch network:", switchError);
        alert("Please switch to Base network manually in MetaMask.");
        throw switchError;
      }
    }
  } else {
    console.log("üü¢ Already on Base network");
  }
}

/* ===== LOAD PROFILE (Web3.js version) ===== */
async function loadProfile(wallet) {
  if (!web3 || !wallet) return null;

  let quackerBalance = 0;
  try {
    const contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
    quackerBalance = await contract.methods.balanceOf(wallet).call();
  } catch (err) {
    console.warn("Failed to fetch Quacker NFT balance:", err);
  }

  let claimData = {};
  try {
    const claimResp = await fetch(`${CLAIM_SHEET_API}?wallet=${encodeURIComponent(wallet)}&check=true`);
    claimData = await claimResp.json();
  } catch (err) {
    console.warn("Failed to fetch claim data:", err);
  }

  let shopData = {};
  try {
    const shopResp = await fetch(`${PURCHASE_API}?wallet=${encodeURIComponent(wallet)}&checkPoints=true`);
    const pointsResp = await shopResp.json();
    shopData.points = pointsResp.points || 0;
  } catch (err) {
    console.warn("Failed to fetch shop/referral data:", err);
  }

  return {
    wallet,
    quackerBalance: Number(quackerBalance),
    dailyQuacks: Number(claimData.quacks_collected || 0),
    lastClaim: claimData.last_claim ? new Date(claimData.last_claim) : null,
    priority: claimData.priority || "none",
    triggeredBy: claimData.triggered_by || "none",
    referralPoints: shopData.points || 0
  };
}

/* ===== STATE ===== */
let userAddress = null;
let web3 = null;
let cart = []; let selectedCountry = "USA"; // ‚úÖ Default selection for shipping
let PRODUCTS = {};                 // will be filled by loadProducts()
let currentCategory = null;     // default (sheet categories may vary in case)
let cachedEthRate = null;
let lastRateFetch = 0;

  /* ===== BLUR MANAGER ===== */
let blurCount = 0;
function addBlur() { blurCount++; document.body.classList.add("blur-bg");}
function removeBlur() {
  blurCount = Math.max(0, blurCount - 1);
  if (blurCount === 0) document.body.classList.remove("blur-bg"); }


/* ===== UI HELPERS ===== */
function showToast(message, type="info", duration=3000){
  const container = document.getElementById("toast-container");
  if(!container) return console.warn("toast container missing");
  const el = document.createElement("div");
  el.className = "toast " + (type==="success"?"success":type==="error"?"error":"info");
  el.innerHTML = `<span>${message}</span>`;
  container.appendChild(el);
  setTimeout(()=>el.remove(), duration);
}

/* ===== PRICE HELPERS ===== */
async function getEthRate(){
  const now = Date.now();
  if(cachedEthRate && (now - lastRateFetch) < 60000) return cachedEthRate;
  try {
    const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd");
    const data = await res.json();
    cachedEthRate = (data && data.ethereum && data.ethereum.usd) ? data.ethereum.usd : 3000;
  } catch (err) {
    console.warn("CoinGecko fetch failed:", err);
    cachedEthRate = 3000;
  }
  lastRateFetch = Date.now();
  return cachedEthRate;
}
async function convertUsdToEth(usd){
  const rate = await getEthRate();
  return usd / rate;
}

function formatPrice(priceUSD, ethRate) {
  const usd = Number(priceUSD) || 0;
  if (!ethRate) return `$${usd} (‚âà... ETH)`;
  const eth = (usd / ethRate).toFixed(4);
  return `$${usd} (‚âà${eth} ETH)`;
}

function getProductUsd(p) {
  if (p.priceUSD) return p.priceUSD;
  // If variants are objects and first variant has a priceUSD, use that
  if (p.variants && Array.isArray(p.variants) && typeof p.variants[0] === "object" && p.variants[0].priceUSD) return p.variants[0].priceUSD;
  if (p.price) return Math.round(p.price * (cachedEthRate || 3000));
  return 0;
}

  /* ===== SHIPPING & PAYMENT UI HELPERS ===== */
const SHIPPING_RULES = {
  USA: { fee: 5, freeOver: 70 },
  Canada: { fee: 10, freeOver: 70 }
};

function calcSubtotalUSD() {
  // sum priceUSD (fallback to 0)
  return cart.reduce((s, ci) => s + (Number(ci.priceUSD || 0) * (ci.q || 1)), 0);
}

function getShippingCharge(country, subtotal) {
  const rule = SHIPPING_RULES[country] || SHIPPING_RULES.USA;
  return subtotal >= rule.freeOver ? 0 : rule.fee;
}

function updateCheckoutDisplay() {
  const country = document.getElementById("shippingCountry")?.value || "USA";
  const subtotal = calcSubtotalUSD();
  const shipping = getShippingCharge(country, subtotal);
  const total = subtotal + shipping;

  const subtotalEl = document.getElementById("subtotalDisplay");
  const shippingEl = document.getElementById("shippingDisplay");
  const totalEl = document.getElementById("totalDisplay");

  if (subtotalEl) subtotalEl.innerText = `$${subtotal.toFixed(2)}`;
  if (shippingEl) shippingEl.innerText = `$${shipping.toFixed(2)}`;
  if (totalEl) totalEl.innerText = `$${total.toFixed(2)}`;
}
  // refresh checkout numbers only if elements exist
if (document.getElementById("subtotalDisplay")) {
  updateCheckoutDisplay();
}


function initCheckoutUI() {
  const countrySel = document.getElementById("shippingCountry");
  const paymentSel = document.getElementById("paymentSelector");

  if (countrySel) countrySel.addEventListener("change", updateCheckoutDisplay);
  if (paymentSel) paymentSel.addEventListener("change", updateCheckoutDisplay);

  // update now
  updateCheckoutDisplay();
}


/* ===== LOAD PRODUCTS FROM SHEET ===== */
async function loadProducts() {
  try {
    const res = await fetch(`${PURCHASE_API}?action=getItems`);
    const data = await res.json();

    if (data.success && Array.isArray(data.items)) {
      PRODUCTS = data.items.reduce((acc, item) => {
        const rawCat = (item.Category || "Other").trim();
        const category = rawCat || "Other";
        if (!acc[category]) acc[category] = [];

        const variantsFromSheet = item.VariantOptions
          ? item.VariantOptions.toString().split(",").map(v => v.trim()).filter(Boolean)
          : [];

        const colorsFromSheet = item.ColorOptions
          ? item.ColorOptions.toString().split(",").map(c => c.trim()).filter(Boolean)
          : [];

        const sizesFromSheet = item.SizeOptions
          ? item.SizeOptions.toString().split(",").map(s => s.trim()).filter(Boolean)
          : [];

        // --- Create product object ---
        const product = {
          id: String(item.ID || "").trim(),
          title: item.Title || "",
          description: item.Description || "",
          priceUSD: item.PriceUSD ? Number(item.PriceUSD) : 0,
          quacksCost: item.QuacksCost || 0,
          pointsCost: item.PointsCost ? Number(item.PointsCost) : null,
          variants: variantsFromSheet,
          colors: colorsFromSheet,
          sizes: sizesFromSheet,
          sizeGuide: item.SizeGuide || "",
          image: item.ImageURL ? String(item.ImageURL).trim() : "",
          active: item.Active === true || String(item.Active).toUpperCase() === "TRUE",
          CustomInput: item.CustomInput || "",
          VariantPrices: item.VariantPrices || "" // ‚úÖ add from sheet
        };

        
        // --- Normalize images as array ---
if (product.image) {
  if (product.image.includes(",") || product.image.includes("|")) {
    product.images = product.image.split(/[,|]/).map(u => u.trim()).filter(Boolean);
  } else {
    product.images = [product.image];
  }
} else {
  product.images = ["https://quackerfriends.github.io/quackheads-assets/images/placeholder.png"];
}

        // --- Parse VariantPrices into usable map ---
        if (product.VariantPrices && typeof product.VariantPrices === "string") {
          const map = {};
          product.VariantPrices.split(",").forEach(vp => {
            const [name, price] = vp.split(":");
            if (name && price) map[name.trim()] = Number(price.trim());
          });
          product.variantPricesMap = map; // ‚úÖ ready-to-use parsed object
        }

        acc[category].push(product);
        return acc;
      }, {});

      console.log("‚úÖ Loaded products from sheet:", PRODUCTS);

      // --- Build shop menu ---
      const shopMenu = document.getElementById("shopMenu");
      if (shopMenu) {
        shopMenu.innerHTML = Object.keys(PRODUCTS)
          .map(cat => `<button class="dropdown-item" onclick="showCategory('${cat}')">${cat}</button>`)
          .join("");
      }

      // --- Don't auto-load anything at start ---
      if (!currentCategory) {
        const itemsSection = document.getElementById("items");
        itemsSection.innerHTML = null;
      } else {
        await showCategory(currentCategory);
        attachZoomFollow();
      }

    } else {
      console.error("‚ö†Ô∏è Failed to load items or items missing:", data);
    }
  } catch (err) {
    console.error("‚ùå Error fetching items:", err);
  }
}

/* ===== RENDER PRODUCT CARD (with Quacks + Points + USD) ===== */
function renderProductCard(p, ethRate) {
  // Normalize IDs and prices
  const productId = p.ID || p.id;
  const priceUSD = p.PriceUSD || p.priceUSD || p.price || 0;
  const pointsCost = p.PointsCost || p.pointsCost || 0;
  const quacksCost = p.QuacksCost || p.quacksCost || 0;

  const priceDisplay = [];
  if (priceUSD > 0) priceDisplay.push(`$${priceUSD}`);
  if (quacksCost > 0) priceDisplay.push(`ü™ô ${quacksCost} Quacks`);
  if (pointsCost > 0) priceDisplay.push(`‚≠ê ${pointsCost} Points`);
  
  const priceHTML = priceDisplay.join(" | ");

  // Variants
  let variantHTML = "";
  if (p.VariantOptions || p.variants) {
    const variants = (p.VariantOptions ? p.VariantOptions.split(",") : p.variants).map(v => v.trim());
    if (variants.length) {
      variantHTML = `<label>Variant:</label>
        <select id="variant_${productId}">
          ${variants.map(v => `<option value="${v}">${v}</option>`).join("")}
        </select>`;
    }
  }

  // Colors
  let colorHTML = "";
  if (p.ColorOptions || p.colors) {
    const colors = (p.ColorOptions ? p.ColorOptions.split(",") : p.colors).map(c => c.trim());
    if (colors.length) {
      colorHTML = `<label>Color:</label>
        <select id="color_${productId}">
          ${colors.map(c => `<option value="${c}">${c}</option>`).join("")}
        </select>`;
    }
  }

  // Sizes
  let sizeHTML = "";
  if (p.SizeOptions || p.sizes) {
    const sizes = (p.SizeOptions ? p.SizeOptions.split(",") : p.sizes).map(s => s.trim());
    if (sizes.length) {
      sizeHTML = `<label>Size:</label>
        <select id="size_${productId}">
          ${sizes.map(s => `<option value="${s}">${s}</option>`).join("")}
        </select>`;
    }
  }

  // Custom input
  let customHTML = "";
  if (p.CustomInput && p.CustomInput.trim() !== "") {
    customHTML = `<div>
      <label for="custom_${productId}">${p.CustomInput}</label>
      <input id="custom_${productId}" type="text" placeholder="${p.CustomInput}" />
    </div>`;
  }

  // Buttons
  const buyHTML = priceUSD > 0
    ? `<button class="btn buy-btn" onclick="addToCart('${productId}')">Add to Cart</button>`
    : "";

  const quacksHTML = quacksCost > 0
    ? `<button class="btn quacks-btn" onclick="addToCartWithQuacks('${productId}', ${quacksCost})">
         Pay with ${quacksCost} ü™ô Quacks
       </button>` : "";

  const redeemHTML = pointsCost > 0
    ? `<button class="btn redeem-btn" onclick="redeemWithPoints('${productId}', ${pointsCost})">
         Redeem for ${pointsCost} ‚≠ê Referral Points
       </button>` : "";

  // Card HTML
  const html = `
    <div class="item" style="padding:16px;border-radius:12px;box-shadow:var(--shadow);background:var(--card);">
      <img src="${p.ImageURL || p.image || ""}" alt="${p.Title || p.title}" style="width:100%;border-radius:8px;object-fit:contain;" />
      <h3>${p.Title || p.title}</h3>
      <p id="price_${productId}" style="margin:6px 0;">${priceHTML}</p>
      ${variantHTML}
      ${colorHTML}
      ${sizeHTML}
      ${customHTML}
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        ${buyHTML}
        ${quacksHTML}
        ${redeemHTML}
      </div>
    </div>
  `;
  return html;
}

 

/* ===== RENDER CATEGORY (with image carousel) ===== */
async function showCategory(cat) {
  
  // üß† If clicking the same category again ‚Üí close it
  if (currentCategory === cat) {
    const itemsSection = document.getElementById("items");
    itemsSection.innerHTML = null;
    currentCategory = null;

    // üîπ Remove blur
    removeBlur();
    return;
  }

  // üîπ Apply blur when new category opens
addBlur();

  const key = (cat in PRODUCTS)
    ? cat
    : Object.keys(PRODUCTS).find(k => k.toLowerCase() === String(cat).toLowerCase());
  if (key) currentCategory = key;
  else currentCategory = cat;

  const container = document.getElementById("items");
  const items = PRODUCTS[currentCategory] || [];
  container.innerHTML = "";
  if (!items.length) {
    container.innerHTML = `
      <div style="background:var(--card);padding:20px;border-radius:12px;
                  box-shadow:0 8px 20px rgba(12,12,20,0.06);">
      </div>`;
    return;
  }

  const ethRate = await getEthRate();
  items.forEach(p => {
    const el = document.createElement("div");
    el.className = "item";

    const priceDisplay = formatPrice(getProductUsd(p), ethRate);

   // üñºÔ∏è Normalize images array
  let images = [];
  if (Array.isArray(p.images) && p.images.length) {
    images = p.images;
  } else if (typeof p.image === "string" && p.image.includes(",")) {
    images = p.image.split(",").map(u => u.trim()).filter(Boolean);
  } else if (p.image) {
    images = [p.image];
  }

    // --- Build slider / single image HTML ---
  let imageHTML = "";
  if (images.length > 1) {
    imageHTML = `
      <div class="image-slider" id="slider_${p.id}">
        ${images.map((url, i) => `
          <img 
            src="${url}" 
            alt="${p.title}" 
            class="slide ${i === 0 ? "active" : ""}" 
            style="cursor:pointer"
            onclick="openItemModal(\`
              <img src='${url}' alt='${p.title}' style='max-width:100%;border-radius:12px;display:block;margin:0 auto;' />
              <h3 style='margin-top:12px;text-align:center;'>${p.title}</h3>
            \`)"
          />
        `).join("")}
        <button class="prev" onclick="prevSlide('${p.id}')">‚Äπ</button>
        <button class="next" onclick="nextSlide('${p.id}')">‚Ä∫</button>
      </div>
    `;
  } else {
    const imgSrc = images[0] || "https://quackerfriends.github.io/quackheads-assets/images/placeholder.png";
    imageHTML = `
      <img 
        src="${imgSrc}" 
        alt="${p.title}" 
        style="cursor:pointer"
        onclick="openItemModal(\`
          <img src='${imgSrc}' alt='${p.title}' style='max-width:100%;border-radius:12px;display:block;margin:0 auto;' />
          <h3 style='margin-top:12px;text-align:center;'>${p.title}</h3>
        \`)"
      />
    `;
  }


    // üß© Variants
    let variantHTML = "";
    if (p.variants && p.variants.length) {
      if (typeof p.variants[0] === "string") {
        variantHTML = `
          <label>Variant</label>
          <select id="variant_${p.id}">
            ${p.variants.map(v => `<option value="${v}">${v}</option>`).join("")}
          </select>`;
      } else if (typeof p.variants[0] === "object") {
        variantHTML = `
          <label>Variant</label>
          <select id="variant_${p.id}">
            ${p.variants
              .map(v => `<option value="${v.name}" data-price-usd="${v.priceUSD ?? ''}">${v.name}</option>`)
              .join("")}
          </select>`;
      }
    }

    // üé® Colors
    let colorHTML = "";
    if (p.colors && p.colors.length) {
      colorHTML = `
        <label>Color</label>
        <select id="color_${p.id}">
          ${p.colors.map(c => `<option value="${c}">${c}</option>`).join("")}
        </select>`;
    }

    // üìè Sizes
    let sizeHTML = "";
    if (p.sizes && p.sizes.length) {
      sizeHTML = `
        <label>Size</label>
        <select id="size_${p.id}">
          ${p.sizes.map(s => `<option value="${s}">${s}</option>`).join("")}
        </select>`;
    }

    let customInputHTML = "";
if (p.CustomInput && p.CustomInput.trim() !== "") {
  customInputHTML = `
    <label style="display:block;text-align:left;font-weight:600">${p.CustomInput}</label>
    <input id="custom_${p.id}" type="text" placeholder="${p.CustomInput}" 
      style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;margin-top:4px" />
  `;
}

// üõí Generate product buttons safely
const productId = p.ID || p.id; // normalize ID
if (!productId) {
  console.warn("Product missing ID:", p);
}

// Costs
const points = p.PointsCost || p.pointsCost || 0;
const quacks = p.QuacksCost || p.quacksCost || p.quackscost || 0;
const usd = p.PriceUSD || p.priceUSD || 0;

// Redeem button
const redeemHTML = (points > 0 && productId)
  ? `<button class="btn redeem-btn" onclick="redeemWithPoints('${productId}', ${points})">
       Redeem for ${points} Referral Points
     </button>`
  : "";

// Quacks button
const quacksHTML = (quacks > 0 && productId)
  ? `<button class="btn quacks-btn" onclick="addToCartWithQuacks('${productId}', ${quacks})">
       Pay with ${quacks} ü™ô Quacks
     </button>`
  : "";

// USD purchase button
const buyHTML = (usd > 0 && productId)
  ? `<button class="btn buy-btn" onclick="addToCart('${productId}')">
       Add to Cart
     </button>`
  : "";

// Combine all HTML
el.innerHTML = `
  ${imageHTML}
  <h3>${p.title}</h3>
  <div class="price" id="price_${productId}">${priceDisplay}</div>
  ${variantHTML}
  ${colorHTML}
  ${sizeHTML}
  ${customInputHTML}
  ${p.sizeGuide ? `<button class="btn" onclick="openSizeGuide('${p.sizeGuide}')">Size Guide</button>` : ""}
  <div style="margin-top:12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
    ${buyHTML}
    ${quacksHTML}
    ${redeemHTML}
  </div>
`;

container.appendChild(el);


    // update price/image on variant select
    const variantSelect = el.querySelector(`#variant_${p.id}`);
    const priceEl = el.querySelector(`#price_${p.id}`);
    const imgEl = el.querySelector(`#img_${p.id}`);

    if (variantSelect) {
  variantSelect.addEventListener("change", async (e) => {
    const selected = e.target.value;
    const rate = await getEthRate();

    let newUsd = getProductUsd(p);

    // Case 1: variant objects with their own priceUSD
    if (Array.isArray(p.variants) && typeof p.variants[0] === "object") {
      const matched = p.variants.find(v => v.name === selected);
      if (matched?.priceUSD) newUsd = matched.priceUSD;
      if (matched?.images?.length && imgEl) imgEl.src = matched.images[0];
    }

    // Case 2: sheet variant + VariantPrices string
    else if (p.VariantPrices) {
      const variantPricesMap = {};
      p.VariantPrices.split(",").forEach(vp => {
        const [name, price] = vp.split(":");
        if (name && price) variantPricesMap[name.trim()] = Number(price.trim());
      });
      if (variantPricesMap[selected] != null) newUsd = variantPricesMap[selected];
    }

    if (priceEl) priceEl.textContent = formatPrice(newUsd, rate);
  });
}

  });

  attachZoomFollow();
}

  setTimeout(() => {
  document.querySelectorAll('.variant-select').forEach(sel => {
    sel.addEventListener('change', async e => {
      const productId = e.target.id.replace('variant_', '');
      const selected = e.target.value;
      const product = Object.values(PRODUCTS).flat().find(p => p.id === productId);
      console.log("üü° Variant changed:", { productId, selected, product });

      if (!product) return;
      const ethRate = await getEthRate();

      let newPrice = product.priceUSD || 0;

      if (product.VariantPrices) {
        const map = {};
        product.VariantPrices.split(",").forEach(vp => {
          const [name, price] = vp.split(":");
          if (name && price) map[name.trim()] = Number(price.trim());
        });

        console.log("üü¢ VariantPrices map:", map);

        if (map[selected] != null) newPrice = map[selected];
      }

      const priceEl = document.getElementById(`price_${productId}`);
      console.log("üîµ Updating price element:", priceEl, "‚Üí", newPrice);

      if (priceEl) priceEl.textContent = formatPrice(newPrice, ethRate);
    });
  });
}, 1000); // <-- wait a sec so elements exist

  
// === Variant change listener (updates displayed price) ===
document.querySelectorAll('.variant-select').forEach(sel => {
  sel.addEventListener('change', async e => {
    const productId = e.target.id.replace('variant_', '');
    const selected = e.target.value;
    const product = Object.values(PRODUCTS).flat().find(p => p.id === productId);
    if (!product) return;

    const ethRate = await getEthRate();

    let newPrice = product.priceUSD || 0;
    if (product.VariantPrices) {
      const map = {};
      product.VariantPrices.split(",").forEach(vp => {
        const [name, price] = vp.split(":");
        if (name && price) map[name.trim()] = Number(price.trim());
      });
      if (map[selected] != null) newPrice = map[selected];
    }

    const priceEl = document.getElementById(`price_${productId}`);
    if (priceEl) priceEl.textContent = formatPrice(newPrice, ethRate);
  });
});

  /* ===== UPDATE PRICE ON VARIANT CHANGE ===== */
function attachVariantPriceListeners() {
  Object.values(PRODUCTS).flat().forEach(product => {
    const selectEl = document.getElementById(`variant_${product.id}`);
    if (selectEl && product.VariantPrices) {
      const variantPrices = {};
      product.VariantPrices.split(",").forEach(vp => {
        const [name, price] = vp.split(":");
        if (name && price) variantPrices[name.trim()] = Number(price.trim());
      });

      selectEl.addEventListener("change", async function() {
        const selectedVariant = selectEl.value;
        const newPriceUSD = variantPrices[selectedVariant] != null
          ? variantPrices[selectedVariant]
          : product.priceUSD || 0;
        const ethRate = await getEthRate();
        const priceTextEl = selectEl.closest(".item").querySelector("p");
        if (priceTextEl) priceTextEl.textContent = formatPrice(newPriceUSD, ethRate);
      });
    }
  });
}

/* ===== SLIDER FUNCTIONS ===== */
function nextSlide(id) {
  const slides = document.querySelectorAll(`#slider_${id} .slide`);
  if (!slides.length) return;
  let current = Array.from(slides).findIndex(s => s.classList.contains("active"));
  slides[current].classList.remove("active");
  const next = (current + 1) % slides.length;
  slides[next].classList.add("active");
}

function prevSlide(id) {
  const slides = document.querySelectorAll(`#slider_${id} .slide`);
  if (!slides.length) return;
  let current = Array.from(slides).findIndex(s => s.classList.contains("active"));
  slides[current].classList.remove("active");
  const prev = (current - 1 + slides.length) % slides.length;
  slides[prev].classList.add("active");
}

/* ===== OPEN/CLOSE Helpers ===== */
function showOverlay(){ const ov = document.getElementById('tees'); if(ov){ ov.classList.add('active'); ov.style.display='block'; } }
function hideOverlay(){ const ov = document.getElementById('tees'); if(ov){ ov.classList.remove('active'); ov.style.display='none'; } }

/* ===== SIZE GUIDE ===== */
function openSizeGuide(url){
  const modal = document.getElementById("sizeGuideModal");
  if(modal) document.getElementById("sizeGuideImage").src = url;
  if(modal){ modal.classList.add("open"); modal.setAttribute("aria-hidden","false"); }
}
function closeSizeGuide(){ const modal = document.getElementById("sizeGuideModal"); if(modal){ modal.classList.remove("open"); modal.setAttribute("aria-hidden","true"); } }

  /* ===== open images in items  ===== */
  function openItemModal(contentHTML) {
  const modal = document.getElementById("itemModal");
  const content = document.getElementById("itemModalContent");

  content.innerHTML = contentHTML;
  modal.classList.add("open");
  addBlur(); // blur the background
}

function closeItemModal(e) {
  // If called from click event, ensure we clicked background, not content
  if (e && e.target.closest('.card')) return;

  const modal = document.getElementById("itemModal");
  modal.classList.remove("open");
  removeBlur();
}

/* ===== ADD TO CART ===== */
async function addToCart(productId) {
 const allProducts = Object.values(PRODUCTS).flat();
const product = allProducts.find(p =>
  (p.ID && p.ID === productId) ||
  (p.id && p.id === productId)
);

if (!product) {
  console.error("Product not found:", productId, "Available IDs:", allProducts.map(p => p.ID || p.id));
  showToast("Product not found", "error");
  return;
}


  const variantSel = document.getElementById(`variant_${productId}`);
  const colorSel = document.getElementById(`color_${productId}`);
  const sizeSel = document.getElementById(`size_${productId}`);
  const customEl = document.getElementById(`custom_${productId}`);
  const priceEl = document.getElementById(`price_${productId}`);

  const variant = variantSel ? variantSel.value : "";
  const color = colorSel ? colorSel.value : "";
  const size = sizeSel ? sizeSel.value : "";
  const customInput = customEl ? customEl.value.trim() : "";

  // ‚úÖ Require custom input if field exists
  if ((product.CustomInput || product.custominput) && !customInput) {
    showToast(`Please fill in: ${product.CustomInput || "custom field"}`, "error");
    if (customEl) customEl.focus();
    return;
  }

  // ‚úÖ Read displayed USD price directly from DOM
  let priceUSD = product.priceUSD || 0;
  if (priceEl) {
    const match = priceEl.innerText.match(/\$([\d.]+)/);
    if (match && match[1]) priceUSD = parseFloat(match[1]);
  }

  const rate = await getEthRate();
  const priceETH = priceUSD / rate;

  const item = {
    id: product.id,
    title: product.title,
    variant,
    color,
    size,
    q: 1,
    priceUSD,
    price: priceETH,
    redeem: false,
    cost: 0,
    thumb: (product.images && product.images.length) 
         ? product.images[0] 
         : (product.image ? product.image : "placeholder.png"),
    customInput
  };

  cart.push(item);
  updateCartUI();
  showToast(`üõí "${product.title}" added to cart`, "success");
}

/* ===== CART UI (Improved + Shipping + Subtotal) ===== */
async function updateCartUI() {
  const countEl = document.getElementById("cartCount");
  const listEl = document.getElementById("cartList");
  const subtotalEl = document.getElementById("subtotalDisplay");
  const shippingEl = document.getElementById("shippingDisplay");
  const totalEl = document.getElementById("totalDisplay");

  if (!listEl || !totalEl) return console.warn("Cart UI elements missing");

  // üßÆ Update cart count bubble if present
  const cartCount = cart.reduce((s, i) => s + i.q, 0);
  if (countEl) {
    if (cartCount > 0) {
      countEl.style.display = "inline-block";
      countEl.innerText = cartCount;
    } else {
      countEl.style.display = "none";
    }
  }

  if (cart.length === 0) {
    listEl.innerHTML = "<p style='color:#666'>Cart is empty</p>";
    if (subtotalEl) subtotalEl.innerText = "$0.00";
    if (shippingEl) shippingEl.innerText = "$0.00";
    if (totalEl) totalEl.innerText = "$0.00";
    return;
  }

  listEl.innerHTML = "";
  let totalEth = 0;

  cart.forEach((ci, idx) => {
    const row = document.createElement("div");
    row.className = "cart-item";
    
 let thumb = ci.thumb || "";

// ‚úÖ Fix double-encoded or missing image paths
if (thumb && thumb.includes("https%3A")) {
  thumb = decodeURIComponent(thumb);
}
if (!thumb.startsWith("http")) {
  thumb = "https://quackerfriends.github.io/quackheads-assets/images/" + thumb;
}
if (!thumb) {
  thumb = "https://quackerfriends.github.io/quackheads-assets/images/placeholder.png";
}


    const details = [];
    if (ci.variant && ci.variant !== "N/A") details.push(`Variant: ${ci.variant}`);
    if (ci.color && ci.color !== "N/A") details.push(`Color: ${ci.color}`);
    if (ci.size && ci.size !== "N/A") details.push(`Size: ${ci.size}`);
    if (ci.customInput) details.push(`Custom: ${ci.customInput}`);
    const detailsText = details.length ? details.join(" ‚Ä¢ ") : "No options selected";

    const priceEth = (ci.price || 0).toFixed(6);
    totalEth += (ci.price || 0) * ci.q;

    row.innerHTML = `
      <img src="${thumb}" alt="${ci.title}" />
      <div style="flex:1">
        <div style="font-weight:700">${ci.title}</div>
        <div style="font-size:13px;color:#666">${detailsText}</div>
        <div style="margin-top:6px">${priceEth} ETH</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px">
        <input class="qty" type="number" min="1" value="${ci.q}" onchange="changeQty(${idx}, this.value)" style="width:56px;padding:6px;border-radius:6px;border:1px solid #ddd;text-align:center" />
        <button style="background:transparent;border:none;color:#e11;cursor:pointer" onclick="removeFromCart(${idx})">Remove</button>
      </div>
    `;
    listEl.appendChild(row);
  });

  // üßæ Compute USD totals
  const rate = await getEthRate();
  const subtotalUSD = cart.reduce((s, i) => s + i.priceUSD * i.q, 0);

  // üöö Determine shipping cost
  const countrySelect = document.getElementById("shippingCountry");
  const selectedCountry = countrySelect ? countrySelect.value : "USA";
  const shippingUSD = subtotalUSD >= 70 ? 0 : (selectedCountry === "USA" ? 5 : 10);

  const totalUSD = subtotalUSD + shippingUSD;

  // ü™Ñ Update UI
  if (subtotalEl) subtotalEl.innerText = `$${subtotalUSD.toFixed(2)}`;
  if (shippingEl) shippingEl.innerText = `$${shippingUSD.toFixed(2)}`;
  if (totalEl) totalEl.innerText = `$${totalUSD.toFixed(2)}`;
}

// refresh checkout numbers (if modal visible)
try { updateCheckoutDisplay(); } catch(e) { /* ignore if elements missing */ }

function changeQty(index,val){ const v = Number(val)||1; cart[index].q = Math.max(1,v); updateCartUI(); }
function removeFromCart(index){ cart.splice(index,1); updateCartUI(); }

 function openCart() {
  const modal = document.getElementById("cartModal");
  const overlay = document.getElementById("cartOverlay");
  if (modal) {
    modal.classList.add("open");
    modal.setAttribute("aria-hidden", "false");
    if (overlay) overlay.style.display = "block";
    // init checkout UI (subtotal, shipping, payment selector)
    initCheckoutUI();
  }
}


function closeCart() {
  const modal = document.getElementById("cartModal");
  const overlay = document.getElementById("cartOverlay");
  if (modal) {
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden", "true");
    if (overlay) overlay.style.display = "none";
  }
}
  
  // üõí Cart open button
const openCartBtn = document.getElementById("openCartBtn");
if (openCartBtn) openCartBtn.addEventListener("click", openCart);


/* ===== WALLET & PROFILE ===== */
async function connectWallet() {
  if (!window.ethereum) {
    showToast("MetaMask not found", "error");
    return;
  }

  try {
    // ‚úÖ Step 1: Ensure Base network
    const baseParams = {
      chainId: "0x2105", // Base mainnet chain ID
      chainName: "Base Mainnet",
      nativeCurrency: { name: "Ethereum", symbol: "ETH", decimals: 18 },
      rpcUrls: ["https://mainnet.base.org"],
      blockExplorerUrls: ["https://basescan.org"]
    };

    try {
      await ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: baseParams.chainId }]
      });
    } catch (switchError) {
      if (switchError.code === 4902) {
        await ethereum.request({
          method: "wallet_addEthereumChain",
          params: [baseParams]
        });
      } else {
        console.warn("Chain switch failed:", switchError);
      }
    }

    // ‚úÖ Step 2: Connect wallet
    web3 = new Web3(window.ethereum);
    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
    userAddress = accounts[0];

    // ‚úÖ Step 3: Update UI
    const connectBtn = document.getElementById("connectBtn");
    if (connectBtn)
      connectBtn.innerText = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);

    const profileBtn = document.getElementById("profileBtn");
    if (profileBtn) profileBtn.style.display = "inline-block";

    const walletAddr = document.getElementById("walletAddr");
    if (walletAddr) walletAddr.innerText = userAddress;

    showToast("Wallet connected", "success");

    // ‚úÖ Step 4: Load profile + update points
    const profileData = await loadProfile(userAddress);

    await updatePointsDisplay();

    const nftCountEl = document.getElementById("nftCount");
    if (nftCountEl) nftCountEl.innerText = "NFTs Owned: " + profileData.quackerBalance;

    const quacksCount = document.getElementById("quacksCount");
    if (quacksCount) quacksCount.innerText = "Daily Quacks: " + profileData.dailyQuacks;

  } catch (err) {
    console.error(err);
    showToast("Connect failed", "error");
  }
}

// Connect button
const connectBtn = document.getElementById("connectBtn");
if (connectBtn) connectBtn.addEventListener("click", connectWallet);

/* ===== PROFILE TOGGLE ===== */
const profileBtn = document.getElementById("profileBtn");
if (profileBtn)
  profileBtn.addEventListener("click", async () => {
    const panel = document.getElementById("profileSection");
    if (panel) panel.style.display = panel.style.display === "block" ? "none" : "block";
    if (!userAddress) return;

    try {
      const profileData = await loadProfile(userAddress);

      const nftCountEl = document.getElementById("nftCount");
      if (nftCountEl)
        nftCountEl.innerText = "NFTs Owned: " + profileData.quackerBalance;

      const quacksCount = document.getElementById("quacksCount");
      if (quacksCount)
        quacksCount.innerText = "Daily Quacks: " + profileData.dailyQuacks;

      const pointsValue = document.getElementById("pointsValue");
      if (pointsValue)
        pointsValue.innerText = profileData.referralPoints;

    } catch (err) {
      console.error(err);
      showToast("Error loading profile", "warn");
    }
  });

/* ===== SWITCH / DISCONNECT ===== */
async function switchWallet() {
  try {
    await ethereum.request({
      method: "wallet_requestPermissions",
      params: [{ eth_accounts: {} }]
    });
    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
    userAddress = accounts[0];
    const walletAddr = document.getElementById("walletAddr");
    if (walletAddr) walletAddr.innerText = userAddress;
    showToast("Wallet switched", "success");
  } catch (err) {
    console.error(err);
  }
}

function disconnectWallet() {
  userAddress = null;
  web3 = null;
  const cbo = document.getElementById("connectBtn");
  if (cbo) cbo.innerText = "Connect Wallet";
  const profileBtn = document.getElementById("profileBtn");
  if (profileBtn) profileBtn.style.display = "none";
  const profileSection = document.getElementById("profileSection");
  if (profileSection) profileSection.style.display = "none";
  showToast("Wallet disconnected", "info");
}

/* ===== Redeem Points Display ===== */
async function updatePointsDisplay() {
  const wallet = (userAddress || "").toLowerCase();
  const pointsValue = document.getElementById("pointsValue");
  if (!pointsValue) return;

  if (!wallet) {
    pointsValue.textContent = ""; // leave empty if wallet not connected
    return;
  }

  try {
    const res = await fetch(`${PURCHASE_API}?wallet=${wallet}&checkPoints=true`);
    const data = await res.json();

    if (data.success) {
      pointsValue.textContent = data.points;
    } else {
      pointsValue.textContent = "Error";
    }
  } catch (err) {
    pointsValue.textContent = "Error";
  }
}

/* ===== CLAIM QUACKS ===== */
const claimQuacksBtn = document.getElementById("claimQuacksBtn");
if (claimQuacksBtn) claimQuacksBtn.addEventListener("click", async () => {
  if (!userAddress) {
    showToast("Connect wallet first", "warn");
    return;
  }

  try {
    const contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
    const mainNFTBalance = await contract.methods.balanceOf(userAddress).call();

    // ‚úÖ Collect all eligible NFT contracts (main + others if needed)
    const ownsContracts = [];
    if (Number(mainNFTBalance) > 0) ownsContracts.push(CONTRACT_ADDRESS);

    // Example for other collections (uncomment if needed)
    // const otherContract = new web3.eth.Contract(OTHER_ABI, OTHER_CONTRACT_ADDRESS);
    // const otherBalance = await otherContract.methods.balanceOf(userAddress).call();
    // if (Number(otherBalance) > 0) ownsContracts.push(OTHER_CONTRACT_ADDRESS);

    const query = new URLSearchParams({
      wallet: userAddress,
      claim: true,
      ownsContracts: ownsContracts.join(",")
    });

    const res = await fetch(`${CLAIM_SHEET_API}?${query.toString()}`);
    const data = await res.json();

    if (data.error) {
      showToast(data.error, "warn");
    } else {
      const claimed = data.added_quacks || 1;
      showToast(`ü¶Ü Claimed ${claimed} Quacks!`, "success");

      const quacksCountEl = document.getElementById("quacksCount");
      if (quacksCountEl) quacksCountEl.innerText = "Daily Quacks: " + (data.new_quacks_total || claimed);
    }

  } catch (err) {
    console.error(err);
    showToast("Error claiming quacks", "error");
  }
});




/* ===== CHECKOUT / PURCHASE LOGGING ===== */
const checkoutBtn = document.getElementById("checkoutBtn");
if (checkoutBtn) checkoutBtn.addEventListener("click", checkout);

async function checkout() {
  const shippingAddress = document.getElementById("userAddressInput")?.value || "";
  const referrer = document.getElementById("referrerInput")?.value?.trim() || "";

  if (!shippingAddress.trim()) {
    showToast("Please enter your shipping address before completing your purchase!", "error");
    return;
  }

  try {
    if (!window.ethereum) { showToast("MetaMask not found", "error"); return; }
    if (!userAddress) { showToast("Connect wallet first", "error"); return; }
    if (cart.length === 0) { showToast("Cart is empty", "info"); return; }

    // --- Ensure correct network ---
    try {
      const chain = await ethereum.request({ method: 'eth_chainId' });
      if (chain !== BASE_CHAIN_ID_HEX) {
        await ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_CHAIN_ID_HEX }] });
        showToast("Switched to Base mainnet", "success");
      }
    } catch (switchErr) {
      console.warn("Chain switch issue:", switchErr);
    }

    // --- Calculate subtotal in USD --- //
  //  let subtotalUSD = 0;
    // cart.forEach(ci => { subtotalUSD += Number(ci.priceUSD || 0) * (ci.q || 1); }); 

 // --- Shipping rules ---
 // --- Determine shipping ---
let country = window.selectedCountry || document.getElementById("shippingCountry")?.value || "USA";
country = country.toLowerCase();
let shippingUSD = 0;
let subtotalUSD = cart.reduce((sum, item) => sum + (item.priceUSD * (item.q || 1)), 0);

// --- Identify order types ---
const isRedeemOnly = cart.length > 0 && cart.every(ci => ci.redeem);
const isQuacksOnly = cart.length > 0 && cart.every(ci => ci.useQuacks);
const hasPaidItems = cart.some(ci => !ci.redeem && !ci.useQuacks);

// --- Force shipping for all physical goods ---
const needsShipping = cart.length > 0; // assume all items physical

// --- Apply shipping rules (TEMP: disable shipping for testing) ---
shippingUSD = 0;


// üëâ Force shipping even if subtotal is 0 (for quacks/redeem)
if ((isRedeemOnly || isQuacksOnly) && needsShipping && shippingUSD === 0) {
  if (country === "canada") {
    shippingUSD = 10;
  } else {
    shippingUSD = 5;
  }
}
console.log("üß≠ Country:", country, "| subtotalUSD =", subtotalUSD, "| Shipping =", shippingUSD);

const rate = await getEthRate();
let txHash = "";

// --- ETH Payment Handling ---
if (hasPaidItems) {
  // Normal checkout
  const grandTotalUSD = subtotalUSD + shippingUSD;
  const totalEth = grandTotalUSD / rate;
  const valueHex = "0x" + BigInt(Math.floor(totalEth * 1e18)).toString(16);
  const txParams = { from: userAddress, to: SHOP_WALLET, value: valueHex };

  try {
    showToast(`Please confirm payment (includes $${shippingUSD} shipping)`, "info", 8000);
    txHash = await ethereum.request({ method: "eth_sendTransaction", params: [txParams] });
    showToast("‚úÖ Transaction sent ‚Äî logging purchase...", "success", 4000);
    await new Promise(r => setTimeout(r, 1200));
  } catch (err) {
    console.warn("tx aborted", err);
    showToast("Transaction cancelled ‚Äî not logged", "error");
    return;
  }

} else if ((isRedeemOnly || isQuacksOnly) && shippingUSD > 0) {
  // Pay only shipping for redeem/quacks
  const shippingEth = shippingUSD / rate;
  const valueHex = "0x" + BigInt(Math.floor(shippingEth * 1e18)).toString(16);
  const txParams = { from: userAddress, to: SHOP_WALLET, value: valueHex };

  try {
    showToast(`Please confirm $${shippingUSD} shipping payment`, "info", 8000);
    txHash = await ethereum.request({ method: "eth_sendTransaction", params: [txParams] });
    showToast("‚úÖ Shipping paid ‚Äî logging order...", "success", 4000);
    await new Promise(r => setTimeout(r, 1200));
  } catch (err) {
    console.warn("Shipping tx aborted", err);
    showToast("Shipping payment cancelled ‚Äî not logged", "error");
    return;
  }

} else {
  // Free shipping
  showToast("üéÅ Free shipping applied!", "info");
}


    // --- Loop through cart items ---
    for (const ci of cart) {
      let payload = {
        wallet: userAddress,
        variant: ci.variant || "",
        color: ci.color || "",
        size: ci.size || "",
        quantity: ci.q || 1,
        address: shippingAddress,
        txHash: ci.useQuacks ? "" : txHash,
        referrer,
        customInput: ci.customInput || ""
      };

      if (ci.redeem) {
        payload.redeem = ci.title;
        payload.cost = ci.cost;
      } else if (ci.useQuacks) {
        payload.itemName = ci.title;
        payload.quacksCost = ci.quacksCost;

        // ü™ô Deduct Quacks from user sheet
        try {
          const spendRes = await fetch(`${CLAIM_SHEET_API}?wallet=${userAddress}&spend=${ci.quacksCost}`);
          const spendData = await spendRes.json();
          if (spendData.error) {
            showToast(`Quacks deduction failed: ${spendData.error}`, "error");
            return; // stop checkout if not enough Quacks
          }
          showToast(`üí∏ ${ci.quacksCost} Quacks used for "${ci.title}"!`, "success", 4000);
        } catch (quackErr) {
          console.warn("Quacks deduction error:", quackErr);
          showToast("Quacks deduction failed ‚Äî purchase not logged", "error");
          return;
        }
      } else {
        payload.itemName = ci.title;
        payload.price = Number(ci.price || 0);
      }

      // --- Log to Apps Script ---
      const params = new URLSearchParams({
        ...payload,
        action: ci.useQuacks ? "payWithQuacks" : ""
      }).toString();

      try {
        const res = await fetch(`${PURCHASE_API}?${params}`);
        const data = await res.json();
        console.log("Server response:", data);
      } catch (logErr) {
        console.warn("Logging failed for item", payload, logErr);
      }
    }

    // --- Success Toasts ---
    if (isRedeemOnly) {
      showToast("‚úÖ Redemption logged successfully!", "success", 4000);
      updatePointsDisplay();
    } else {
      showToast("‚úÖ Purchase logged successfully!", "success", 4000);
    }

    // --- Optional BaseScan link for ETH tx ---
    if (txHash) {
      const baseScanUrl = `https://basescan.org/tx/${txHash}`;
      const linkToast = document.createElement("div");
      linkToast.className = "toast success";
      linkToast.innerHTML = `‚úÖ Purchase sent ‚Äî <a href="${baseScanUrl}" target="_blank" style="color:#fff;text-decoration:underline">View on BaseScan</a>`;
      document.getElementById("toast-container").appendChild(linkToast);
      setTimeout(() => linkToast.remove(), 8000);
    }

  } catch (err) {
    console.error("checkout error", err);
    showToast("Checkout failed", "error");
  }
}

  
/* ===== ADD TO CART WITH QUACKS ===== */
async function addToCartWithQuacks(productId, quacksCost) {
  console.log("ü™ô addToCartWithQuacks called with:", productId, quacksCost);

  const wallet = (userAddress || "").toLowerCase();
  if (!wallet) {
    showToast("Connect your wallet first.", "error");
    return;
  }

  const allProducts = Object.values(PRODUCTS).flat();
  const product = allProducts.find(p =>
    ((p.ID || p.id || "").toLowerCase() === productId.toLowerCase())
  );

  if (!product) {
    console.log("Product not found:", productId, "Available IDs:", allProducts.map(p => p.ID || p.id));
    showToast("Product not found", "error");
    return;
  }

  const variantSel = document.getElementById(`variant_${productId}`);
  const colorSel = document.getElementById(`color_${productId}`);
  const sizeSel = document.getElementById(`size_${productId}`);
  const customEl = document.getElementById(`custom_${productId}`);
  const customInput = customEl ? customEl.value.trim() : "";

  if ((product.CustomInput || product.customInput) && !customInput) {
    showToast(`Please fill in: ${product.CustomInput || "custom field"}`, "error");
    if (customEl) customEl.focus();
    return;
  }

  // Check user's Quacks balance
  const res = await fetch(`${CLAIM_SHEET_API}?wallet=${wallet}`);
  const data = await res.json();
  const userRow = data.find(u => (u.address || "").toLowerCase() === wallet);
  const currentQuacks = userRow ? Number(userRow.quacks_collected || 0) : 0;

  if (currentQuacks < quacksCost) {
    showToast(`You only have ${currentQuacks} Quacks ‚Äî need ${quacksCost}.`, "error");
    return;
  }

  cart.push({
    id: productId,
    title: product.Title || product.title,
    price: 0,
    priceUSD: 0,
    q: 1,
    redeem: false,
    useQuacks: true,
    quacksCost,
    variant: variantSel ? variantSel.value : "",
    color: colorSel ? colorSel.value : "",
    size: sizeSel ? sizeSel.value : "",
    thumb: product.ImageURL || product.image || "",
    customInput
  });

  updateCartUI();
  showToast(`ü™ô "${product.Title || product.title}" added using ${quacksCost} Quacks`, "success");
  if (typeof openCart === "function") openCart();
}

/* ===== REDEEM WITH POINTS ===== */
async function redeemWithPoints(productId, cost) {
  const wallet = (userAddress || "").toLowerCase();
  if (!wallet) {
    showToast("Please connect your wallet first.", "error");
    return;
  }

  const allProducts = Object.values(PRODUCTS).flat();
  const product = allProducts.find(p =>
    ((p.ID || p.id || "").toLowerCase() === productId.toLowerCase())
  );

  if (!product) {
    console.log("Product not found:", productId, "Available IDs:", allProducts.map(p => p.ID || p.id));
    showToast("Product not found", "error");
    return;
  }

  const variantSel = document.getElementById(`variant_${productId}`);
  const colorSel = document.getElementById(`color_${productId}`);
  const sizeSel = document.getElementById(`size_${productId}`);
  const customEl = document.getElementById(`custom_${productId}`);
  const customInput = customEl ? customEl.value.trim() : "";

  if ((product.CustomInput || product.customInput) && !customInput) {
    showToast(`Please fill in: ${product.CustomInput || "custom field"}`, "error");
    if (customEl) customEl.focus();
    return;
  }

  // Check points balance from your API
  const checkRes = await fetch(`${PURCHASE_API}?wallet=${wallet}&checkPoints=true`);
  const checkData = await checkRes.json();
  const currentPoints = checkData.points || 0;

  if (currentPoints < cost) {
    showToast(`‚ùå You only have ${currentPoints} Referral Points ‚Äî need ${cost} to redeem this item.`, "error");
    return;
  }

  const alreadyInCart = cart.find(i => (i.id || i.ID).toLowerCase() === productId.toLowerCase() && i.redeem);
  if (alreadyInCart) {
    showToast("Item already added for redemption.", "info");
    return;
  }

  cart.push({
    id: productId,
    title: product.Title || product.title,
    price: 0,
    priceUSD: 0,
    q: 1,
    redeem: true,
    cost,
    variant: variantSel ? variantSel.value : "",
    color: colorSel ? colorSel.value : "",
    size: sizeSel ? sizeSel.value : "",
    thumb: product.ImageURL || product.image || "",
    customInput
  });

  updateCartUI();
  showToast(`üéâ "${product.Title || product.title}" added to cart for ${cost} Referral Points`, "success");
  if (typeof openCart === "function") openCart();
}


/* ===== MENU & overlay safety ===== */

hideOverlay();

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  // load items from sheet first (will render category when loaded)
  await loadProducts();
  

// --- shipping country listener ---
document.addEventListener("DOMContentLoaded", () => {
  const countrySelect = document.getElementById("shippingCountry");
  if (countrySelect) {
    // set global variable for selected country
    window.selectedCountry = countrySelect.value;

    countrySelect.addEventListener("change", (e) => {
      window.selectedCountry = e.target.value.trim();
      console.log("üåé Country changed to:", window.selectedCountry);
    });
  } else {
    console.warn("‚ö†Ô∏è shippingCountry select not found in DOM!");
  }
});


});

/* --- zoom follow helpers --- */
function attachZoomFollow(){
  // only adjust carousel pointer events if you need
  document.querySelectorAll('.carousel').forEach(car => {
    car.querySelectorAll('img').forEach(im => {
      if (!im.classList.contains('active')) {
        im.style.pointerEvents = 'none';
        im.style.opacity = '0';
        im.style.position = 'absolute';
      } else {
        im.style.pointerEvents = 'auto';
        im.style.opacity = '1';
        im.style.position = 'relative';
      }
    });
  });
}

   // Hide content until Enter is clicked
  document.body.classList.add('loading');

  const enterBtn = document.getElementById('enterBtn');
  const introScreen = document.getElementById('introScreen');

  enterBtn.addEventListener('click', () => {
    introScreen.style.opacity = '0';
    introScreen.style.visibility = 'hidden';
    document.body.classList.remove('loading');
    setTimeout(() => introScreen.remove(), 700);
  });

/* ===== SHOP MENU FIX (ESCAPE STACKING CONTEXT) ===== */
document.addEventListener("DOMContentLoaded", () => {
  const menuBtn = document.getElementById("menuBtn");
  const shopMenu = document.getElementById("shopMenu");

  if (!menuBtn || !shopMenu) return;

  menuBtn.addEventListener("click", (e) => {
    e.stopPropagation();

    // Move dropdown to body to avoid blur/stacking issues
    document.body.appendChild(shopMenu);

    const rect = menuBtn.getBoundingClientRect();
    shopMenu.style.position = "fixed";
    shopMenu.style.top = `${rect.bottom + 6}px`;
    shopMenu.style.left = `${rect.left}px`;
    shopMenu.style.display =
      shopMenu.style.display === "flex" ? "none" : "flex";
    shopMenu.style.zIndex = "999999";
  });

  document.addEventListener("click", (e) => {
    if (!menuBtn.contains(e.target) && !shopMenu.contains(e.target)) {
      shopMenu.style.display = "none";
    }
  });

  shopMenu.addEventListener("click", (e) => {
    if (e.target.classList.contains("dropdown-item")) {
      shopMenu.style.display = "none";
    }
  });
});


/* ===== PROFILE DROPDOWN FIX (POSITION + ANIMATION) ===== */
document.addEventListener("DOMContentLoaded", () => {
  const profileBtn = document.getElementById("profileBtn");
  const profileSection = document.getElementById("profileSection");

  if (!profileBtn || !profileSection) return;

  profileBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    console.log("Profile button clicked");

    const isVisible = profileSection.classList.contains("show");

    if (isVisible) {
      profileSection.classList.remove("show");
      setTimeout(() => (profileSection.style.display = "none"), 200);
      return;
    }

    // Move to body so it layers above blur
    document.body.appendChild(profileSection);

    profileSection.style.display = "block";
    profileSection.style.position = "fixed";
    profileSection.style.zIndex = "999999";

    const rect = profileBtn.getBoundingClientRect();
    const dropdownWidth = profileSection.offsetWidth || 200;

    profileSection.style.top = `${rect.bottom + 6}px`;
    profileSection.style.left = `${rect.right - dropdownWidth}px`;

    requestAnimationFrame(() => {
      profileSection.classList.add("show");
    });
  });

  document.addEventListener("click", (e) => {
    if (!profileSection.contains(e.target) && e.target !== profileBtn) {
      profileSection.classList.remove("show");
      setTimeout(() => (profileSection.style.display = "none"), 200);
    }
  });
});


document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".info-container").forEach(container => {
    const icon = container.querySelector(".info-icon");
    const tooltip = container.querySelector(".tooltip-text");

    if (!icon || !tooltip) return;

    icon.addEventListener("mouseenter", () => {
      // move tooltip to body so it's not clipped by stacking context
      document.body.appendChild(tooltip);

      const rect = icon.getBoundingClientRect();
      tooltip.style.position = "fixed";
      tooltip.style.top = `${rect.bottom + 8}px`;
      tooltip.style.left = `${rect.left + rect.width / 2}px`;
      tooltip.style.transform = "translateX(-50%)";
      tooltip.style.visibility = "visible";
      tooltip.style.opacity = "1";
      tooltip.style.pointerEvents = "auto";
      tooltip.style.zIndex = "9999999";
    });

    icon.addEventListener("mouseleave", () => {
      tooltip.style.opacity = "0";
      tooltip.style.visibility = "hidden";
      tooltip.style.pointerEvents = "none";

      // return tooltip back inside its container for structure consistency
      container.appendChild(tooltip);
    });
  });
});

   const shippingMessages = [
  "üöö Free Shipping on orders above $70!",
  "üí≥ Easily Buy with Base ETH & Save Gas.",
  "ü¶Ü Collect Daily Quacks to redeem items.",
  "‚ö†Ô∏è Shipping is only available in the US and Canada."
];

let currentMsgIndex = 0;
const noticeEl = document.getElementById("shippingNotice");

if (noticeEl) {
  // Fix the height based on the first message
  noticeEl.style.minHeight = noticeEl.offsetHeight + "px";
  noticeEl.style.transition = "opacity 0.5s"; // smooth fade

  function rotateShippingNotice() {
    // Fade out
    noticeEl.style.opacity = 0;

    setTimeout(() => {
      // Change message
      currentMsgIndex = (currentMsgIndex + 1) % shippingMessages.length;
      noticeEl.textContent = shippingMessages[currentMsgIndex];

      // Fade in
      noticeEl.style.opacity = 1;
    }, 500); // fade duration matches CSS transition
  }

  // Rotate every 5 seconds
  setInterval(rotateShippingNotice, 5000);
}

  // üì¶ ORDER HISTORY LOGIC
async function loadOrderHistory() {
  const wallet = (userAddress || "").toLowerCase();
  const orderList = document.getElementById("orderList");
  if (!wallet) {
    showToast("Please connect your wallet first!", "error");
    return;
  }

  orderList.innerHTML = "<p>Loading your orders...</p>";

  try {
    const res = await fetch(`${PURCHASE_API}?action=getOrders&wallet=${wallet}`);
    const data = await res.json();

    if (!data.success) {
      orderList.innerHTML = `<p style="color:red;">Error fetching orders: ${data.error || "Unknown error"}</p>`;
      return;
    }

    const orders = data.orders || [];
    if (orders.length === 0) {
      orderList.innerHTML = "<p>No orders found.</p>";
      return;
    }

    let html = `<table style="width:100%;border-collapse:collapse;font-size:13px;">
      <tr style="background:#eee;">
        <th style="border:1px solid #ccc;padding:4px;">Item</th>
        <th style="border:1px solid #ccc;padding:4px;">Type</th>
        <th style="border:1px solid #ccc;padding:4px;">Points/Quacks</th>
        <th style="border:1px solid #ccc;padding:4px;">Date</th>
        <th style="border:1px solid #ccc;padding:4px;">Progress</th>
      </tr>`;

    orders.reverse().forEach(order => {
      const item = order["ItemName"] || order["Item"] || order["itemName"] || "Unknown";
      const type = order["Status"] || order["PaymentType"] || order["Payment"] || "Purchase";
      const points = order["PointsCost"] || order["QuacksCost"] || "‚Äî";
      const date = new Date(order["Timestamp"] || order["Date"] || "").toLocaleDateString();
      const progress = order["Progress"] || "Not Shipped";
      
  // Determine type + spent
      let type = "Purchase";
      let spent = "";

      if (o["PointsCost"] && Number(o["PointsCost"]) > 0) {
        type = "Redeem (Points)";
        spent = `${o["PointsCost"]} pts`;
      } else if (o["QuacksCost"] && Number(o["QuacksCost"]) > 0) {
        type = "Paid (Quacks)";
        spent = `${o["QuacksCost"]} ü¶Ü`;
      } else if (o["Price"] && Number(o["Price"]) > 0) {
        type = "ETH Purchase";
        spent = `$${Number(o["Price"]).toFixed(2)}`;
      } else {
        spent = "‚Äî";
      }

      html += `
        <tr>
          <td style="border:1px solid #ccc;padding:4px;">${item}</td>
          <td style="border:1px solid #ccc;padding:4px;">${type}</td>
          <td style="border:1px solid #ccc;padding:4px;">${points}</td>
          <td style="border:1px solid #ccc;padding:4px;">${date}</td>
          <td style="border:1px solid #ccc;padding:4px;">${progress}</td>
        </tr>`;
    });

    html += "</table>";
    orderList.innerHTML = html;

  } catch (err) {
    console.error("Order history error:", err);
    orderList.innerHTML = `<p style="color:red;">Error loading orders.</p>`;
  }
}

</script>
  
</body>
</html>
