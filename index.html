<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quacker Friends Shop</title>

<!-- Web3 (for utility functions) -->
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

<style>
:root{
  --brand-orange:#ff914d;
  --brand-orange-dark:#ff7b2c;
  --brand-teal:#66c7c4;
  --card:#ffffff;
  --shadow:0 8px 20px rgba(12,12,20,0.06);
  --radius:14px;
  --maxWidth:1100px;
}
*{box-sizing:border-box}
body{font-family:'Poppins',sans-serif;margin:0;padding:0;background:linear-gradient(180deg,#fbfcff,#f5f7fa);color:#222;min-height:100vh;display:flex;flex-direction:column;}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 24px;background:var(--brand-orange);color:white;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
header h1{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
.nav-menu {position:relative;display:inline-block}
.nav-menu:hover .dropdown {display:block}
.dropdown{display:none;position:absolute;top:40px;left:0;background:var(--card);color:#222;min-width:160px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.12);z-index:1000}
.dropdown a{display:block;padding:10px 14px;color:#111;text-decoration:none}
.dropdown a:hover{background:#f3f3f3}

.btn{padding:10px 16px;background:var(--brand-orange-dark);color:white;border:none;border-radius:999px;cursor:pointer;font-weight:600;transition:all .18s;display:inline-flex;gap:8px;align-items:center}
.btn.secondary{background:transparent;color:white;border:1px solid rgba(255,255,255,.25);padding:8px 12px;border-radius:10px}
.btn:active{transform:translateY(1px)}

main{flex:1;padding:30px 20px;max-width:var(--maxWidth);margin:0 auto 80px;}
#items{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:22px}
.item{background:var(--card);padding:16px;border-radius:14px;box-shadow:var(--shadow);text-align:center}
.item img{width:100%;height:220px;object-fit:contain;border-radius:8px;background:#f6f6f6}
.item h3{margin:10px 0 6px;font-size:16px}
.price{font-weight:700;color:var(--brand-orange-dark);margin-bottom:8px}
select{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px}

#profileSection{display:none;position:absolute;top:70px;right:30px;background:var(--card);border-radius:12px;width:340px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:100}
#toast-container{position:fixed;top:1rem;right:1rem;display:flex;flex-direction:column;gap:.5rem;z-index:9999}
.toast{padding:.5rem .75rem;border-radius:6px;color:#fff}
.toast.success{background:#16a34a}
.toast.error{background:#ef4444}
.toast.info{background:#3b82f6}

.cart-button { position: relative; }
.cart-count { position:absolute; top:-8px; right:-8px; background:#111;color:#fff;border-radius:999px;padding:4px 7px;font-size:12px; }

.cart-modal {
  position:fixed; right:0; top:0; height:100vh; width:420px; background:var(--card); box-shadow:-12px 0 40px rgba(0,0,0,0.12);
  transform:translateX(110%); transition:transform .28s ease; z-index:1200; padding:18px; display:flex; flex-direction:column;
}
.cart-modal.open{ transform:translateX(0); }
.cart-list{flex:1; overflow:auto; margin-bottom:12px;}
.cart-item{display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid #f1f1f1}
.cart-item img{width:64px;height:64px;object-fit:contain;border-radius:6px;background:#f6f6f6}
.qty { width:56px; padding:6px; border-radius:6px; border:1px solid #ddd; text-align:center }

.checkout-row{display:flex;justify-content:space-between;align-items:center;padding-top:10px;border-top:1px solid #eee}

@media (max-width:520px){
  header{padding:12px}
  #profileSection{right:12px;left:12px;width:auto}
  .cart-modal{width:100%}
}
</style>
</head>
<body>

<header>
  <h1>ü¶Ü Quacker Friends Shop</h1>
  <div style="display:flex;gap:10px;align-items:center">
    <div class="nav-menu">
      <button class="btn secondary">Shop ‚ñæ</button>
      <div class="dropdown" role="menu" aria-label="Shop categories">
        <a href="#" onclick="showCategory('tees');closeCart()">Tees</a>
        <a href="#" onclick="showCategory('plushies');closeCart()">Plushies</a>
        <a href="#" onclick="showCategory('tapestry');closeCart()">Tapestry</a>
      </div>
    </div>

    <button id="connectWallet" class="btn">Connect Wallet</button>
    <button id="profileButton" class="btn secondary" style="display:none">Profile</button>

    <div style="position:relative">
      <button id="openCartBtn" class="btn cart-button"><i class="fas fa-shopping-cart"></i> Cart <span id="cartCount" class="cart-count" style="display:none">0</span></button>
    </div>
  </div>
</header>

<div id="toast-container"></div>

<!-- Profile panel (keeps minimal for now) -->
<div id="profileSection">
  <h3>User Profile</h3>
  <p id="profileWallet">Not connected</p>
  <p id="profileQuacks">Daily Quacks Collected: 0</p>
  <div style="margin-top:10px">
    <button class="btn secondary" onclick="disconnectWallet()">‚ùå Disconnect</button>
  </div>
</div>

<main>
  <section id="items"></section>
</main>

<!-- Cart modal -->
<div id="cartModal" class="cart-modal" aria-hidden="true">
  <h3>Your Cart</h3>
  <div class="cart-list" id="cartList"></div>

  <div>
    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
      <strong>Total</strong>
      <strong id="cartTotal">0 ETH</strong>
    </div>

    <div class="checkout-row">
      <button id="checkoutBtn" class="btn" style="width:100%">Checkout (Pay in Base ETH)</button>
    </div>
    <div style="margin-top:8px;font-size:12px;color:#666;text-align:center">
      Network: Base Mainnet (8453)
    </div>
  </div>
</div>

<footer style="margin-top:30px;background:var(--brand-teal);padding:18px;text-align:center;color:#fff">
  <p>Follow Quacker Friends:</p>
  <a href="#" style="color:#fff;margin:0 8px"><i class="fab fa-x"></i></a>
</footer>

<script>
/* --------- CONFIG --------- */
const SHOP_WALLET = "0x38aF7644b120B56e2FEce98b8A9A3DE14F8Fbf1D";
const PURCHASE_API = "https://script.google.com/macros/s/AKfycbwZMlGQ2REZxTP1lIoWBYzc8n7l-h7C79F9u9MjDY4XIR6jKNO7ky1VXtCm3oP5RM_9qA/exec";
const BASE_CHAIN_ID_HEX = "0x2105"; // 8453 decimal

/* --------- PRODUCTS (Tees) --------- */
const PRODUCTS = {
  tees: [
    {
      id: "battle-duck",
      title: "Battle Duck Tee",
      price: 0.02,
      images: { Black: "https://files.catbox.moe/dw04zw.png", White: "https://files.catbox.moe/d6zm2s.png" },
      sizes: ["S","M","L","XL"],
      sizeGuide: "https://files.catbox.moe/41dvss.png"
    },
    {
      id: "higher-duck",
      title: "Higher Duck Tee",
      price: 0.02,
      images: { Black: "https://files.catbox.moe/qi081o.png", White: "https://files.catbox.moe/0gn3r2.png" },
      sizes: ["S","M","L","XL"],
      sizeGuide: "https://files.catbox.moe/41dvss.png"
    },
    {
      id: "sus-duck",
      title: "Sus Duck Tee",
      price: 0.02,
      images: { Black: "https://files.catbox.moe/zqtvvw.png", White: "https://files.catbox.moe/mgu7nu.png" },
      sizes: ["S","M","L","XL"],
      sizeGuide: "https://files.catbox.moe/41dvss.png"
    },
    {
      id: "this-is-fine",
      title: "This Is Fine Tee",
      price: 0.02,
      images: { Black: "https://files.catbox.moe/nbl7st.png", White: "https://files.catbox.moe/5n618u.png" },
      sizes: ["S","M","L","XL"],
      sizeGuide: "https://files.catbox.moe/41dvss.png"
    }
  ],
  plushies: [],
  tapestry: []
};

/* --------- STATE --------- */
let currentCategory = "tees";
let cart = []; // {id,title,price,color,size,q}
let userAddress = null;
let web3instance = null;

/* --------- UTILITIES --------- */
function toast(msg, type="info", t=3500){
  const container = document.getElementById("toast-container");
  const el = document.createElement("div");
  el.className = "toast " + (type==="success"?"success":type==="error"?"error":"info");
  el.innerText = msg;
  container.appendChild(el);
  setTimeout(()=>el.remove(), t);
}

function weiHexFromEth(eth){
  // use web3 if available for precise conversion
  if(window.Web3 && window.Web3.utils){
    const weiStr = Web3.utils.toWei(eth.toString(), "ether");
    return "0x" + BigInt(weiStr).toString(16);
  } else {
    const wei = BigInt(Math.floor(eth * 1e18));
    return "0x" + wei.toString(16);
  }
}

/* --------- RENDER SHOP --------- */
function showCategory(cat){
  currentCategory = cat;
  renderItems();
  closeCart();
}

function renderItems(){
  const container = document.getElementById("items");
  container.innerHTML = "";
  const items = PRODUCTS[currentCategory] || [];
  items.forEach(p=>{
    const wrap = document.createElement("div");
    wrap.className = "item";
    const imgId = "img_" + p.id;
    const colorId = "color_" + p.id;
    const sizeId = "size_" + p.id;

    wrap.innerHTML = `
      <img id="${imgId}" src="${p.images.Black}" alt="${p.title}" />
      <h3>${p.title}</h3>
      <div class="price">${p.price} ETH</div>
      <label style="display:block;text-align:left;font-weight:600;margin-top:8px">Color</label>
      <select id="${colorId}">${Object.keys(p.images).map(c=>`<option value="${c}">${c}</option>`).join("")}</select>
      <label style="display:block;text-align:left;font-weight:600">Size <a href="${p.sizeGuide}" target="_blank" style="font-size:12px;margin-left:8px">(Size Guide)</a></label>
      <select id="${sizeId}">${p.sizes.map(s=>`<option value="${s}">${s}</option>`).join("")}</select>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center;justify-content:center">
        <button class="btn" onclick="addToCart('${p.id}')">Add to cart</button>
      </div>
    `;
    container.appendChild(wrap);

    // attach image update
    const colorSelect = wrap.querySelector(`#${colorId}`);
    colorSelect.addEventListener("change", (e)=>{
      const val = e.target.value;
      wrap.querySelector(`#${imgId}`).src = p.images[val];
    });
  });
}

/* --------- CART --------- */
function updateCartUI(){
  const countEl = document.getElementById("cartCount");
  const listEl = document.getElementById("cartList");
  const totalEl = document.getElementById("cartTotal");
  const cartCount = cart.reduce((s,i)=>s+i.q,0);
  if(cartCount>0){ countEl.style.display="inline-block"; countEl.innerText = cartCount; } else countEl.style.display="none";

  listEl.innerHTML = "";
  let total = 0;
  cart.forEach((ci, idx)=>{
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `
      <img src="${ci.image}" alt="${ci.title}" />
      <div style="flex:1">
        <div style="font-weight:600">${ci.title}</div>
        <div style="font-size:13px;color:#555">${ci.color} ‚Ä¢ ${ci.size}</div>
        <div style="margin-top:6px">${ci.price} ETH</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px">
        <input class="qty" type="number" min="1" value="${ci.q}" onchange="changeQty(${idx}, this.value)" />
        <button style="background:transparent;border:none;color:#e11" onclick="removeFromCart(${idx})">Remove</button>
      </div>
    `;
    listEl.appendChild(div);
    total += ci.price * ci.q;
  });
  totalEl.innerText = total.toFixed(6) + " ETH";
}

function addToCart(prodId){
  const product = (PRODUCTS[currentCategory] || []).find(p=>p.id===prodId);
  if(!product){ toast("Product not found", "error"); return; }
  const color = document.getElementById(`color_${prodId}`).value;
  const size = document.getElementById(`size_${prodId}`).value;
  const item = {
    id: product.id,
    title: product.title,
    price: product.price,
    color,
    size,
    q: 1,
    image: product.images[color]
  };
  cart.push(item);
  toast(`${product.title} (${color}, ${size}) added to cart`, "success");
  updateCartUI();
}

function changeQty(index, val){
  const v = Number(val) || 1;
  cart[index].q = Math.max(1, v);
  updateCartUI();
}

function removeFromCart(index){
  cart.splice(index,1);
  updateCartUI();
}

/* --------- CART MODAL --------- */
const cartModal = document.getElementById("cartModal");
const openCartBtn = document.getElementById("openCartBtn");
openCartBtn.addEventListener("click", ()=> {
  if(cart.length === 0){ toast("Cart is empty", "info"); return; }
  cartModal.classList.add("open"); cartModal.setAttribute("aria-hidden","false");
  updateCartUI();
});
function closeCart(){ cartModal.classList.remove("open"); cartModal.setAttribute("aria-hidden","true"); }

/* --------- WALLET / CONNECT --------- */
async function connectWallet(){
  if(!window.ethereum){ toast("MetaMask (or compatible) not found", "error"); return; }
  try{
    // Request accounts
    const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
    userAddress = accounts[0];
    web3instance = new Web3(window.ethereum);
    toast("Wallet connected", "success");
    document.getElementById("profileButton").style.display = "inline-block";
    document.getElementById("profileWallet").innerText = userAddress;
  }catch(err){
    console.error(err);
    toast("Wallet connection failed", "error");
  }
}
document.getElementById("connectWallet").addEventListener("click", connectWallet);

function disconnectWallet(){
  userAddress = null;
  web3instance = null;
  document.getElementById("profileButton").style.display = "none";
  document.getElementById("profileSection").style.display = "none";
  toast("Wallet disconnected", "info");
}

/* --------- SWITCH CHAIN HELPER --------- */
async function ensureBaseNetwork(){
  if(!window.ethereum) throw new Error("No wallet");
  try{
    const currentChain = await ethereum.request({ method: "eth_chainId" });
    if(currentChain === BASE_CHAIN_ID_HEX) return true;
    // attempt to switch
    await ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: BASE_CHAIN_ID_HEX }] });
    return true;
  }catch(err){
    // ask user to switch manually if wallet doesn't support programmatic switch
    throw new Error("Please switch your wallet to Base (chainId 8453) and try again.");
  }
}

/* --------- CHECKOUT (MetaMask sendTx + log) --------- */
async function checkout(){
  if(!userAddress) { toast("Connect wallet first", "warn"); return; }
  if(cart.length === 0) { toast("Cart is empty", "info"); return; }

  try{
    // ensure Base network
    await ensureBaseNetwork();

    // calculate total
    const totalEth = cart.reduce((s,i)=>s + (i.price * i.q), 0);
    const valueHex = weiHexFromEth(totalEth);

    // build tx object
    const txParams = {
      from: userAddress,
      to: SHOP_WALLET,
      value: valueHex
    };

    toast("Sending transaction... confirm in your wallet", "info", 6000);
    const txHash = await ethereum.request({ method: "eth_sendTransaction", params: [txParams] });
    toast("Transaction sent: " + txHash, "success", 4000);

    // After tx sent, log each cart item to your Purchase sheet (POST)
    for(const ci of cart){
      const body = {
        wallet: userAddress,
        itemName: ci.title,
        color: ci.color,
        size: ci.size,
        quantity: ci.q,
        price: (ci.price * ci.q) // ETH amount for this line
      };
      try{
        await fetch(PURCHASE_API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
      }catch(postErr){
        console.error("Logging failed for", body, postErr);
      }
    }

    // clear cart and UI
    cart = [];
    updateCartUI();
    closeCart();
    toast("Purchase logged. Thank you!", "success");

  }catch(err){
    console.error(err);
    toast(err.message || "Checkout failed", "error");
  }
}

document.getElementById("checkoutBtn").addEventListener("click", checkout);

/* --------- INIT --------- */
function init(){
  renderItems();
  // show default tees
  showCategory("tees");
}
init();

</script>
</body>
</html>
