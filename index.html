<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shop with Cart & Profile</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
    }
    header {
      background: #333;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header .actions {
      display: flex;
      gap: 10px;
    }
    button {
      cursor: pointer;
      background: #555;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
    }
    .popup {
      position: fixed;
      top: 0;
      right: -400px; /* hidden off-screen */
      width: 350px;
      height: 100%;
      background: white;
      box-shadow: -2px 0 8px rgba(0,0,0,0.2);
      padding: 20px;
      overflow-y: auto;
      transition: right 0.3s ease;
      z-index: 1000;
    }
    .popup.open {
      right: 0;
    }
    .popup h2 {
      margin-top: 0;
    }
    .close-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      float: right;
      cursor: pointer;
    }
    .cart-items, .profile-content {
      margin-top: 20px;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Quacker Friends Shop</h1>
    <div class="actions">
      <button id="profileBtn">Profile</button>
      <button id="cartBtn">Cart (<span id="cartCount">0</span>)</button>
    </div>
  </header>

  <main style="padding:20px;">
    <h2>Items</h2>
    <div>
      <button onclick="addToCart('Duck Plush', 20)">Add Duck Plush - $20</button>
      <button onclick="addToCart('Keychain', 5)">Add Keychain - $5</button>
      <button onclick="addToCart('Sticker Pack', 3)">Add Sticker Pack - $3</button>
    </div>
  </main>

  <!-- Cart Popup -->
  <div id="cartPopup" class="popup">
    <button class="close-btn" onclick="closePopup('cartPopup')">X</button>
    <h2>Your Cart</h2>
    <div id="cartItems" class="cart-items"></div>
    <p><strong>Total: $<span id="cartTotal">0</span></strong></p>
    <input id="walletInput" placeholder="Enter wallet address" style="width:100%; margin-bottom:10px;">
    <input id="addressInput" placeholder="Enter shipping address" style="width:100%; margin-bottom:10px;">
    <button onclick="checkout()">Checkout</button>
  </div>

  <!-- Profile Popup -->
  <div id="profilePopup" class="popup">
    <button class="close-btn" onclick="closePopup('profilePopup')">X</button>
    <h2>Your Profile</h2>
    <div class="profile-content">
      <p><strong>Wallet:</strong> <span id="profileWallet">Not connected</span></p>
      <p><strong>Claim Status:</strong> <span id="claimStatus">Checking...</span></p>
    </div>
  </div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbzu2RjvJf8-SyRIekMh53JODYZxoPXQpjJ2aGTqIHd93HgEZpnXcVC_zxoJbJt51zqSuQ/exec";

    let cart = [];

    function addToCart(item, price) {
      cart.push({ item, price });
      updateCartUI();
    }

    function updateCartUI() {
      document.getElementById('cartCount').innerText = cart.length;
      const cartItemsDiv = document.getElementById('cartItems');
      cartItemsDiv.innerHTML = "";
      let total = 0;
      cart.forEach((c, i) => {
        total += c.price;
        cartItemsDiv.innerHTML += `
          <div class="cart-item">
            <span>${c.item} - $${c.price}</span>
            <button onclick="removeFromCart(${i})">Remove</button>
          </div>`;
      });
      document.getElementById('cartTotal').innerText = total;
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartUI();
    }

    function checkout() {
      const wallet = document.getElementById('walletInput').value;
      const address = document.getElementById('addressInput').value;
      if (!wallet || !address || cart.length === 0) {
        alert("Please fill wallet, address, and have at least 1 item.");
        return;
      }
      const items = cart.map(c => c.item).join(", ");
      const total = cart.reduce((sum, c) => sum + c.price, 0);
      fetch(`${scriptUrl}?wallet=${encodeURIComponent(wallet)}&address=${encodeURIComponent(address)}&item=${encodeURIComponent(items)}&price=${encodeURIComponent(total)}`)
        .then(res => res.text())
        .then(data => {
          alert("Checkout success: " + data);
          cart = [];
          updateCartUI();
          closePopup('cartPopup');
        })
        .catch(err => alert("Error: " + err));
    }

    // Popup controls
    const cartPopup = document.getElementById('cartPopup');
    const profilePopup = document.getElementById('profilePopup');

    document.getElementById('cartBtn').onclick = () => {
      profilePopup.classList.remove('open');
      cartPopup.classList.toggle('open');
    };
    document.getElementById('profileBtn').onclick = () => {
      cartPopup.classList.remove('open');
      profilePopup.classList.toggle('open');
      loadProfile();
    };

    function closePopup(id) {
      document.getElementById(id).classList.remove('open');
    }

    // Load Profile info
    function loadProfile() {
      const wallet = document.getElementById('walletInput').value || "Not connected";
      document.getElementById('profileWallet').innerText = wallet;
      if (wallet && wallet !== "Not connected") {
        fetch(`${scriptUrl}?wallet=${encodeURIComponent(wallet)}&checkClaim=true`)
          .then(res => res.json())
          .then(data => {
            document.getElementById('claimStatus').innerText = data.claimed ? "Already claimed" : "Not claimed";
          })
          .catch(() => {
            document.getElementById('claimStatus').innerText = "Error checking";
          });
      } else {
        document.getElementById('claimStatus').innerText = "No wallet";
      }
    }
  </script>
</body>
</html>
