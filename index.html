<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quacker Friends Crochet Shop</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ... your existing styles ... */
  </style>
</head>
<body>
  <div class="container">
    <h1>üß∂ Quacker Friends Crochet Shop</h1>

    <div id="wallet-section">
      <button id="connect-button">Connect Wallet</button>
      <button id="switch-button" style="display:none;">Switch Wallet</button>
      <button id="disconnect-button" style="display:none;">Disconnect</button>
      <p id="wallet-address"></p>
    </div>

    <button id="profile-button" onclick="toggleProfile()" style="display:none;">User Profile</button>

    <div id="profile-modal" style="display:none;">
      <!-- modal content dynamically inserted by toggleProfile() -->
    </div>

    <div id="shop" style="display: none;">
      <h2>üõçÔ∏è Shop Items</h2>
      <div class="item">
        <h3>üß¢ Quacker Friends Tee</h3>
        <p id="tee-price">Price: $25.00</p>
        <button onclick="buyTee()">Buy Now</button>
      </div>
      <div class="item">
        <h3>ü™° Tapestry</h3>
        <p id="tapestry-price">Price: 0 ETH</p>
        <button id="discount-button" onclick="claimDiscount()" style="display:none;">Claim 50% Off</button>
        <button onclick="buyTapestry()">Buy Now</button>
        <div id="shipping-form" style="display:none; margin-top:10px;">
          <textarea id="shipping-address-tapestry" placeholder="Enter your shipping address..." rows="3" cols="30"></textarea><br/>
          <button onclick="submitPurchase()">Submit Purchase</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // Globals to track user state
    let userNftCount = 0;
    let userAddressGlobal = null;
    let userHasClaimed = false;

    // Your contract setup and provider setup here
    // Example placeholders:
    // const provider = new ethers.providers.Web3Provider(window.ethereum);
    // const contract = new ethers.Contract(contractAddress, abi, provider);

    async function checkEligibility(wallet) {
      // Example call, replace with your contract call:
      // const balance = await contract.balanceOf(wallet);
      // userNftCount = parseInt(balance.toString());

      // For demo, let's assume a fake function:
      userNftCount = await getFakeNftBalance(wallet); // replace with real call

      if (userNftCount >= 10) {
        document.getElementById("discount-button").style.display = "inline";
      } else {
        document.getElementById("discount-button").style.display = "none";
      }

      if (userNftCount >= 1) {
        document.getElementById("profile-button").style.display = "inline";
      } else {
        document.getElementById("profile-button").style.display = "none";
        document.getElementById("profile-modal").style.display = "none"; // hide modal if open
      }

      // Check if user already claimed keychain
      userHasClaimed = await hasClaimedKeychain(); // implement accordingly
    }

    async function toggleProfile() {
      const modal = document.getElementById("profile-modal");

      if (modal.style.display === "block") {
        modal.style.display = "none";
        return;
      }

      let claimSection = "";
      if (userNftCount >= 1 && !userHasClaimed) {
        claimSection = `
          <div id="keychain-section">
            <p>You‚Äôre eligible for a free Quacker Keychain!</p>
            <textarea id="shipping-address" placeholder="Enter your shipping address here..." rows="3"></textarea>
            <button onclick="submitClaim()">Claim Free Keychain</button>
          </div>
        `;
      } else if (userHasClaimed) {
        claimSection = `
          <div id="claimed-section">
            <p>‚úÖ You've already claimed your free keychain!</p>
          </div>
        `;
      } else {
        claimSection = `<p>You need to own at least 1 Quacker NFT to claim a keychain.</p>`;
      }

      modal.innerHTML = `
        <h3>Your Profile</h3>
        <p><strong>Wallet:</strong> ${userAddressGlobal || "Not connected"}</p>
        <p><strong>Quacker NFTs Owned:</strong> ${userNftCount}</p>
        <p><strong>Keychain Claimed:</strong> ${userHasClaimed ? "Yes" : "No"}</p>
        ${claimSection}
        <button onclick="toggleProfile()">Close</button>
      `;

      modal.style.display = "block";
    }

    async function submitClaim() {
      const address = document.getElementById("shipping-address").value.trim();
      if (!address) {
        alert("Please enter a shipping address.");
        return;
      }

      // Call your claim backend function here, e.g., via fetch or ethers.js
      // After successful claim:
      alert("Claim submitted! Thank you.");
      userHasClaimed = true;
      toggleProfile();
    }

    // Placeholder for testing
    async function getFakeNftBalance(wallet) {
      // simulate call: wallet ending with 1 gets 5 NFTs, else 0
      return wallet && wallet.endsWith("1") ? 5 : 0;
    }

    async function hasClaimedKeychain() {
      // replace with your real check via backend API or contract call
      return false;
    }

    // Example wallet connection listener, call checkEligibility after connect
    async function onWalletConnected(wallet) {
      userAddressGlobal = wallet;
      await checkEligibility(wallet);
    }

    // Your wallet.js and shop.js should call onWalletConnected(wallet) after connection
  </script>

  <script src="wallet.js"></script>
  <script src="shop.js"></script>
</body>
</html>
