
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quacker Friends Shop</title>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <style>

    #itemModal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 2000;
  background: var(--card);
  border-radius: 16px;
  box-shadow: var(--shadow);
  padding: 20px;
}


    :root{
      --brand-orange:#ff914d;
      --brand-orange-dark:#ff7b2c;
      --brand-teal:#66c7c4;
      --card:#ffffff;
      --shadow:0 8px 20px rgba(12,12,20,0.06);
      --radius:14px;
      --maxWidth:1100px;
    }
    *{box-sizing:border-box}
   body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 0;
  background: url('https://files.catbox.moe/n3gp1o.png') no-repeat center center fixed;
  background-size: cover;
  color: #222;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

    .dropdown-item {
  padding: 10px 16px;
  border: none;
  background: transparent;
  text-align: left;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.15s;
  color: #222;
  border-radius: 8px;
}
.dropdown-item:hover { background: var(--brand-orange); color: #fff; }
    .item .size-guide-btn {
  color: #222;               /* dark text */
  background: #f6f6f6;       /* light gray background */
  border: 1px solid #ccc;    /* subtle border */
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 12px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 4px;                  /* space between icon and text */
  transition: background 0.2s;
}

.item .size-guide-btn:hover {
  background: #e0e0e0;       /* slightly darker on hover */
}


    header{display:flex;justify-content:space-between;align-items:center;padding:14px 24px;background:var(--brand-orange);color:white;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    header h1{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
    .btn{padding:10px 16px;background:var(--brand-orange-dark);color:white;border:none;border-radius:999px;cursor:pointer;font-weight:600;transition:all .18s;display:inline-flex;gap:8px;align-items:center}
    .btn.secondary{background:transparent;color:white;border:1px solid rgba(255,255,255,.25);padding:8px 12px;border-radius:10px}
    main{flex:1;padding:30px 20px;max-width:var(--maxWidth);margin:0 auto 80px}
    .shop-controls{display:flex;gap:12px;align-items:center}
    .shop-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:22px}
    .item{background:var(--card);padding:16px;border-radius:14px;box-shadow:var(--shadow);text-align:center}
    .item img{width:100%;height:220px;object-fit:contain;border-radius:8px;background:#f6f6f6}
    .item h3{margin:10px 0 6px;font-size:16px}
    .price{font-weight:700;color:var(--brand-orange-dark);margin-bottom:8px}
    select{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px}
    #profileSection{display:none;position:absolute;top:70px;right:30px;background:var(--card);border-radius:12px;width:340px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:100}
    #profileSection h3{margin-top:0;font-size:16px;border-bottom:1px solid #eee;padding-bottom:8px;margin-bottom:12px}
    #toast-container{position:fixed;top:12px;right:12px;z-index:20000;display:flex;flex-direction:column;gap:8px}
    .toast{padding:8px 12px;border-radius:8px;color:#fff;display:flex;gap:8px;align-items:center}
    .toast.info{background:#2563eb}.toast.success{background:#059669}.toast.error{background:#ef4444}
    .cart-count{background:#111;color:#fff;border-radius:999px;padding:4px 7px;font-size:12px;position:relative;left:-6px;top:-6px}
    /* cart modal */
    .cart-modal{position:fixed;right:0;top:0;height:100vh;width:420px;background:var(--card);box-shadow:-12px 0 40px rgba(0,0,0,0.12);transform:translateX(110%);transition:transform .28s ease;z-index:1200;padding:18px;display:flex;flex-direction:column}
    .cart-modal.open{transform:translateX(0)}
    .cart-modal .close-x{position:absolute;right:12px;top:8px;background:transparent;border:none;font-size:20px;cursor:pointer}
    .cart-list{flex:1;overflow:auto;margin-bottom:12px}
    .cart-item{display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid #f1f1f1}
    .cart-item img{width:64px;height:64px;object-fit:contain;border-radius:6px;background:#f6f6f6}
    .sizeguide-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1300;background:rgba(0,0,0,0.5)}
    .sizeguide-modal.open{display:flex}
    .sizeguide-modal .card{background:#fff;padding:12px;border-radius:12px;max-width:720px;width:92%;position:relative}
    .sizeguide-modal img{max-width:100%;height:auto;display:block;border-radius:8px}
    .sizeguide-modal .close-btn{position:absolute;right:12px;top:12px;background:transparent;border:none;font-size:20px;cursor:pointer}
    footer{background:var(--brand-teal);padding:10px 0;text-align:center;color:#fff;margin-top:auto}
    footer a{margin:0 10px;color:#fff}


    @media(max-width:520px){#profileSection{right:12px;left:12px;width:auto}.cart-modal{width:100%}}
  


/* Ensure header/footer stay crisp above blur */
header { position: relative; z-index: 1100; }
footer { position: relative; z-index: 1100; padding: 10px 0; font-size: 14px; }

/* Toasts slightly lower */
#toast-container {
  position: fixed;
  top: 110px;
  right: 12px;
  z-index: 20000;
  display: flex;
  flex-direction: column;
  gap: 8px;
}


/* Profile buttons visible */
#profileSection .btn.secondary {
  background: #fff;
  color: #222;
  border: 1px solid #ddd;
}

/* Modal overlay sits above blur */
#modalOverlay { z-index: 1999; }
    
#profileSection {
  position: absolute;
  top: 60px;
  right: 20px;
  z-index: 3000; /* higher than header */
}
 /* Background image as its own layer */
body {
  position: relative;
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 0;
  color: #222;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}

/* Background image pseudo-element */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: url('https://files.catbox.moe/n3gp1o.png') no-repeat center center fixed;
  background-size: cover;
  z-index: -1; /* behind everything */
  transition: filter 0.4s ease;
}

/* Blur only the background layer when browsing items */
body.blur-bg::before {
  filter: blur(6px) brightness(0.7);
}


/* Keep header/footer above the blurred background */
header, footer {
  position: relative;
  z-index: 10;
  backdrop-filter: none;
}



  </style>
</head>


<body>
  


  <div id="shippingNotice" style="
    background: #ffcc00;
    color: #222;
    text-align: center;
    padding: 8px 0;
    font-weight: 600;
    font-size: 14px;
">
  ‚ö†Ô∏è Note: Shipping is only available in the US and Canada.
</div>
  <header>
    <div id="modalOverlay"></div>

    <h1> Quacker Friends Shop</h1>
    <div style="display:flex;gap:10px;align-items:center">
    <div class="shop-controls" style="position:relative">
  <button class="btn secondary" id="menuBtn">Shop ‚ñæ</button>
  <div id="shopMenu" style="
      display:none;
      position:absolute;
      top:100%;
      left:0;
      background:var(--card);
      border-radius:12px;
      box-shadow:var(--shadow);
      flex-direction:column;
      min-width:160px;
      z-index:1500;
  ">
    <button class="dropdown-item" onclick="showCategory('tees')">Tees</button>
    <button class="dropdown-item" onclick="showCategory('plushies')">Plushies</button>
    <button class="dropdown-item" onclick="showCategory('tapestry')">Tapestry</button>
  </div>
</div>

      <button id="connectBtn" class="btn">Connect Wallet</button>
      <button id="profileBtn" class="btn secondary" style="display:none">Profile</button>
      <button id="openCartBtn" class="btn" style="position:relative">Cart <span id="cartCount" class="cart-count" style="display:none">0</span></button>
    </div>
  </header>

  <div id="toast-container"></div>

  <!-- Profile Panel -->
  <div id="profileSection" aria-hidden="true">
    <h3>User Profile</h3>
    <p id="walletAddr" style="font-size:13px;color:#333">Not connected</p>
    <p id="nftCount">NFTs Owned: ...</p>
    <p id="quacksCount">Daily Quacks: 0</p>
    <div style="margin-top:10px">
      <button id="claimQuacksBtn" class="btn">ü¶Ü Collect Daily Quacks</button>
    </div>
    <hr>
    <button class="btn secondary" onclick="switchWallet()">üîÑ Switch Wallet</button>
    <button class="btn secondary" onclick="disconnectWallet()">‚ùå Disconnect</button>
  </div>

  <main style="max-width:var(--maxWidth);margin:20px auto;padding:0 16px;width:100%">
   

   
    <section id="items" class="shop-container"></section>
  </main>

  <!-- Cart Modal -->
  <div id="cartModal" class="cart-modal" aria-hidden="true">
    <button class="close-x" title="Close cart" onclick="closeCart()">‚úï</button>
    <h3>Your Cart</h3>
    <div style="font-size:13px;color:#c0392b;margin-bottom:8px;">
  Shipping only available in the US and Canada
</div>
    <div class="cart-list" id="cartList"></div>

    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Total</strong>
        <strong id="cartTotal">0 ETH</strong>
      </div>
      <div style="margin-top:8px">
        <button id="checkoutBtn" class="btn" style="width:100%">Checkout (Pay in Base)</button>
      </div>
      <div style="margin-top:8px;font-size:12px;color:#666;text-align:center">
  Network: Base Mainnet <br>

</div>

    </div>
  </div>

  <!-- Size guide modal -->
  <div id="sizeGuideModal" class="sizeguide-modal" aria-hidden="true">
    <div class="card">
      <button class="close-btn" onclick="closeSizeGuide()">‚úï</button>
      <img id="sizeGuideImage" src="" alt="Size guide" />
    </div>
  </div>

  <footer>
    <p>Follow Quacker Friends:</p>
    <a href="https://x.com/" target="_blank"><i class="fab fa-x fa-lg"></i></a>
    <a href="https://www.tiktok.com/" target="_blank"><i class="fab fa-tiktok fa-lg"></i></a>
    <a href="https://www.instagram.com/" target="_blank"><i class="fab fa-instagram fa-lg"></i></a>
  </footer>

<script>
/* ===== CONFIG ===== */
const PURCHASE_API = "https://script.google.com/macros/s/AKfycbwZMlGQ2REZxTP1lIoWBYzc8n7l-h7C79F9u9MjDY4XIR6jKNO7ky1VXtCm3oP5RM_9qA/exec";
const CLAIM_SHEET_API = "https://script.google.com/macros/s/AKfycbzu2RjvJf8-SyRIekMh53JODYZxoPXQpjJ2aGTqIHd93HgEZpnXcVC_zxoJbJt51zqSuQ/exec";
const CONTRACT_ADDRESS = "0xa2c82bda5585c1d729e2b4f85dcc9a11ded7db4c";
const CONTRACT_ABI = [{"constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}];
const SHOP_WALLET = "0x38aF7644b120B56e2FEce98b8A9A3DE14F8Fbf1D";
const BASE_CHAIN_ID_HEX = "0x2105"; // 8453

/* ===== PRODUCTS (tees only for now) =====
   Each product has images: Black and White. Prices set to 0 (testing) */
const PRODUCTS = {
  tees: [
    {
      id: "battle",
      title: "Battle Duck Tee",
      price: 0,
      images: { Black: "https://files.catbox.moe/dw04zw.png", White: "https://files.catbox.moe/d6zm2s.png" },
      sizes: ["S","M","L","XL"],
      sizeGuide: "https://files.catbox.moe/41dvss.png"
    },
    {
      id: "higher",
      title: "Higher Duck Tee",
      price: 0,
      images: { Black: "https://files.catbox.moe/qi081o.png", White: "https://files.catbox.moe/0gn3r2.png" },
      sizes: ["S","M","L","XL"],
      sizeGuide: "https://files.catbox.moe/41dvss.png"
    },
    {
      id: "sus",
      title: "Sus Duck Tee",
      price: 0,
      images: { Black: "https://files.catbox.moe/zqtvvw.png", White: "https://files.catbox.moe/mgu7nu.png" },
      sizes: ["S","M","L","XL"],
      sizeGuide: "https://files.catbox.moe/41dvss.png"
    },
    {
      id: "thisisfine",
      title: "This Is Fine Tee",
      price: 0,
      images: { Black: "https://files.catbox.moe/nbl7st.png", White: "https://files.catbox.moe/5n618u.png" },
      sizes: ["S","M","L","XL"],
      sizeGuide: "https://files.catbox.moe/41dvss.png"
    }
  ],
  plushies: [],
  tapestry: []
};

/* ===== STATE ===== */
let userAddress = null;
let web3 = null;
let cart = [];
let currentCategory = "tees";

/* ===== UI Helpers ===== */
function showToast(message, type="info", duration=3000){
  const container = document.getElementById("toast-container");
  const el = document.createElement("div");
  el.className = "toast " + (type==="success"?"success":type==="error"?"error":"info");
  el.innerHTML = `<span>${message}</span>`;
  container.appendChild(el);
  setTimeout(()=>el.remove(), duration);
}

/* ===== RENDER ITEMS ===== */
function showCategory(cat) {
  currentCategory = cat;
  const items = document.querySelectorAll('.item-grid');
  items.forEach(i => i.style.display = 'none');

  const selected = document.getElementById(cat + '-grid');
  if (selected) {
    selected.style.display = 'grid';
    document.body.classList.add("blur-bg"); // keep blur ON while viewing
  } else {
    document.body.classList.remove("blur-bg"); // only remove blur if none selected
  }
}



  container.innerHTML = "";
  if (items.length === 0) {
    container.innerHTML = `<div style="background:var(--card);padding:20px;border-radius:12px;box-shadow:var(--shadow);">No items yet in ${cat}.</div>`;
    return;
  }

  items.forEach(p => {
    const el = document.createElement("div");
    el.className = "item";
    const imgId = `img_${p.id}`;
    const colorId = `color_${p.id}`;
    const sizeId = `size_${p.id}`;

    el.innerHTML = `
      <img id="${imgId}" src="${p.images.Black}" alt="${p.title}" />
      <h3>${p.title}</h3>
      <div class="price">${p.price.toFixed(4)} ETH</div>
      <label style="display:block;text-align:left;font-weight:600">Color</label>
      <select id="${colorId}">
        ${Object.keys(p.images).map(c => `<option value="${c}">${c}</option>`).join("")}
      </select>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <label style="font-weight:600">Size</label>
        <button class="btn size-guide-btn" onclick="openSizeGuide('${p.sizeGuide}')">üìù Size Guide</button>
      </div>
      <select id="${sizeId}" style="margin-top:6px">
        ${p.sizes.map(s => `<option value="${s}">${s}</option>`).join("")}
      </select>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button class="btn" onclick="addToCart('${p.id}')">Add to cart</button>
      </div>
    `;
    container.appendChild(el);

    // Update image on color change
    const colorSelect = el.querySelector(`#${colorId}`);
    colorSelect.addEventListener("change", (e) => {
      el.querySelector(`#${imgId}`).src = p.images[e.target.value];
    });
  });
}


  function openItemModal(id) {
  document.getElementById('modalOverlay').style.display = 'block';
  document.getElementById('itemModal').style.display = 'block';
}

function closeItemModal() {
  document.getElementById('modalOverlay').style.display = 'none';
  document.getElementById('itemModal').style.display = 'none';
}

/* ===== SIZE GUIDE POPUP ===== */
function openSizeGuide(url){
  document.getElementById("sizeGuideImage").src = url;
  const modal = document.getElementById("sizeGuideModal");
  modal.classList.add("open");
  modal.setAttribute("aria-hidden","false");
}
function closeSizeGuide(){
  const modal = document.getElementById("sizeGuideModal");
  modal.classList.remove("open");
  modal.setAttribute("aria-hidden","true");
}

/* ===== CART ===== */
function addToCart(prodId){
  const product = (PRODUCTS[currentCategory]||[]).find(p=>p.id===prodId);
  if(!product){ showToast("Product not found","error"); return; }
  const color = document.getElementById(`color_${prodId}`).value;
  const size = document.getElementById(`size_${prodId}`).value;
  cart.push({ id: product.id, title: product.title, price: product.price, color, size, q:1 });
  updateCartUI();
  showToast(`${product.title} (${color}, ${size}) added to cart`,"success");
}

function updateCartUI(){
  const countEl = document.getElementById("cartCount");
  const listEl = document.getElementById("cartList");
  const totalEl = document.getElementById("cartTotal");
  const cartCount = cart.reduce((s,i)=>s+i.q,0);
  if(cartCount>0){ countEl.style.display="inline-block"; countEl.innerText = cartCount; } else countEl.style.display="none";

  if(cart.length===0){ listEl.innerHTML = "<p style='color:#666'>Cart is empty</p>"; totalEl.innerText = "0 ETH"; return; }

  listEl.innerHTML = "";
  let total = 0;
  cart.forEach((ci, idx)=>{
    const row = document.createElement("div");
    row.className = "cart-item";
    row.innerHTML = `
      <img src="${(PRODUCTS[currentCategory].find(p=>p.id===ci.id)||{}).images?.Black || ''}" alt="${ci.title}" />
      <div style="flex:1">
        <div style="font-weight:700">${ci.title}</div>
        <div style="font-size:13px;color:#666">${ci.color} ‚Ä¢ ${ci.size}</div>
        <div style="margin-top:6px">${ci.price.toFixed(6)} ETH</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px">
        <input class="qty" type="number" min="1" value="${ci.q}" onchange="changeQty(${idx}, this.value)" style="width:56px;padding:6px;border-radius:6px;border:1px solid #ddd;text-align:center" />
        <button style="background:transparent;border:none;color:#e11;cursor:pointer" onclick="removeFromCart(${idx})">Remove</button>
      </div>
    `;
    listEl.appendChild(row);
    total += ci.price * ci.q;
  });
  totalEl.innerText = total.toFixed(6) + " ETH";
}

function changeQty(index, val){
  const v = Number(val) || 1;
  cart[index].q = Math.max(1, v);
  updateCartUI();
}
function removeFromCart(index){
  cart.splice(index,1);
  updateCartUI();
}

/* ===== CART MODAL UI ===== */
const cartModal = document.getElementById("cartModal");
document.getElementById("openCartBtn").addEventListener("click", ()=> {
  if(cart.length === 0){ showToast("Cart is empty", "info"); return; }
  cartModal.classList.add("open"); cartModal.setAttribute("aria-hidden","false");
  updateCartUI();
});
function closeCart(){ cartModal.classList.remove("open"); cartModal.setAttribute("aria-hidden","true"); }

/* ===== WALLET & PROFILE ===== */
async function connectWallet(){
  if(!window.ethereum){ showToast("MetaMask not found","error"); return; }
  try{
    web3 = new Web3(window.ethereum);
    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
    userAddress = accounts[0];
    document.getElementById("connectBtn").innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
    document.getElementById("profileBtn").style.display = "inline-block";
    document.getElementById("walletAddr").innerText = userAddress;
    showToast("Wallet connected","success");
  }catch(err){
    console.error(err);
    showToast("Connect failed","error");
  }
}
document.getElementById("connectBtn").addEventListener("click", connectWallet);

document.getElementById("profileBtn").addEventListener("click", async ()=>{
  const panel = document.getElementById("profileSection");
  panel.style.display = panel.style.display === "block" ? "none" : "block";
  if(!userAddress) return;

  try{
    const contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
    const balance = await contract.methods.balanceOf(userAddress).call();
    document.getElementById("nftCount").innerText = "NFTs Owned: " + balance;

    // fetch quacks
    const res = await fetch(`${CLAIM_SHEET_API}?wallet=${encodeURIComponent(userAddress)}`);
    const data = await res.json();
    const userRow = Array.isArray(data) ? data.find(r => (r.address||"").toLowerCase() === userAddress.toLowerCase()) : null;
    document.getElementById("quacksCount").innerText = "Daily Quacks: " + (userRow ? userRow.quacks_collected : 0);
  }catch(err){
    console.error(err);
    showToast("Error loading profile","warn");
  }
});

async function switchWallet(){
  try{
    await ethereum.request({ method: "wallet_requestPermissions", params: [{ eth_accounts: {} }] });
    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
    userAddress = accounts[0];
    document.getElementById("walletAddr").innerText = userAddress;
    showToast("Wallet switched","success");
  }catch(err){ console.error(err); }
}

function disconnectWallet(){
  userAddress = null;
  web3 = null;
  document.getElementById("connectBtn").innerText = "Connect Wallet";
  document.getElementById("profileBtn").style.display = "none";
  document.getElementById("profileSection").style.display = "none";
  showToast("Wallet disconnected","info");
}

/* ===== CLAIM QUACKS LOGIC (uses user's working code) ===== */
document.getElementById("claimQuacksBtn").addEventListener("click", async ()=>{
  if(!userAddress){ showToast("Connect wallet first","warn"); return; }

  try{
    const contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
    const balance = await contract.methods.balanceOf(userAddress).call();
    const quacksToAdd = Number(balance) > 0 ? 10 : 2;

    const res = await fetch(`${CLAIM_SHEET_API}?wallet=${encodeURIComponent(userAddress)}&claim=true&quacks=${quacksToAdd}`);
    const data = await res.json();

    if(data.error){
      showToast(data.error, "warn");
    } else {
      showToast(`ü¶Ü Claimed ${quacksToAdd} Quacks!`, "success");
      // update displayed quacks
      const userRow = Array.isArray(data) ? data.find(r => (r.address||"").toLowerCase() === userAddress.toLowerCase()) : null;
      document.getElementById("quacksCount").innerText = "Daily Quacks: " + (data.new_quacks_total || (userRow ? userRow.quacks_collected : 0));
    }
  }catch(err){
    console.error(err);
    showToast("Error claiming quacks","error");
  }
});

/* ===== CHECKOUT / PURCHASE LOGGING ===== */
document.getElementById("checkoutBtn").addEventListener("click", checkout);

async function checkout(){
  try{
    if(!window.ethereum){ showToast("MetaMask not found","error"); return; }
    if(!userAddress){ showToast("Connect wallet first","error"); return; }
    if(cart.length === 0){ showToast("Cart is empty","info"); return; }

    // ensure base network (best-effort)
    try{
      const chain = await ethereum.request({ method: 'eth_chainId' });
      if(chain !== BASE_CHAIN_ID_HEX){
        await ethereum.request({ method: 'wallet_switchEthereumChain', params:[{chainId: BASE_CHAIN_ID_HEX}] });
        showToast("Switched to Base mainnet","success");
      }
    }catch(switchErr){
      // user may need to switch manually; warn but continue to let them sign
      console.warn("Chain switch issue:", switchErr);
    }

    // compute total
    const totalEth = cart.reduce((s,i)=>s + (Number(i.price) * i.q), 0);
    // convert to hex wei
    const valueHex = totalEth > 0 ? "0x" + BigInt(Math.floor(totalEth * 1e18)).toString(16) : "0x0";

    const txParams = { from: userAddress, to: SHOP_WALLET, value: valueHex };

    showToast("Please confirm the transaction in your wallet...", "info", 8000);

    // send tx (will throw if rejected)
    let txHash;
    try{
      txHash = await ethereum.request({ method: "eth_sendTransaction", params: [txParams] });
    }catch(txErr){
      console.warn("tx aborted", txErr);
      showToast("Transaction cancelled or failed ‚Äî purchase not logged", "error");
      return; // do not log if tx was not sent
    }

    // At this point txHash is returned (transaction propagated). Show BaseScan link and log.
    showToast("Transaction sent ‚Äî logging purchase...", "success", 4000);

    // small delay to let tx propagate
    await new Promise(r => setTimeout(r, 1200));

    // show clickable BaseScan toast
    const baseScanUrl = `https://basescan.org/tx/${txHash}`;
    const linkToast = document.createElement("div");
    linkToast.className = "toast success";
    linkToast.innerHTML = `‚úÖ Purchase sent ‚Äî <a href="${baseScanUrl}" target="_blank" style="color:#fff;text-decoration:underline">View on BaseScan</a>`;
    document.getElementById("toast-container").appendChild(linkToast);
    setTimeout(()=>linkToast.remove(), 8000);

    // Log purchases via GET to avoid CORS
    for(const ci of cart){
      const payload = {
        wallet: userAddress,
        itemName: ci.title,
        color: ci.color || "",
        size: ci.size || "",
        quantity: ci.q || 1,
        price: Number(ci.price || 0),
        txHash
      };
      const params = new URLSearchParams(payload).toString();
      try{
        const resp = await fetch(`${PURCHASE_API}?${params}`);
        // optional: inspect response
        // const json = await resp.json();
        // console.log("Purchase logged:", json);
      }catch(logErr){
        console.warn("Logging failed for item", payload, logErr);
      }
    }

    // Clear cart & UI
    cart = [];
    updateCartUI();
    closeCart();
    showToast("‚úÖ Purchase logged successfully!", "success", 4000);

  }catch(err){
    console.error("checkout error", err);
    showToast("Checkout failed", "error");
  }
}

/* ===== INIT ===== */
document.addEventListener("DOMContentLoaded", ()=>{
 // showCategory('tees'); //
  
});

  const menuBtn = document.getElementById('menuBtn');
const shopMenu = document.getElementById('shopMenu');

menuBtn.addEventListener('click', () => {
  shopMenu.style.display = shopMenu.style.display === "flex" ? "none" : "flex";
});

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
  if (!menuBtn.contains(e.target) && !shopMenu.contains(e.target)) {
    shopMenu.style.display = "none";
    document.body.classList.remove("blur-bg");

    document.getElementById("bgBlur").style.display = "none";
  }
});


  function openItemModal(id) {
  document.getElementById('modalOverlay').style.display = 'block';
  document.getElementById('itemModal').style.display = 'block';
}

function closeItemModal() {
  document.getElementById('modalOverlay').style.display = 'none';
  document.getElementById('itemModal').style.display = 'none';
}


</script>

</body>
</html>
