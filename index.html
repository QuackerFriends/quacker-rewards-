<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quacker Friends Shop — Test Mode (0 ETH)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:#f6f7fb; color:#111;}
    header{background:#ff914d;color:#fff;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
    .btn{background:#ff7b2c;color:#fff;border:none;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,.2);color:#fff;padding:8px 10px;border-radius:8px}
    .shop-container{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px}
    .item{background:#fff;padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(12,12,20,0.06);text-align:center}
    .item img{width:100%;height:220px;object-fit:contain;border-radius:8px;background:#f8f8f8}
    .price{color:#ff7b2c;font-weight:700;margin:8px 0}
    #cartModal{position:fixed;right:0;top:0;height:100vh;width:360px;background:#fff;box-shadow:-12px 0 40px rgba(0,0,0,0.12);transform:translateX(110%);transition:transform .28s;z-index:9999;padding:16px;display:flex;flex-direction:column}
    #cartModal.open{transform:translateX(0)}
    #cartList{flex:1;overflow:auto;margin-bottom:12px}
    .close-x{position:absolute;right:12px;top:10px;border:none;background:transparent;font-size:20px;cursor:pointer}
    #sizeGuideModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:10000}
    #sizeGuideModal.open{display:flex}
    .sizeCard{background:#fff;padding:12px;border-radius:12px;max-width:720px;width:92%}
    .sizeCard img{width:100%;height:auto;border-radius:8px}
    #profileSection{display:none;position:absolute;right:18px;top:64px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.12);width:300px}
    #toast-container{position:fixed;top:12px;right:12px;z-index:20000;display:flex;flex-direction:column;gap:8px}
    .toast{padding:8px 12px;border-radius:8px;color:#fff}
    .toast.info{background:#2563eb}.toast.success{background:#059669}.toast.error{background:#ef4444}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:16px">
      <h1 style="margin:0;font-size:18px">🦆 Quacker Friends Shop (Test)</h1>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <div style="position:relative">
        <button class="btn secondary" onclick="showCategory('tees')">Shop ▾</button>
      </div>
      <button id="openCartBtn" class="btn">Cart</button>
      <button id="connectBtn" class="btn" onclick="connectWallet()">Connect Wallet</button>
      <button id="profileBtn" class="btn secondary" onclick="toggleProfile()" style="display:none">Profile</button>
    </div>
  </header>

  <div id="toast-container"></div>

  <div id="profileSection" aria-hidden="true">
    <h3 style="margin:6px 0">User Profile</h3>
    <p id="profileWallet" style="font-size:13px;color:#333">Not connected</p>
    <p style="font-size:13px;color:#666">Daily Quacks: (disabled)</p>
    <div style="margin-top:10px"><button class="btn secondary" onclick="disconnectWallet()">Disconnect</button></div>
  </div>

  <main class="shop-container" id="shop"></main>

  <!-- cart modal -->
  <div id="cartModal" aria-hidden="true">
    <button class="close-x" onclick="closeCart()">✕</button>
    <h3 style="margin-top:6px">Your Cart</h3>
    <div id="cartList"></div>
    <div style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>Total</strong>
        <strong id="cartTotal">0 ETH</strong>
      </div>
      <button id="checkoutBtn" class="btn" style="width:100%" onclick="checkout()">Checkout (test mode)</button>
    </div>
  </div>

  <!-- size guide modal -->
  <div id="sizeGuideModal" role="dialog" aria-hidden="true">
    <div class="sizeCard">
      <button class="close-x" onclick="closeSizeGuide()">✕</button>
      <img id="sizeGuideImage" src="" alt="Size guide" />
    </div>
  </div>

<script>
const PURCHASE_API = "https://script.google.com/macros/s/AKfycbwZMlGQ2REZxTP1lIoWBYzc8n7l-h7C79F9u9MjDY4XIR6jKNO7ky1VXtCm3oP5RM_9qA/exec";
const SHOP_WALLET = "0x38aF7644b120B56e2FEce98b8A9A3DE14F8Fbf1D";
const BASE_CHAIN_ID_HEX = "0x2105";

let cart = [];
let userAddress = null;

const PRODUCTS = [
  { id:"battle-black", title:"Battle Duck Tee — Black", price:0, img:"https://files.catbox.moe/dw04zw.png", sizes:["S","M","L","XL"], sizeGuide:"https://files.catbox.moe/41dvss.png" },
  { id:"battle-white", title:"Battle Duck Tee — White", price:0, img:"https://files.catbox.moe/d6zm2s.png", sizes:["S","M","L","XL"], sizeGuide:"https://files.catbox.moe/41dvss.png" }
];

function showToast(msg, type="info", timeout=3000){
  const c=document.getElementById("toast-container");
  const e=document.createElement("div");
  e.className="toast "+(type==="success"?"success":type==="error"?"error":"info");
  e.innerText=msg;
  c.appendChild(e);
  setTimeout(()=>e.remove(),timeout);
}

function showCategory(cat){
  const shop=document.getElementById("shop");
  shop.innerHTML="";
  if(cat==="tees"){
    PRODUCTS.forEach(p=>{
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <img src="${p.img}" alt="${p.title}" />
        <h3 style="margin:8px 0">${p.title}</h3>
        <div class="price">${p.price.toFixed(4)} ETH</div>
        <select id="color_${p.id}" style="width:100%;padding:8px;border-radius:8px;margin:6px 0">
          <option>Black</option><option>White</option>
        </select>
        <select id="size_${p.id}" style="width:100%;padding:8px;border-radius:8px;margin-top:6px">
          ${p.sizes.map(s=>`<option>${s}</option>`).join("")}
        </select>
        <button class="btn" style="margin-top:10px" onclick="addToCart('${p.id}')">Add to cart</button>
      `;
      shop.appendChild(div);
    });
  }
}

function addToCart(id){
  const p=PRODUCTS.find(x=>x.id===id);
  const color=document.getElementById(`color_${id}`).value;
  const size=document.getElementById(`size_${id}`).value;
  cart.push({...p,color,size,q:1});
  showToast(`${p.title} added to cart`,"success");
  updateCartUI();
}

function updateCartUI(){
  const list=document.getElementById("cartList");
  if(cart.length===0){list.innerHTML="<p>Cart empty</p>";document.getElementById("cartTotal").innerText="0 ETH";return;}
  list.innerHTML=cart.map((c,i)=>`
    <div style="padding:8px;border-bottom:1px solid #eee">
      <div><b>${c.title}</b></div>
      <div>${c.color} • ${c.size}</div>
      <div>${c.price.toFixed(6)} ETH</div>
      <button style="background:transparent;color:#d33;border:none" onclick="removeFromCart(${i})">Remove</button>
    </div>`).join("");
  const total=cart.reduce((s,i)=>s+(i.price*i.q),0);
  document.getElementById("cartTotal").innerText=total.toFixed(6)+" ETH";
}
function removeFromCart(i){cart.splice(i,1);updateCartUI();}

document.getElementById("openCartBtn").addEventListener("click",()=>{
  if(cart.length===0){showToast("Cart empty","info");return;}
  document.getElementById("cartModal").classList.add("open");
});
function closeCart(){document.getElementById("cartModal").classList.remove("open");}

async function connectWallet(){
  if(!window.ethereum){showToast("MetaMask not found","error");return;}
  const accounts=await ethereum.request({method:"eth_requestAccounts"});
  userAddress=accounts[0];
  document.getElementById("connectBtn").innerText=userAddress.slice(0,6)+"..."+userAddress.slice(-4);
  showToast("Wallet connected","success");
}

async function checkout(){
  try{
    if(!window.ethereum){showToast("MetaMask not found","error");return;}
    if(!userAddress){showToast("Connect wallet first","error");return;}
    if(cart.length===0){showToast("Cart is empty","info");return;}

    let txHash="TEST_"+Date.now(); // default simulated tx for test mode

    try{
      const chain=await ethereum.request({method:"eth_chainId"});
      if(chain!==BASE_CHAIN_ID_HEX){
        await ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:BASE_CHAIN_ID_HEX}]});
      }
      const txParams={from:userAddress,to:SHOP_WALLET,value:"0x0"};
      showToast("Confirm (0 ETH) transaction in wallet...","info",6000);
      txHash=await ethereum.request({method:"eth_sendTransaction",params:[txParams]});
    }catch(txErr){
      console.warn("tx failed or rejected",txErr);
      showToast("No tx sent — logging anyway (test mode)","info");
    }

    // log purchase
    for(const ci of cart){
      const payload={wallet:userAddress,itemName:ci.title,color:ci.color,size:ci.size,quantity:ci.q,price:Number(ci.price||0),txHash};
    const res = await fetch(PURCHASE_API, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload),
});

let data;
try {
  // Try parsing JSON directly
  data = await res.json();
} catch {
  // If it’s HTML (CORS relay), extract JSON manually
  const text = await res.text();
  const match = text.match(/{.*}/s);
  data = match ? JSON.parse(match[0]) : { success: false, error: "Invalid response" };
}

if (data.success) {
  console.log("✅ Purchase logged:", data);
} else {
  console.warn("⚠️ Log failed:", data);
}

    }

    cart=[];
    updateCartUI();
    closeCart();
    showToast("Purchase logged! (tx: "+txHash+")","success",4000);
  }catch(err){
    console.error("checkout error",err);
    showToast("Checkout failed","error");
  }
}

document.addEventListener("DOMContentLoaded",()=>showCategory('tees'));
</script>
</body>
</html>
